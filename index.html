<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ohm-Vengers: La Resistencia del Conocimiento</title>
    <style>
        /* Reset y configuraci贸n base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #00ff88;
            --primary-blue: #0088ff;
            --primary-pink: #ff0088;
            --dark-bg: #0f0f0f;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(0, 255, 136, 0.3);
            --text-shadow: 0 0 10px var(--primary-green);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark-bg);
            color: #fff;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* Estilos de la portada */
        .intro-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, var(--dark-bg) 100%);
            transition: opacity 1s ease;
        }

        .circuit-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 35px, var(--primary-green) 35px, var(--primary-green) 40px),
                repeating-linear-gradient(90deg, transparent, transparent 35px, var(--primary-green) 35px, var(--primary-green) 40px);
            animation: circuit-flow 20s linear infinite;
        }

        @keyframes circuit-flow {
            from { transform: translate(0, 0); }
            to { transform: translate(40px, 40px); }
        }

        .title-container {
            z-index: 10;
            text-align: center;
            animation: title-glow 2s ease-in-out infinite alternate;
            padding-bottom: 180px; /* M谩s espacio para el pie de p谩gina */
            max-width: 90%;
            margin: 0 auto;
        }

        @keyframes title-glow {
            from { filter: drop-shadow(0 0 20px var(--primary-green)); }
            to { filter: drop-shadow(0 0 40px var(--primary-green)) drop-shadow(0 0 60px var(--primary-blue)); }
        }

        h1 {
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: linear-gradient(45deg, var(--primary-green), var(--primary-blue), var(--primary-pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-shift 3s ease-in-out infinite;
        }

        @keyframes text-shift {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .subtitle {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            margin-top: 20px;
            color: var(--primary-green);
            text-shadow: var(--text-shadow);
            opacity: 1;
            animation: none;
        }

        /* === DISEO COMPLETAMENTE NUEVO Y MEJORADO === */

        /* Efectos de fondo */
        .background-effects {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .animated-gradient {
            position: absolute;
            width: 120%;
            height: 120%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(0, 255, 136, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0, 136, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 0, 136, 0.08) 0%, transparent 70%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 30%, #16213e 70%, #0f0f0f 100%);
            animation: gradient-flow 20s ease-in-out infinite;
        }

        @keyframes gradient-flow {
            0%, 100% { transform: translate(-10%, -10%) rotate(0deg) scale(1); }
            33% { transform: translate(-5%, -15%) rotate(1deg) scale(1.02); }
            66% { transform: translate(-15%, -5%) rotate(-1deg) scale(0.98); }
        }

        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary-green);
            border-radius: 50%;
            left: var(--x);
            top: var(--y);
            animation: particle-float 15s linear infinite;
            animation-delay: var(--delay);
            box-shadow: 0 0 10px var(--primary-green);
        }

        @keyframes particle-float {
            0% { 
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translateY(90vh) scale(1);
            }
            90% {
                opacity: 1;
                transform: translateY(-10vh) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-20vh) scale(0);
            }
        }

        .grid-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: grid-pulse 8s ease-in-out infinite;
        }

        @keyframes grid-pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        /* Contenedor principal */
        .main-content {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header mejorado */
        .hero-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .logo-orb {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .orb-inner {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #000;
            font-weight: bold;
            box-shadow: 
                0 0 30px rgba(0, 255, 136, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
            animation: orb-pulse 3s ease-in-out infinite;
        }

        .orb-ring {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px solid var(--primary-green);
            border-radius: 50%;
            opacity: 0.5;
            animation: ring-rotate 8s linear infinite;
        }

        @keyframes orb-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes ring-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .title-section {
            text-align: center;
        }

        .main-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            background: linear-gradient(45deg, var(--primary-green), var(--primary-blue), var(--primary-pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            animation: title-glow 3s ease-in-out infinite alternate;
        }

        @keyframes title-glow {
            from { filter: drop-shadow(0 0 20px var(--primary-green)); }
            to { filter: drop-shadow(0 0 40px var(--primary-blue)); }
        }

        .subtitle {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: var(--primary-green);
            text-shadow: 0 0 15px var(--primary-green);
            margin: 0;
        }

        /* Contenido principal */
        .hero-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-wrapper {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        /* Alerta de emergencia */
        .emergency-alert {
            background: linear-gradient(135deg, rgba(255, 0, 136, 0.2), rgba(255, 68, 68, 0.15));
            border: 2px solid var(--primary-pink);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(15px);
            animation: alert-glow 4s ease-in-out infinite;
        }

        @keyframes alert-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 0, 136, 0.3);
                border-color: var(--primary-pink);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 0, 136, 0.6);
                border-color: #ff6666;
            }
        }

        .alert-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .alert-icon {
            font-size: 2rem;
            animation: alert-flash 2s ease-in-out infinite;
        }

        @keyframes alert-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .alert-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-pink);
            text-shadow: 0 0 10px var(--primary-pink);
        }

        .alert-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #fff;
            margin: 0;
        }

        /* Informaci贸n del programa */
        .program-info {
            margin: 20px 0;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .info-card:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--primary-green);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .card-content h3 {
            font-size: 1.2rem;
            color: var(--primary-green);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .card-content p {
            color: #ccc;
            margin: 0;
            font-size: 0.95rem;
        }

        /* Llamada a la acci贸n */
        .cta-section {
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--primary-green);
            border-radius: 25px;
            padding: 40px;
            backdrop-filter: blur(15px);
        }

        .cta-title {
            font-size: clamp(1.5rem, 4vw, 2rem);
            color: var(--primary-green);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .cta-description {
            font-size: 1.1rem;
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Bot贸n hero mejorado */
        .hero-button {
            position: relative;
            padding: 20px 50px;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
            color: #000;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            overflow: hidden;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
        }

        .hero-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.6);
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-green));
        }

        .button-icon {
            font-size: 1.5rem;
        }

        .button-shine {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .hero-button:hover .button-shine {
            left: 100%;
        }

        /* Pie de p谩gina integrado */
        .hero-footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .footer-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .project-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, rgba(255, 0, 136, 0.2), rgba(255, 0, 136, 0.1));
            border: 1px solid var(--primary-pink);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .badge-label {
            font-size: 0.8rem;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .badge-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-pink);
            text-shadow: 0 0 10px var(--primary-pink);
        }

        .academic-info {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .student-info, .course-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            text-align: center;
        }

        .student-info strong, .course-info strong {
            color: var(--primary-green);
            font-size: 1rem;
            font-weight: bold;
        }

        .student-info span, .course-info span {
            color: #ccc;
            font-size: 0.9rem;
        }

        /* F贸rmulas en las esquinas */
        .corner-formulas {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .formula {
            position: absolute;
            background: rgba(0, 136, 255, 0.1);
            border: 1px solid var(--primary-blue);
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--primary-blue);
            backdrop-filter: blur(10px);
            animation: formula-float 6s ease-in-out infinite;
        }

        .formula-tl { top: 20px; left: 20px; animation-delay: 0s; }
        .formula-tr { top: 20px; right: 20px; animation-delay: 2s; }
        .formula-bl { bottom: 20px; left: 20px; animation-delay: 4s; }
        .formula-br { bottom: 20px; right: 20px; animation-delay: 6s; }

        @keyframes formula-float {
            0%, 100% { 
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: translateY(-10px) scale(1.05);
                opacity: 1;
            }
        }

        /* Media queries para el men煤 hamburguesa */
        @media (max-width: 768px) {
            /* Mostrar header compacto en m贸viles */
            .nav-header {
                display: flex !important;
            }
            
            /* Ocultar navegaci贸n completa en m贸viles */
            .nav-full-menu {
                display: none !important;
            }
            
            /* Navbar m谩s compacto */
            .navbar {
                padding: 8px 15px !important;
            }
            
            /* Ajustar padding de navbar y eliminar gap */
            .navbar {
                padding: 10px 15px !important;
            }
            
            .nav-content {
                gap: 0 !important;
                flex-direction: row !important;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px 15px;
            }
            
            .title-container {
                padding-bottom: 160px; /* M谩s espacio en m贸viles */
            }
            
            .training-features {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .mission-description {
                margin: 20px 0;
                padding: 20px 15px;
            }
            
            .formula {
                font-size: 0.75rem;
                padding: 6px 8px;
            }
            
            .session-container {
                padding: 20px 10px;
            }
            
            .content-card {
                padding: 20px 15px;
            }
            
            .instruction-card {
                padding: 20px 15px;
                min-height: 200px;
            }
            
            .instruction-icon {
                font-size: 2.2rem;
                margin-bottom: 12px;
            }
            
            .instruction-card h4 {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .instruction-card p {
                font-size: 0.88rem;
            }
            
            .achievement {
                right: -320px;
                max-width: 300px;
            }
            
            .achievement.show {
                right: 10px;
            }
            
            /* Optimizaciones espec铆ficas para elementos interactivos */
            .concept-card {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .analogy-canvas {
                max-width: 100%;
                width: 100%;
                height: auto;
                min-height: 160px;
            }
            
            /* Controles t谩ctiles m谩s grandes */
            input[type="range"] {
                height: 40px;
                -webkit-appearance: none;
                background: transparent;
                width: 100%;
            }
            
            input[type="range"]::-webkit-slider-track {
                height: 8px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 4px;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 24px;
                height: 24px;
                background: var(--primary-green);
                border-radius: 50%;
                cursor: pointer;
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
                border: 2px solid #fff;
                margin-top: -8px;
            }
            
            /* Firefox */
            input[type="range"]::-moz-range-track {
                height: 8px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 4px;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            input[type="range"]::-moz-range-thumb {
                width: 24px;
                height: 24px;
                background: var(--primary-green);
                border-radius: 50%;
                cursor: pointer;
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
                border: 2px solid #fff;
            }
            
            /* Inputs m谩s accesibles */
            input[type="number"], select {
                min-height: 44px;
                font-size: 16px; /* Evita zoom en iOS */
                padding: 12px;
                border-radius: 8px;
                border: 2px solid var(--primary-green);
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
            }
            
            /* Botones optimizados para touch */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 0.95rem;
                margin: 8px 4px;
                border-radius: 8px;
                touch-action: manipulation;
            }
            
            /* Calculadoras m贸viles */
            .calculatorContent > div {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            /* Quiz m贸vil */
            .quiz-question {
                padding: 18px 15px;
                margin-bottom: 20px;
            }
            
            .quiz-options label {
                padding: 15px 12px;
                margin-bottom: 10px;
                font-size: 0.9rem;
                border-radius: 8px;
                min-height: 50px;
                display: flex;
                align-items: center;
            }
            
            .quiz-options input[type="radio"] {
                width: 20px;
                height: 20px;
                margin-right: 12px;
                flex-shrink: 0;
            }
            
            /* Simulador m贸vil */
            .simulatorContent {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .simulatorContent canvas {
                max-width: 100%;
                height: auto;
            }
            
            /* Problemas del mundo real en m贸vil */
            .realWorldContent .problem-card {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .realWorldContent input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .realWorldContent .problem-actions {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            
            .info-cards {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .info-card {
                padding: 12px;
                min-height: 100px;
            }
            
            .card-icon {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            
            .card-content h3 {
                font-size: 1rem;
                margin-bottom: 5px;
            }
            
            .card-content p {
                font-size: 0.85rem;
            }
            
            .hero-button {
                padding: 15px 25px;
                font-size: 1rem;
            }
            
            .ready-btn {
                padding: 15px 25px;
                font-size: 1rem;
            }
            
            .academic-info {
                gap: 15px;
            }
            
            .nav-menu {
                gap: 8px;
            }
            
            .nav-item {
                min-width: 70px;
                font-size: 0.75rem;
                padding: 6px 8px;
            }
            
            .session-container {
                padding: 10px 8px;
            }
            
            .content-card {
                padding: 15px 12px;
            }
            
            .session-title {
                font-size: clamp(1.5rem, 6vw, 2rem);
            }
            
            .session-subtitle {
                font-size: clamp(0.9rem, 3vw, 1rem);
            }
            
            /* Texto m谩s legible en m贸vil */
            .concept-description, .instruction-card p {
                font-size: 0.9rem;
                line-height: 1.5;
            }
            
            /* Espaciado optimizado */
            .instructions-grid {
                gap: 12px;
            }
            
            .instruction-card {
                padding: 15px 12px;
                min-height: 160px;
            }
            
            /* Canvas m谩s peque帽os pero funcionales */
            .analogy-canvas {
                width: 100%;
                max-width: 100%;
                height: 120px;
            }
            
            /* Achievement m谩s compacto */
            .achievement {
                right: -280px;
                max-width: 260px;
                padding: 12px 15px;
            }
            
            .achievement h4 {
                font-size: 1rem;
                margin-bottom: 5px;
            }
            
            .achievement p {
                font-size: 0.85rem;
            }
        }

        /* Optimizaciones espec铆ficas para pantallas t谩ctiles */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover, .hero-button:hover, .ready-btn:hover {
                transform: none;
            }
            
            .btn:active, .hero-button:active, .ready-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            .nav-item:hover {
                background: rgba(0, 255, 136, 0.1);
            }
            
            .concept-card:hover, .instruction-card:hover, .info-card:hover {
                transform: none;
            }
            
            .concept-card:active, .instruction-card:active, .info-card:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
        }

        /* Mejoras para orientaci贸n horizontal en m贸viles */
        @media (max-width: 768px) and (orientation: landscape) {
            .intro-container {
                height: auto;
                min-height: 100vh;
                padding: 20px 0;
            }
            
            .main-content {
                flex-direction: row;
                align-items: flex-start;
                gap: 30px;
            }
            
            .hero-header {
                flex: 0 0 40%;
            }
            
            .hero-main {
                flex: 1;
            }
            
            .logo-container {
                flex-direction: row;
                gap: 20px;
            }
            
            .info-cards {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
        }

        .enter-btn {
            margin-top: 50px;
            padding: 20px 60px;
            font-size: 1.3rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: transparent;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            opacity: 1;
            animation: none;
        }

        .enter-btn:hover {
            color: #000;
            background: var(--primary-green);
            box-shadow: 0 0 30px var(--primary-green);
            transform: scale(1.05);
        }

        /* Sistema principal */
        .main-container {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1a2e 100%);
        }

        /* Barra de navegaci贸n con men煤 hamburguesa para m贸viles */
        .navbar {
            background: rgba(0, 0, 0, 0.95);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 255, 136, 0.3);
            backdrop-filter: blur(10px);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Header compacto para m贸viles */
        .nav-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 15px;
        }

        .hamburger-btn {
            background: none;
            border: 2px solid var(--primary-green);
            color: var(--primary-green);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hamburger-btn:hover {
            background: var(--primary-green);
            color: #000;
        }

        .hamburger-btn:active {
            transform: scale(0.95);
        }

        .nav-title-mobile {
            flex: 1;
            text-align: center;
        }

        .current-session-indicator {
            display: block;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-green);
            text-shadow: 0 0 5px var(--primary-green);
        }

        .nav-subtitle {
            display: block;
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 2px;
        }

        .progress-indicator-compact {
            display: flex;
            align-items: center;
        }

        .progress-dots {
            display: flex;
            gap: 6px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: var(--transition);
        }

        .dot.active {
            background: var(--primary-green);
            box-shadow: 0 0 8px var(--primary-green);
        }

        .dot.completed {
            background: var(--primary-blue);
            box-shadow: 0 0 8px var(--primary-blue);
        }

        /* Navegaci贸n completa (desktop solamente) */
        .nav-full-menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }
        
        /* Ocultar header m贸vil en desktop */
        @media (min-width: 769px) and (orientation: portrait) {
            .nav-header {
                display: none !important;
            }
            
            .nav-full-menu {
                display: flex !important;
            }
        }

        /* Desktop en landscape - solo mostrar men煤 completo si es realmente desktop */
        @media (min-width: 1025px) {
            .nav-header {
                display: none !important;
            }
            
            .nav-full-menu {
                display: flex !important;
            }
        }

        /* Regla espec铆fica para pantallas grandes pero no demasiado altas (tablets landscape) */
        @media (min-width: 769px) and (max-width: 1024px) and (orientation: landscape) and (max-height: 600px) {
            .nav-header {
                display: flex !important;
            }
            
            .nav-full-menu {
                display: none !important;
            }
        }

        .nav-title {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            color: var(--primary-green);
            text-shadow: var(--text-shadow);
            font-weight: 600;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            list-style: none;
            flex-wrap: wrap;
        }

        .nav-item {
            cursor: pointer;
            padding: 10px 15px;
            border: 1px solid transparent;
            transition: var(--transition);
            position: relative;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-item:hover:not(.locked) {
            border-color: var(--primary-green);
            color: var(--primary-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .nav-item.active {
            background: rgba(0, 255, 136, 0.15);
            border-color: var(--primary-green);
            color: var(--primary-green);
        }

        .nav-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-item.locked::after {
            content: '';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Overlay de navegaci贸n m贸vil */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .mobile-nav-content {
            background: linear-gradient(135deg, #0f0f0f, #1a1a2e);
            border: 2px solid var(--primary-green);
            border-radius: 20px;
            margin: 20px;
            padding: 30px 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 255, 136, 0.3);
        }

        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .mobile-nav-header h3 {
            color: var(--primary-green);
            font-size: 1.3rem;
            margin: 0;
            text-shadow: 0 0 10px var(--primary-green);
        }

        .close-mobile-nav {
            background: none;
            border: 2px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: var(--transition);
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-mobile-nav:hover {
            background: var(--primary-pink);
            color: #000;
        }

        .mobile-nav-menu {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .mobile-nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(0, 0, 0, 0.3);
        }

        .mobile-nav-item:hover:not(.locked) {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--primary-green);
            transform: translateX(5px);
        }

        .mobile-nav-item.active {
            background: rgba(0, 255, 136, 0.15);
            border-color: var(--primary-green);
        }

        .mobile-nav-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .mobile-nav-item.locked:hover {
            transform: none;
            background: rgba(0, 0, 0, 0.3);
            border-color: transparent;
        }

        .mobile-nav-icon {
            font-size: 1.5rem;
            min-width: 30px;
            text-align: center;
        }

        .mobile-nav-text {
            flex: 1;
        }

        .mobile-nav-text strong {
            display: block;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .mobile-nav-text small {
            color: #ccc;
            font-size: 0.8rem;
        }

        .mobile-nav-status {
            font-size: 1.2rem;
            min-width: 25px;
            text-align: center;
        }

        .mobile-nav-item.active .mobile-nav-status {
            color: var(--primary-green);
        }

        .mobile-nav-item.locked .mobile-nav-status {
            color: #666;
        }

        .mobile-progress-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .mobile-progress-text {
            color: var(--primary-green);
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .mobile-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .mobile-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));
            width: 0%;
            transition: width 1s ease;
            box-shadow: 0 0 10px var(--primary-green);
            border-radius: 4px;
        }

        /* Barra de progreso original */
        .progress-container {
            width: 100%;
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));
            width: 0%;
            transition: width 1s ease;
            box-shadow: 0 0 10px var(--primary-green);
            border-radius: 3px;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        /* Contenedor de sesiones */
        .session-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .session {
            display: none;
            animation: session-enter 0.5s ease;
        }

        .session.active {
            display: block;
        }

        @keyframes session-enter {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .session-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .session-title {
            font-size: clamp(2rem, 5vw, 2.5rem);
            color: var(--primary-green);
            margin-bottom: 10px;
            text-shadow: var(--text-shadow);
        }

        .session-subtitle {
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: #ccc;
        }

        /* Tarjetas de contenido mejoradas */
        .content-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .content-card:hover {
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.2);
            transform: translateY(-5px);
        }

        /* Botones mejorados */
        .btn {
            padding: 12px 25px;
            background: transparent;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: var(--transition);
            margin: 10px 5px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-green);
            color: #000;
            box-shadow: 0 0 20px var(--primary-green);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.pulse {
            animation: pulse-button 2s infinite;
        }

        @keyframes pulse-button {
            0% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 40px rgba(0, 255, 136, 0.8), 0 0 60px rgba(0, 255, 136, 0.4);
                transform: scale(1.02);
            }
            100% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
                transform: scale(1);
            }
        }

        /* Tarjetas de instrucciones mejoradas */
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .instruction-card {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: var(--transition);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .instruction-card:hover {
            background: rgba(0, 255, 136, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .instruction-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            animation: icon-float 3s ease-in-out infinite;
        }

        @keyframes icon-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .instruction-card h4 {
            color: var(--primary-green);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .instruction-card p {
            color: #ccc;
            font-size: 0.95rem;
            line-height: 1.6;
            flex-grow: 1;
        }

        /* Bot贸n "Listo para comenzar" mejorado */
        .ready-btn {
            padding: 15px 35px;
            font-size: 1rem;
            background: linear-gradient(135deg, #8b00ff, var(--primary-pink));
            color: #fff;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(139, 0, 255, 0.4);
        }

        .ready-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 0, 255, 0.6);
            background: linear-gradient(135deg, #9d1aff, #ff1a7d);
        }

        .ready-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .ready-btn:hover::before {
            left: 100%;
        }

        /* Animaci贸n especial para el bot贸n de misi贸n */
        .ready-btn {
            animation: mission-pulse 3s ease-in-out infinite;
        }

        @keyframes mission-pulse {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(139, 0, 255, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 8px 25px rgba(139, 0, 255, 0.6), 0 0 30px rgba(255, 0, 136, 0.3);
                transform: scale(1.02);
            }
        }

        /* Animaci贸n para el fondo del 谩rea final */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Conceptos interactivos mejorados */
        .concept-card {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid var(--primary-green);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            cursor: pointer;
            transition: var(--transition);
        }

        .concept-card:hover {
            transform: scale(1.02);
            background: rgba(0, 255, 136, 0.08);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .concept-title {
            color: var(--primary-green);
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .concept-description {
            margin-bottom: 12px;
            font-size: 1rem;
            line-height: 1.6;
        }

        .concept-analogy {
            color: #ccc;
            font-style: italic;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 4px solid var(--primary-green);
        }

        .analogy-canvas {
            background: #000;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            border: 2px solid var(--primary-green);
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        /* Modal de confirmaci贸n personalizado */
        .restart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .restart-modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--primary-green);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modal-appear 0.3s ease;
        }

        @keyframes modal-appear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .restart-modal h2 {
            color: var(--primary-green);
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--primary-green);
        }

        .restart-modal p {
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .restart-modal-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .restart-modal-btn {
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 150px;
        }

        .restart-confirm-btn {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #fff;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
        }

        .restart-confirm-btn:hover {
            background: linear-gradient(135deg, #ff6666, #ff0000);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 68, 68, 0.6);
        }

        .restart-cancel-btn {
            background: linear-gradient(135deg, #666, #333);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .restart-cancel-btn:hover {
            background: linear-gradient(135deg, #777, #444);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
        }
        .restart-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #fff;
            border: 2px solid #ff4444;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .restart-btn:hover {
            background: linear-gradient(135deg, #ff6666, #ff0000);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 68, 68, 0.6);
        }

        .restart-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
        }

        #adminPanel h4 {
            color: var(--primary-green);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        #adminPanel button {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        #adminPanel button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        #adminPanel input {
            width: 100%;
            padding: 6px;
            margin-bottom: 5px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #666;
            color: #fff;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        #adminPanel input:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        /* Bot贸n de configuraci贸n - ELIMINADO */

        /* Sistema de logros mejorado */
        .achievement {
            position: fixed;
            top: 20px;
            right: -450px;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
            color: #000;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 255, 136, 0.6);
            transition: right 0.5s ease;
            z-index: 2000;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .achievement.show {
            right: 20px;
        }

        .achievement h4 {
            margin: 0 0 8px 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .achievement p {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.8;
        }

        /* Lista de verificaci贸n mejorada */
        .checklist-container {
            background: rgba(0, 136, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 136, 255, 0.3);
        }

        .checklist-title {
            color: var(--primary-blue);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .checklist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: var(--transition);
        }

        .checklist-item:hover {
            background: rgba(0, 136, 255, 0.1);
        }

        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-blue);
        }

        /* Responsive mejorado para la experiencia completa en m贸viles */
        @media (max-width: 768px) {
            .footer-content {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px 15px;
            }
            
            .title-container {
                padding-bottom: 160px; /* M谩s espacio en m贸viles */
            }
            
            .training-features {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .mission-description {
                margin: 20px 0;
                padding: 20px 15px;
            }
            
            .formula {
                font-size: 0.75rem;
                padding: 6px 8px;
            }
            
            .nav-content {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .nav-menu {
                justify-content: flex-start;
                gap: 8px;
                overflow-x: auto;
                padding: 5px 0;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-item {
                flex: 0 0 auto;
                min-width: 75px;
                padding: 8px 10px;
                font-size: 0.8rem;
                text-align: center;
                white-space: nowrap;
            }
            
            .session-container {
                padding: 20px 10px;
            }
            
            .content-card {
                padding: 20px 15px;
            }
            
            .instruction-card {
                padding: 20px 15px;
                min-height: 200px;
            }
            
            .instruction-icon {
                font-size: 2.2rem;
                margin-bottom: 12px;
            }
            
            .instruction-card h4 {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .instruction-card p {
                font-size: 0.88rem;
            }
            
            .achievement {
                right: -320px;
                max-width: 300px;
            }
            
            .achievement.show {
                right: 10px;
            }
            
            /* Optimizaciones espec铆ficas para elementos interactivos */
            .concept-card {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .analogy-canvas {
                max-width: 100%;
                width: 100%;
                height: auto;
                min-height: 160px;
            }
            
            /* Controles t谩ctiles m谩s grandes */
            input[type="range"] {
                height: 40px;
                -webkit-appearance: none;
                background: transparent;
            }
            
            input[type="range"]::-webkit-slider-track {
                height: 8px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 24px;
                height: 24px;
                background: var(--primary-green);
                border-radius: 50%;
                cursor: pointer;
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            }
            
            /* Inputs m谩s accesibles */
            input[type="number"], select {
                min-height: 44px;
                font-size: 16px; /* Evita zoom en iOS */
                padding: 12px;
                border-radius: 8px;
                border: 2px solid var(--primary-green);
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
            }
            
            /* Botones optimizados para touch */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 0.95rem;
                margin: 8px 4px;
                border-radius: 8px;
                touch-action: manipulation;
            }
            
            /* Calculadoras m贸viles */
            .calculatorContent > div {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            /* Quiz m贸vil */
            .quiz-question {
                padding: 18px 15px;
                margin-bottom: 20px;
            }
            
            .quiz-options label {
                padding: 15px 12px;
                margin-bottom: 10px;
                font-size: 0.9rem;
                border-radius: 8px;
                min-height: 50px;
                display: flex;
                align-items: center;
            }
            
            .quiz-options input[type="radio"] {
                width: 20px;
                height: 20px;
                margin-right: 12px;
                flex-shrink: 0;
            }
            
            /* Simulador m贸vil */
            .simulatorContent {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .simulatorContent canvas {
                max-width: 100%;
                height: auto;
            }
            
            /* Problemas del mundo real en m贸vil */
            .realWorldContent .problem-card {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .realWorldContent input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .realWorldContent .problem-actions {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .instructions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 25px;
            }
            
            .instruction-card {
                padding: 18px 15px;
                min-height: 180px;
            }
            
            .instruction-icon {
                font-size: 2rem;
                margin-bottom: 10px;
            }
            
            .instruction-card h4 {
                font-size: 0.95rem;
                margin-bottom: 10px;
            }
            
            .instruction-card p {
                font-size: 0.85rem;
                line-height: 1.4;
            }
            
            .nav-menu {
                flex-direction: row;
                width: 100%;
                justify-content: flex-start;
                gap: 6px;
            }
            
            .nav-item {
                min-width: 65px;
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .session-title {
                font-size: clamp(1.3rem, 6vw, 1.8rem);
            }
            
            .session-subtitle {
                font-size: clamp(0.85rem, 3vw, 1rem);
            }
            
            /* Conversiones m谩s compactas */
            .conversionContent {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .conversionContent input, .conversionContent select {
                margin-bottom: 8px;
            }
            
            /* Canvas ultra-compactos pero funcionales */
            .analogy-canvas {
                height: 140px;
                min-height: 140px;
            }
            
            /* Achievement super compacto */
            .achievement {
                right: -260px;
                max-width: 240px;
                padding: 10px 12px;
            }
            
            .achievement h4 {
                font-size: 0.95rem;
                margin-bottom: 4px;
            }
            
            .achievement p {
                font-size: 0.8rem;
            }
            
            /* Controles de analog铆as m谩s compactos */
            .analogy-controls {
                padding: 15px;
                margin-top: 10px;
            }
            
            .analogy-controls input[type="range"] {
                width: 100%;
                margin: 5px 0;
            }
            
            .analogy-controls label {
                font-size: 0.85rem;
                margin-bottom: 3px;
            }
        }

        /* Mejora adicional para overlay m贸vil en landscape */
        @media (orientation: landscape) and (max-height: 600px) {
            .mobile-nav-content {
                margin: 10px;
                padding: 20px 15px;
                max-height: calc(100vh - 20px);
            }
            
            .mobile-nav-item {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            .mobile-nav-icon {
                font-size: 1.2rem;
            }
            
            .mobile-nav-text strong {
                font-size: 0.9rem;
            }
            
            .mobile-nav-text small {
                font-size: 0.7rem;
            }
        }
            /* Eliminar hover effects en dispositivos t谩ctiles */
            .btn:hover, .hero-button:hover, .ready-btn:hover,
            .nav-item:hover, .concept-card:hover, .instruction-card:hover,
            .info-card:hover, .content-card:hover {
                transform: none;
                box-shadow: initial;
            }
            
            /* Agregar feedback t谩ctil */
            .btn:active, .hero-button:active, .ready-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            .nav-item:active, .concept-card:active, .instruction-card:active {
                background: rgba(0, 255, 136, 0.15);
                transition: background 0.1s ease;
            }
            
            /* Mejorar controles de rango para touch */
            input[type="range"]::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }
            
            input[type="range"]::-moz-range-thumb {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: var(--primary-green);
                cursor: pointer;
                border: none;
            }
        }

        /* Optimizaci贸n para orientaci贸n landscape en m贸viles */
        @media (max-width: 768px) and (orientation: landscape) {
            .intro-container {
                height: auto;
                min-height: 100vh;
                padding: 20px 0;
            }
            
            .main-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                align-items: start;
            }
            
            .hero-header {
                margin-bottom: 20px;
            }
            
            .logo-container {
                flex-direction: row;
                gap: 15px;
                justify-content: center;
            }
            
            .logo-orb {
                width: 60px;
                height: 60px;
            }
            
            .info-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .info-card {
                padding: 12px;
                min-height: 90px;
            }
            
            .card-icon {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .hero-footer {
                grid-column: 1 / -1;
                margin-top: 30px;
            }
        }

        @media (max-width: 480px) {
            .instructions-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .instruction-card {
                padding: 20px 15px;
                min-height: 200px;
            }
            
            .instruction-icon {
                font-size: 2.2rem;
                margin-bottom: 12px;
            }
            
            .instruction-card h4 {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .instruction-card p {
                font-size: 0.85rem;
                line-height: 1.5;
            }
            
            .nav-menu {
                flex-direction: column;
                width: 100%;
            }
            
            .nav-item {
                text-align: center;
            }
        }

        /* Efectos adicionales */
        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary-green);
            border-radius: 50%;
            animation: spark-fly 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes spark-fly {
            to {
                transform: translate(var(--x), var(--y));
                opacity: 0;
            }
        }

        /* Bot贸n de control de analog铆as */
        .analogy-control-btn {
            background: var(--primary-green);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 130px;
            justify-content: center;
            transition: var(--transition);
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .analogy-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.5);
        }

        .analogy-control-btn:active {
            transform: translateY(0);
        }

        /* Responsive para botones de control */
        @media (max-width: 768px) {
            .analogy-control-btn {
                padding: 10px 15px;
                font-size: 0.85rem;
                min-width: 110px;
            }
            
            /* Mejoras espec铆ficas para controles de analog铆as en m贸viles */
            .analogy-display {
                padding: 10px;
            }
            
            .analogy-canvas {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                min-height: 160px !important;
            }
            
            /* Controles de resistencia responsivos */
            .analogy-display input[type="range"] {
                width: 100% !important;
                max-width: 100% !important;
                margin: 5px 0;
                height: 40px !important;
                -webkit-appearance: none !important;
                background: transparent !important;
                outline: none;
            }
            
            /* Estilos espec铆ficos para analog铆as en m贸vil */
            .analogy-display input[type="range"]::-webkit-slider-track {
                height: 10px !important;
                background: linear-gradient(90deg, rgba(255, 255, 255, 0.2), rgba(0, 255, 136, 0.3)) !important;
                border-radius: 5px !important;
                border: 2px solid rgba(0, 255, 136, 0.4) !important;
                box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3) !important;
            }
            
            .analogy-display input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none !important;
                width: 28px !important;
                height: 28px !important;
                background: radial-gradient(circle, var(--primary-green), #00cc66) !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                box-shadow: 0 0 15px rgba(0, 255, 136, 0.8), 0 2px 6px rgba(0, 0, 0, 0.4) !important;
                border: 3px solid #fff !important;
                margin-top: -11px !important;
                transition: all 0.2s ease !important;
            }
            
            .analogy-display input[type="range"]::-webkit-slider-thumb:hover {
                transform: scale(1.1) !important;
                box-shadow: 0 0 20px rgba(0, 255, 136, 1), 0 4px 8px rgba(0, 0, 0, 0.5) !important;
            }
            
            /* Firefox espec铆fico para analog铆as */
            .analogy-display input[type="range"]::-moz-range-track {
                height: 10px !important;
                background: linear-gradient(90deg, rgba(255, 255, 255, 0.2), rgba(0, 255, 136, 0.3)) !important;
                border-radius: 5px !important;
                border: 2px solid rgba(0, 255, 136, 0.4) !important;
            }
            
            .analogy-display input[type="range"]::-moz-range-thumb {
                width: 28px !important;
                height: 28px !important;
                background: radial-gradient(circle, var(--primary-green), #00cc66) !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                box-shadow: 0 0 15px rgba(0, 255, 136, 0.8) !important;
                border: 3px solid #fff !important;
            }
            
            .analogy-display label {
                font-size: 0.9rem !important;
                text-align: center !important;
            }
            
            /* Grid de efectos responsivo */
            .analogy-display div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }
        }
        
        @media (max-width: 480px) {
            .analogy-display {
                padding: 8px;
            }
            
            .analogy-canvas {
                min-height: 140px !important;
            }
            
            .analogy-display label {
                font-size: 0.8rem !important;
                margin-bottom: 3px !important;
            }
            
            .analogy-display input[type="range"] {
                height: 45px !important;
                -webkit-appearance: none !important;
                background: transparent !important;
                outline: none !important;
                margin: 8px 0 !important;
            }
            
            .analogy-display input[type="range"]::-webkit-slider-track {
                height: 12px !important;
                background: linear-gradient(90deg, rgba(255, 255, 255, 0.3), rgba(0, 255, 136, 0.4)) !important;
                border-radius: 6px !important;
                border: 2px solid rgba(0, 255, 136, 0.6) !important;
                box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4) !important;
            }
            
            .analogy-display input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none !important;
                width: 32px !important;
                height: 32px !important;
                background: radial-gradient(circle, var(--primary-green), #00aa55) !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                box-shadow: 0 0 20px rgba(0, 255, 136, 1), 0 3px 8px rgba(0, 0, 0, 0.5) !important;
                border: 4px solid #fff !important;
                margin-top: -14px !important;
                transition: all 0.2s ease !important;
            }
            
            .analogy-display input[type="range"]::-moz-range-track {
                height: 12px !important;
                background: linear-gradient(90deg, rgba(255, 255, 255, 0.3), rgba(0, 255, 136, 0.4)) !important;
                border-radius: 6px !important;
                border: 2px solid rgba(0, 255, 136, 0.6) !important;
            }
            
            .analogy-display input[type="range"]::-moz-range-thumb {
                width: 32px !important;
                height: 32px !important;
                background: radial-gradient(circle, var(--primary-green), #00aa55) !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                box-shadow: 0 0 20px rgba(0, 255, 136, 1) !important;
                border: 4px solid #fff !important;
            }
            
            .analogy-display span {
                font-size: 0.9rem !important;
            }
        }
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-green);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Pantalla de introducci贸n -->
    <div class="intro-container" id="intro">
        <!-- Fondo con efectos modernos -->
        <div class="background-effects">
            <div class="animated-gradient"></div>
            <div class="floating-particles">
                <div class="particle" style="--delay: 0s; --x: 20%; --y: 30%;"></div>
                <div class="particle" style="--delay: 2s; --x: 80%; --y: 20%;"></div>
                <div class="particle" style="--delay: 4s; --x: 10%; --y: 70%;"></div>
                <div class="particle" style="--delay: 6s; --x: 90%; --y: 80%;"></div>
                <div class="particle" style="--delay: 8s; --x: 50%; --y: 60%;"></div>
            </div>
            <div class="grid-overlay"></div>
        </div>

        <!-- Contenido principal en una estructura fluida -->
        <div class="main-content">
            <!-- Encabezado con logo y t铆tulo -->
            <header class="hero-header">
                <div class="logo-container">
                    <div class="logo-orb">
                        <div class="orb-inner"></div>
                        <div class="orb-ring"></div>
                    </div>
                    <div class="title-section">
                        <h1 class="main-title">Ohm-Vengers</h1>
                        <p class="subtitle">La Resistencia del Conocimiento</p>
                    </div>
                </div>
            </header>

            <!-- Secci贸n de contenido principal -->
            <main class="hero-main">
                <div class="content-wrapper">
                    <!-- Mensaje de emergencia -->
                    <div class="emergency-alert">
                        <div class="alert-header">
                            <span class="alert-icon"></span>
                            <span class="alert-title">EMERGENCIA ELCTRICA</span>
                        </div>
                        <p class="alert-message">
                            El sistema energ茅tico regional est谩 en colapso total. 
                            Se requieren especialistas en electricidad para una misi贸n cr铆tica de rescate.
                        </p>
                    </div>

                    <!-- Informaci贸n del programa -->
                    <div class="program-info">
                        <div class="info-cards">
                            <div class="info-card">
                                <div class="card-icon">М</div>
                                <div class="card-content">
                                    <h3>Ley de Ohm</h3>
                                    <p>Domina V = I  R</p>
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="card-icon"></div>
                                <div class="card-content">
                                    <h3>Simulaciones</h3>
                                    <p>Experimentos interactivos</p>
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="card-icon"></div>
                                <div class="card-content">
                                    <h3>Casos Reales</h3>
                                    <p>Problemas del mundo real</p>
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="card-icon"></div>
                                <div class="card-content">
                                    <h3>Desaf铆os</h3>
                                    <p>Pruebas de ingenier铆a</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Llamada a la acci贸n -->
                    <div class="cta-section">
                        <h2 class="cta-title">驴Tienes lo necesario para ser un Ohm-Venger?</h2>
                        <p class="cta-description">
                            nete a la misi贸n de rescate y convi茅rtete en un especialista en electricidad.
                            Tu conocimiento puede salvar a miles de personas.
                        </p>
                        <button class="hero-button" onclick="showInstructions()">
                            <span class="button-icon"></span>
                            <span class="button-text">INICIAR ENTRENAMIENTO</span>
                            <div class="button-shine"></div>
                        </button>
                    </div>
                </div>
            </main>

            <!-- Pie de p谩gina integrado -->
            <footer class="hero-footer">
                <div class="footer-info">
                    <div class="project-badge">
                        <span class="badge-label">PROYECTO</span>
                        <span class="badge-value">MISIN 02</span>
                    </div>
                    <div class="academic-info">
                        <div class="student-info">
                            <strong>Carlos Mario Sanjuan Amador</strong>
                            <span>Universidad de Cartagena</span>
                        </div>
                        <div class="course-info">
                            <strong>Did谩ctica y dise帽o de cursos en l铆nea</strong>
                            <span>Prof.  Luisa Fernanda Lopez Alvarez </span>
                            <span>Noviembre 2025</span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>

        <!-- F贸rmulas flotantes en las esquinas -->
        <div class="corner-formulas">
            <div class="formula formula-tl">V = I  R</div>
            <div class="formula formula-tr">P = V  I</div>
            <div class="formula formula-bl">I = V 梅 R</div>
            <div class="formula formula-br">P = I虏  R</div>
        </div>
    </div>

    <!-- Pantalla de instrucciones -->
    <div id="instructions" style="
        display: none; 
        height: 100vh; 
        background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f0f 100%);
        overflow-y: auto;
        padding: 20px;
        position: relative;
    ">
        <div class="circuit-bg"></div>
        
        <div style="max-width: 1000px; margin: 0 auto; background: rgba(0, 0, 0, 0.95); border: 2px solid var(--primary-green); border-radius: 20px; box-shadow: 0 0 40px rgba(0, 255, 136, 0.4); backdrop-filter: blur(10px); padding: 30px; position: relative; max-height: calc(100vh - 40px); overflow-y: auto;">
            <!-- T铆tulo principal de la misi贸n -->
            <div style="text-align: center; margin-bottom: 40px; padding: 25px; background: rgba(255, 0, 136, 0.1); border-radius: 15px; border: 1px solid var(--primary-pink);">
                <h1 style="color: var(--primary-pink); font-size: clamp(1.8rem, 5vw, 2.2rem); margin-bottom: 15px; text-shadow: 0 0 20px var(--primary-pink);">
                    "Ohm-Vengers: La Resistencia del Conocimiento"
                </h1>
                <p style="font-size: clamp(1rem, 3vw, 1.2rem); color: #fff; line-height: 1.6;">
                    Una misi贸n educativa donde los estudiantes deben dominar la Ley de Ohm<br>
                    para salvar el sistema el茅ctrico de un colapso total.
                </p>
            </div>

            <h2 style="text-align: center; color: var(--primary-green); font-size: clamp(1.5rem, 4vw, 1.8rem); margin-bottom: 35px;">
                 Recomendaciones para los Estudiantes
            </h2>

            <!-- Recomendaciones reorganizadas -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 40px;">
                
                <!-- Preparaci贸n Personal -->
                <div style="background: rgba(0, 255, 136, 0.08); border: 2px solid var(--primary-green); border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; min-height: 140px; display: flex; flex-direction: column;">
                    <div style="font-size: 1.8rem; margin-bottom: 8px;"></div>
                    <h4 style="color: var(--primary-green); margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">Preparaci贸n Personal</h4>
                    <p style="color: #ccc; font-size: 0.75rem; line-height: 1.4; flex-grow: 1;">Cuaderno, l谩piz, calculadora y lugar tranquilo para estudiar.</p>
                </div>

                <!-- Actitud y Participaci贸n -->
                <div style="background: rgba(255, 0, 136, 0.08); border: 2px solid var(--primary-pink); border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; min-height: 140px; display: flex; flex-direction: column;">
                    <div style="font-size: 1.8rem; margin-bottom: 8px;"></div>
                    <h4 style="color: var(--primary-green); margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">Actitud Positiva</h4>
                    <p style="color: #ccc; font-size: 0.75rem; line-height: 1.4; flex-grow: 1;">Participa activamente y no tengas miedo de experimentar.</p>
                </div>

                <!-- Preparaci贸n Previa -->
                <div style="background: rgba(255, 165, 0, 0.08); border: 2px solid #ffa500; border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; min-height: 140px; display: flex; flex-direction: column;">
                    <div style="font-size: 1.8rem; margin-bottom: 8px;"></div>
                    <h4 style="color: var(--primary-green); margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">Estudio Previo</h4>
                    <p style="color: #ccc; font-size: 0.75rem; line-height: 1.4; flex-grow: 1;">Revisa material de apoyo si est谩 disponible antes de las actividades.</p>
                </div>

                <!-- Registro de Evidencias -->
                <div style="background: rgba(138, 43, 226, 0.08); border: 2px solid #8a2be2; border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; min-height: 140px; display: flex; flex-direction: column;">
                    <div style="font-size: 1.8rem; margin-bottom: 8px;"></div>
                    <h4 style="color: var(--primary-green); margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">Documenta tu Progreso</h4>
                    <p style="color: #ccc; font-size: 0.75rem; line-height: 1.4; flex-grow: 1;">Toma capturas y registra respuestas para tu portafolio.</p>
                </div>

                <!-- Solicitar Ayuda -->
                <div style="background: rgba(50, 205, 50, 0.08); border: 2px solid #32cd32; border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; min-height: 140px; display: flex; flex-direction: column;">
                    <div style="font-size: 1.8rem; margin-bottom: 8px;"></div>
                    <h4 style="color: var(--primary-green); margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">Pide Ayuda</h4>
                    <p style="color: #ccc; font-size: 0.75rem; line-height: 1.4; flex-grow: 1;">Solicita ayuda al docente si tienes dificultades t茅cnicas o conceptuales.</p>
                </div>

                <!-- Tiempo y Ritmo -->
                <div style="background: rgba(255, 20, 147, 0.08); border: 2px solid #ff1493; border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; min-height: 140px; display: flex; flex-direction: column;">
                    <div style="font-size: 1.8rem; margin-bottom: 8px;"></div>
                    <h4 style="color: var(--primary-green); margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">Maneja tu Tiempo</h4>
                    <p style="color: #ccc; font-size: 0.75rem; line-height: 1.4; flex-grow: 1;">Avanza a tu ritmo pero mantente enfocado en cada sesi贸n.</p>
                </div>

                <!-- tica Acad茅mica -->
                <div style="background: rgba(70, 130, 180, 0.08); border: 2px solid #4682b4; border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; min-height: 140px; display: flex; flex-direction: column;">
                    <div style="font-size: 1.8rem; margin-bottom: 8px;"></div>
                    <h4 style="color: var(--primary-green); margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">Integridad Acad茅mica</h4>
                    <p style="color: #ccc; font-size: 0.75rem; line-height: 1.4; flex-grow: 1;">Resuelve por tu cuenta para asegurar aprendizaje genuino.</p>
                </div>

            </div>

            <!-- rea para continuar -->
            <div style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 136, 255, 0.2)); border: 2px solid var(--primary-green); border-radius: 15px; padding: 30px; text-align: center; box-shadow: 0 0 30px rgba(0, 255, 136, 0.5); margin-top: 30px;">
                <h3 style="color: var(--primary-green); font-size: 1.4rem; margin-bottom: 15px; text-shadow: 0 0 20px var(--primary-green); font-weight: 800;">
                     驴Est谩s Listo para la Misi贸n?
                </h3>
                <p style="color: #fff; font-size: 1.1rem; margin-bottom: 25px; line-height: 1.6; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">
                    Has revisado todas las recomendaciones y tienes todo preparado.<br>
                    <strong style="color: var(--primary-green);">隆Es hora de convertirte en un verdadero Ohm-Venger!</strong>
                </p>
                <button class="ready-btn" onclick="checkReadyAndStart()" style="font-size: 1.1rem; padding: 18px 40px;">
                     Comenzar Misi贸n 
                </button>
            </div>
        </div>
    </div>

    <!-- Sistema principal -->
    <div class="main-container" id="mainSystem">
        <!-- Barra de navegaci贸n -->
        <nav class="navbar">
            <div class="nav-content">
                <!-- Header compacto para m贸viles -->
                <div class="nav-header">
                    <button class="hamburger-btn" onclick="game.toggleMobileMenu()" id="hamburgerBtn">
                        <span class="hamburger-icon"></span>
                    </button>
                    <div class="nav-title-mobile">
                        <span class="current-session-indicator" id="currentSessionName">Sesi贸n 1</span>
                        <span class="nav-subtitle">Ohm-Vengers</span>
                    </div>
                    <div class="progress-indicator-compact" id="progressCompact">
                        <div class="progress-dots">
                            <span class="dot active" data-session="1"></span>
                            <span class="dot" data-session="2"></span>
                            <span class="dot" data-session="3"></span>
                            <span class="dot" data-session="4"></span>
                            <span class="dot" data-session="5"></span>
                        </div>
                    </div>
                </div>

                <!-- Navegaci贸n completa (oculta en m贸viles por defecto) -->
                <div class="nav-full-menu" id="navFullMenu">
                    <div class="nav-title">Ohm-Vengers: Misi贸n en Progreso</div>
                    <ul class="nav-menu">
                        <li class="nav-item active" onclick="showSession(1)" id="nav1">Sesi贸n 1</li>
                        <li class="nav-item locked" onclick="showSession(2)" id="nav2">Sesi贸n 2</li>
                        <li class="nav-item locked" onclick="showSession(3)" id="nav3">Sesi贸n 3</li>
                        <li class="nav-item locked" onclick="showSession(4)" id="nav4">Sesi贸n 4</li>
                        <li class="nav-item locked" onclick="showSession(5)" id="nav5">Final</li>
                    </ul>
                    <div class="progress-container">
                        <div class="progress-text">Progreso general de la misi贸n</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar"></div>
                        </div>
                    </div>
                </div>

                <!-- Overlay de navegaci贸n m贸vil -->
                <div class="mobile-nav-overlay" id="mobileNavOverlay">
                    <div class="mobile-nav-content">
                        <div class="mobile-nav-header">
                            <h3>Navegaci贸n</h3>
                            <button class="close-mobile-nav" onclick="game.toggleMobileMenu()"></button>
                        </div>
                        <ul class="mobile-nav-menu">
                            <li class="mobile-nav-item active" onclick="game.selectMobileSession(1)" id="mobileNav1">
                                <span class="mobile-nav-icon"></span>
                                <div class="mobile-nav-text">
                                    <strong>Sesi贸n 1</strong>
                                    <small>Conceptos B谩sicos</small>
                                </div>
                                <span class="mobile-nav-status"></span>
                            </li>
                            <li class="mobile-nav-item locked" onclick="game.selectMobileSession(2)" id="mobileNav2">
                                <span class="mobile-nav-icon">М</span>
                                <div class="mobile-nav-text">
                                    <strong>Sesi贸n 2</strong>
                                    <small>Ley de Ohm</small>
                                </div>
                                <span class="mobile-nav-status"></span>
                            </li>
                            <li class="mobile-nav-item locked" onclick="game.selectMobileSession(3)" id="mobileNav3">
                                <span class="mobile-nav-icon"></span>
                                <div class="mobile-nav-text">
                                    <strong>Sesi贸n 3</strong>
                                    <small>Conceptos Avanzados</small>
                                </div>
                                <span class="mobile-nav-status"></span>
                            </li>
                            <li class="mobile-nav-item locked" onclick="game.selectMobileSession(4)" id="mobileNav4">
                                <span class="mobile-nav-icon"></span>
                                <div class="mobile-nav-text">
                                    <strong>Sesi贸n 4</strong>
                                    <small>Aplicaciones Pr谩cticas</small>
                                </div>
                                <span class="mobile-nav-status"></span>
                            </li>
                            <li class="mobile-nav-item locked" onclick="game.selectMobileSession(5)" id="mobileNav5">
                                <span class="mobile-nav-icon"></span>
                                <div class="mobile-nav-text">
                                    <strong>Misi贸n Final</strong>
                                    <small>Certificaci贸n</small>
                                </div>
                                <span class="mobile-nav-status"></span>
                            </li>
                        </ul>
                        <div class="mobile-progress-container">
                            <div class="mobile-progress-text">Progreso: <span id="mobileProgressPercent">0%</span></div>
                            <div class="mobile-progress-bar">
                                <div class="mobile-progress-fill" id="mobileProgressBar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contenedor de sesiones -->
        <div class="session-container">
            <!-- Sesi贸n 1: Explorando la electricidad -->
            <div class="session active" id="session1">
                <div class="session-header">
                    <h2 class="session-title">Sesi贸n 1: Explorando la Electricidad</h2>
                    <p class="session-subtitle">Descubre los conceptos b谩sicos de corriente, voltaje y resistencia</p>
                </div>

                <!-- Video de emergencia -->
                <div class="content-card">
                    <h3 style="color: var(--primary-pink); margin-bottom: 20px; font-size: 1.3rem;"> ALERTA: Sistema El茅ctrico en Peligro</h3>
                    <div style="background: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 15px; text-align: center; border: 1px solid var(--primary-green);">
                        <p style="font-size: 1.2rem; color: var(--primary-green); margin-bottom: 25px; line-height: 1.6;">
                            "Agente, el sistema el茅ctrico de la regi贸n est谩 colapsando. 
                            Necesitamos que domines los conceptos b谩sicos de electricidad para salvarlo."
                        </p>
                        <button class="btn pulse" onclick="startConcepts()">Comenzar Entrenamiento</button>
                    </div>
                </div>

                <!-- Conceptos interactivos -->
                <div class="content-card" id="conceptsSection" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;">Conceptos Fundamentales</h3>
                    <div id="conceptDisplay"></div>
                </div>
            </div>

            <!-- Sesi贸n 2: Ley de Ohm -->
            <div class="session" id="session2">
                <div class="session-header">
                    <h2 class="session-title">Sesi贸n 2: Ley de Ohm</h2>
                    <p class="session-subtitle">Aprende la relaci贸n fundamental V = I  R</p>
                </div>

                <!-- Introducci贸n a la Ley de Ohm -->
                <div class="content-card">
                    <h3 style="color: var(--primary-green); margin-bottom: 20px; font-size: 1.3rem;"> Descubriendo la Ley de Ohm</h3>
                    <div style="background: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-green);">
                        <p style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.6;">
                            "Excelente trabajo, Agente. Ahora que dominas los conceptos b谩sicos, es hora de aprender 
                            la f贸rmula m谩s importante de la electricidad: <strong style="color: var(--primary-green);">V = I  R</strong>"
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 25px;">
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--primary-green); margin-bottom: 10px;"> V = Voltaje</h4>
                                <p>La fuerza que impulsa la corriente (Voltios)</p>
                            </div>
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--primary-blue); margin-bottom: 10px;"> I = Corriente</h4>
                                <p>El flujo de electrones (Amperios)</p>
                            </div>
                            <div style="background: rgba(255, 0, 136, 0.1); padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--primary-pink); margin-bottom: 10px;">★ R = Resistencia</h4>
                                <p>La oposici贸n al flujo (Ohmios)</p>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 25px;">
                            <button class="btn pulse" onclick="game.startOhmLaw()">Explorar la Ley de Ohm</button>
                        </div>
                    </div>
                </div>

                <!-- Calculadora interactiva -->
                <div class="content-card" id="ohmCalculator" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;">М Calculadora de la Ley de Ohm</h3>
                    <div id="calculatorContent"></div>
                </div>

                <!-- Ejercicios pr谩cticos -->
                <div class="content-card" id="ohmExercises" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Ejercicios Pr谩cticos</h3>
                    <div id="exercisesContent"></div>
                </div>
            </div>

            <!-- Sesi贸n 3: Conceptos Avanzados -->
            <div class="session" id="session3">
                <div class="session-header">
                    <h2 class="session-title">Sesi贸n 3: Conceptos Avanzados</h2>
                    <p class="session-subtitle">Aprende sobre calibres de cables, eficiencia y factores de seguridad</p>
                </div>

                <!-- Introducci贸n a conceptos avanzados -->
                <div class="content-card">
                    <h3 style="color: var(--primary-green); margin-bottom: 20px; font-size: 1.3rem;"> Expandiendo tu Conocimiento</h3>
                    <div style="background: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-green);">
                        <p style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.6;">
                            "Excelente trabajo, Agente. Has dominado la Ley de Ohm, pero un verdadero Ohm-Venger 
                            necesita conocer aspectos m谩s avanzados para dise帽ar sistemas el茅ctricos seguros y eficientes."
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary-green);">
                                <strong style="color: var(--primary-green);"> Calibres de Cables</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Selecci贸n segura de conductores</p>
                            </div>
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary-blue);">
                                <strong style="color: var(--primary-blue);">锔 Eficiencia de Sistemas</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">P茅rdidas y optimizaci贸n</p>
                            </div>
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #ffa500;">
                                <strong style="color: #ffa500;">★ Factores de Seguridad</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Protecciones y dimensionamiento</p>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 25px;">
                            <button class="btn pulse" onclick="game.startAdvancedConcepts()">Comenzar Conceptos Avanzados</button>
                        </div>
                    </div>
                </div>

                <!-- Calibres de cables -->
                <div class="content-card" id="wireGaugeSection" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Calibres de Cables (AWG)</h3>
                    <div id="wireGaugeContent"></div>
                </div>

                <!-- Eficiencia de sistemas -->
                <div class="content-card" id="efficiencySection" style="display: none;">
                    <h3 style="color: var(--primary-blue); margin-bottom: 25px; font-size: 1.3rem;">锔 Eficiencia de Sistemas El茅ctricos</h3>
                    <div id="efficiencyContent"></div>
                </div>

                <!-- Factores de seguridad -->
                <div class="content-card" id="safetySection" style="display: none;">
                    <h3 style="color: #ffa500; margin-bottom: 25px; font-size: 1.3rem;">★ Factores de Seguridad</h3>
                    <div id="safetyContent"></div>
                </div>

                <!-- Evaluaci贸n de conceptos avanzados -->
                <div class="content-card" id="advancedQuiz" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Evaluaci贸n: Conceptos Avanzados</h3>
                    <div id="advancedQuizContent"></div>
                </div>
            </div>

            <!-- Sesi贸n 4: Aplicaciones Pr谩cticas y Desaf铆o Final -->
            <div class="session" id="session4">
                <div class="session-header">
                    <h2 class="session-title">Sesi贸n 4: Aplicaciones Pr谩cticas</h2>
                    <p class="session-subtitle">Resuelve problemas reales y completa el desaf铆o final</p>
                </div>

                <!-- Introducci贸n de emergencia -->
                <div class="content-card">
                    <h3 style="color: var(--primary-pink); margin-bottom: 20px; font-size: 1.3rem;"> CRISIS ELCTRICA AVANZADA</h3>
                    <div style="background: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-green);">
                        <p style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.6;">
                            "隆Excelente trabajo, Agente! Ahora que dominas tanto los conceptos b谩sicos como los avanzados, 
                            enfrentamos la crisis m谩s compleja. El sistema el茅ctrico de toda la ciudad necesita tu experiencia 
                            completa para dise帽ar soluciones seguras y eficientes."
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div style="background: rgba(255, 0, 136, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary-pink);">
                                <strong style="color: var(--primary-pink);"> Hogares sin energ铆a</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Miles de familias necesitan electricidad</p>
                            </div>
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary-blue);">
                                <strong style="color: var(--primary-blue);"> Industrias paralizadas</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">F谩bricas necesitan sistemas complejos</p>
                            </div>
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #ffa500;">
                                <strong style="color: #ffa500;"> Hospitales en riesgo</strong>
                                <p style="font-size: 0.9rem; margin-top: 5px;">Equipos m茅dicos cr铆ticos sin energ铆a</p>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 25px;">
                            <button class="btn pulse" onclick="game.startRealWorldProblems()">Aceptar la Misi贸n Final</button>
                        </div>
                    </div>
                </div>

                <!-- Problemas del mundo real -->
                <div class="content-card" id="realWorldProblems" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Problemas del Mundo Real</h3>
                    <div id="realWorldContent"></div>
                </div>

                <!-- Simulador de circuitos -->
                <div class="content-card" id="circuitSimulator" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Simulador de Circuitos</h3>
                    <div id="simulatorContent"></div>
                </div>

                <!-- Calculadora de potencia -->
                <div class="content-card" id="powerCalculator" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Calculadora de Potencia</h3>
                    <div id="powerContent"></div>
                </div>

                <!-- Simulador de Calibre de Cables -->
                <div class="content-card" id="wireGaugeSimulator" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Simulador de Calibre de Cables</h3>
                    <div id="wireGaugeContent"></div>
                </div>

                <!-- Desaf铆o final -->
                <div class="content-card" id="finalChallenge" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 25px; font-size: 1.3rem;"> Desaf铆o Final: Dise帽o de Sistema El茅ctrico</h3>
                    <div id="challengeContent"></div>
                </div>
            </div>

            <div class="session" id="session5">
                <div class="session-header">
                    <h2 class="session-title">Sesi贸n 5: Misi贸n Completada</h2>
                    <p class="session-subtitle">隆Felicitaciones! Has completado tu entrenamiento como Ohm-Venger</p>
                </div>
                
                <div class="content-card">
                    <h3 style="color: var(--primary-green); margin-bottom: 20px; font-size: 1.3rem;"> 隆MISIN COMPLETADA!</h3>
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 136, 255, 0.2)); border-radius: 15px; border: 2px solid var(--primary-green);">
                        <h2 style="color: var(--primary-green); margin-bottom: 20px; font-size: 2rem; text-shadow: 0 0 20px var(--primary-green);">
                             隆ERES OFICIALMENTE UN OHM-VENGER! 
                        </h2>
                        
                        <p style="font-size: 1.2rem; margin-bottom: 30px; line-height: 1.6;">
                            Has completado exitosamente tu entrenamiento y ahora dominas:
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--primary-green); margin-bottom: 10px;"> Conceptos B谩sicos</h4>
                                <p>Corriente, Voltaje y Resistencia</p>
                            </div>
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--primary-blue); margin-bottom: 10px;">М Ley de Ohm</h4>
                                <p>V = I  R y todas sus variaciones</p>
                            </div>
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 20px; border-radius: 10px;">
                                <h4 style="color: #ffa500; margin-bottom: 10px;"> Conceptos Avanzados</h4>
                                <p>Cables, eficiencia y seguridad</p>
                            </div>
                            <div style="background: rgba(255, 0, 136, 0.1); padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--primary-pink); margin-bottom: 10px;"> Aplicaciones Pr谩cticas</h4>
                                <p>Problemas reales y dise帽o de sistemas</p>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 0, 136, 0.1); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                            <h3 style="color: var(--primary-pink); margin-bottom: 15px;">锔 Certificado de Logro</h3>
                            <p style="font-size: 1.1rem; margin-bottom: 15px;">
                                <strong>Has salvado exitosamente el sistema el茅ctrico de la regi贸n</strong><br>
                                y ahora eres parte de la 茅lite de Ohm-Vengers.
                            </p>
                            <p style="font-size: 0.9rem; color: #ccc;">
                                Fecha de certificaci贸n: ${new Date().toLocaleDateString()}<br>
                                Curso: Ohm-Vengers - La Resistencia del Conocimiento
                            </p>
                        </div>
                        
                        <button class="ready-btn" onclick="location.reload()" style="font-size: 1.2rem; padding: 20px 40px;">
                             Comenzar Nueva Misi贸n
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot贸n de reinicio eliminado - la p谩gina siempre inicia desde cero -->
    </div>

    <!-- Notificaci贸n de logros -->
    <div class="achievement" id="achievement">
        <h4 id="achievementTitle">隆Logro Desbloqueado!</h4>
        <p id="achievementDesc">Descripci贸n del logro</p>
    </div>

    <script>
        // Variables globales del sistema
        class OhmVengersGame {
            constructor() {
                this.currentSession = 1;
                this.progress = 0;
                this.unlockedSessions = [1];
                this.analogyAnimations = {};
                this.completedActions = new Set(); // Control de acciones completadas
                this.sessionsCompleted = new Set(); // Control de sesiones completadas
                this.analogiesViewed = new Set(); // Control de analog铆as vistas
                this.exercisesCompleted = new Set(); // Control de ejercicios completados
                this.realWorldSolved = new Set(); // Control de problemas del mundo real resueltos
                this.simulatorCompleted = false; // Control del simulador
                this.powerCalculatorUsed = false; // Control de calculadora de potencia
                this.finalChallengeCompleted = false; // Control del desaf铆o final
                this.debugMode = false; // Desactivar logs por defecto
                this.analogyStates = {}; // Control de play/pause para analog铆as
                
                // Totales para c谩lculo de progreso
                this.totals = {
                    sessions: 4,
                    concepts: 3,
                    exercises: 8, // 3 de sesi贸n 2 + 5 de mundo real
                    problems: 5,
                    challenges: 5
                };
                
                // Banco de preguntas para la Sesi贸n 1 (30 preguntas totales - expandido)
                this.questionBank = [
                    // === CONCEPTOS BSICOS (8 preguntas) ===
                    {
                        question: "驴Qu茅 mide la corriente el茅ctrica?",
                        options: ["La fuerza de los electrones", "El flujo de electrones", "La resistencia al paso", "La energ铆a total"],
                        correct: 1,
                        explanation: "La corriente mide el flujo de electrones a trav茅s de un conductor."
                    },
                    {
                        question: "驴En qu茅 unidad se mide el voltaje?",
                        options: ["Amperios (A)", "Ohmios (惟)", "Voltios (V)", "Watts (W)"],
                        correct: 2,
                        explanation: "El voltaje se mide en Voltios (V), que representa la fuerza el茅ctrica."
                    },
                    {
                        question: "La resistencia es...",
                        options: ["La ayuda al flujo el茅ctrico", "La oposici贸n al flujo de corriente", "La velocidad de los electrones", "La cantidad de energ铆a"],
                        correct: 1,
                        explanation: "La resistencia es la oposici贸n que ofrece un material al paso de la corriente el茅ctrica."
                    },
                    {
                        question: "驴Cu谩l es la unidad de medida de la corriente el茅ctrica?",
                        options: ["Voltios", "Ohmios", "Amperios", "Watts"],
                        correct: 2,
                        explanation: "La corriente el茅ctrica se mide en Amperios (A)."
                    },
                    {
                        question: "驴Qu茅 representa el s铆mbolo 'I' en electricidad?",
                        options: ["Intensidad (corriente)", "Impedancia", "Inductancia", "Inercia"],
                        correct: 0,
                        explanation: "El s铆mbolo 'I' representa la intensidad de corriente el茅ctrica."
                    },
                    {
                        question: "驴Qu茅 representa el s铆mbolo 'V' en circuitos el茅ctricos?",
                        options: ["Velocidad", "Volumen", "Voltaje", "Vibraci贸n"],
                        correct: 2,
                        explanation: "El s铆mbolo 'V' representa el voltaje o diferencia de potencial."
                    },
                    {
                        question: "驴Qu茅 representa el s铆mbolo 'R' en electricidad?",
                        options: ["Rapidez", "Resistencia", "Rotaci贸n", "Radiaci贸n"],
                        correct: 1,
                        explanation: "El s铆mbolo 'R' representa la resistencia el茅ctrica."
                    },
                    {
                        question: "驴Cu谩l es una buena analog铆a para entender la corriente el茅ctrica?",
                        options: ["El peso del agua", "El flujo de agua en una tuber铆a", "La temperatura del agua", "El color del agua"],
                        correct: 1,
                        explanation: "La corriente es como el flujo de agua: ambos representan movimiento a trav茅s de un conductor."
                    },
                    
                    // === UNIDADES Y CONVERSIONES (7 preguntas) ===
                    {
                        question: "驴A cu谩ntos Amperios equivalen 500 miliamperios?",
                        options: ["5 A", "0.5 A", "50 A", "0.05 A"],
                        correct: 1,
                        explanation: "500 mA 梅 1000 = 0.5 A. Para convertir mA a A dividimos entre 1000."
                    },
                    {
                        question: "驴A cu谩ntos voltios equivalen 2.5 kilovoltios?",
                        options: ["25 V", "250 V", "2500 V", "25000 V"],
                        correct: 2,
                        explanation: "2.5 kV  1000 = 2500 V. Para convertir kV a V multiplicamos por 1000."
                    },
                    {
                        question: "驴Cu谩ntos ohmios son 3.2 kiloohmios?",
                        options: ["32 惟", "320 惟", "3200 惟", "32000 惟"],
                        correct: 2,
                        explanation: "3.2 k惟  1000 = 3200 惟. Para convertir k惟 a 惟 multiplicamos por 1000."
                    },
                    {
                        question: "驴Qu茅 prefijo representa 1/1000 de la unidad?",
                        options: ["kilo (k)", "mega (M)", "mili (m)", "micro (渭)"],
                        correct: 2,
                        explanation: "El prefijo 'mili' (m) representa 1/1000 de la unidad base."
                    },
                    {
                        question: "驴Qu茅 prefijo representa 1000 veces la unidad?",
                        options: ["mili (m)", "kilo (k)", "mega (M)", "micro (渭)"],
                        correct: 1,
                        explanation: "El prefijo 'kilo' (k) representa 1000 veces la unidad base."
                    },
                    {
                        question: "Un LED consume 20 mA. 驴Cu谩ntos LEDs necesitas para consumir 1 A?",
                        options: ["20 LEDs", "50 LEDs", "100 LEDs", "200 LEDs"],
                        correct: 1,
                        explanation: "1 A = 1000 mA. Entonces 1000 mA 梅 20 mA = 50 LEDs."
                    },
                    {
                        question: "驴Cu谩l es la conversi贸n correcta de 0.025 A?",
                        options: ["25 mA", "2.5 mA", "250 mA", "0.25 mA"],
                        correct: 0,
                        explanation: "0.025 A  1000 = 25 mA. Para convertir A a mA multiplicamos por 1000."
                    },
                    
                    // === MEDICIN PRCTICA (5 preguntas) ===
                    {
                        question: "Para medir corriente con un mult铆metro, 驴c贸mo debes conectarlo?",
                        options: ["En paralelo", "En serie", "Solo positivo", "Solo negativo"],
                        correct: 1,
                        explanation: "Para medir corriente, el mult铆metro debe ir en serie, interrumpiendo el circuito."
                    },
                    {
                        question: "Para medir voltaje con un mult铆metro, 驴c贸mo debes conectarlo?",
                        options: ["En serie", "En paralelo", "Interrumpiendo el circuito", "Solo un cable"],
                        correct: 1,
                        explanation: "Para medir voltaje, el mult铆metro va en paralelo, sin interrumpir el circuito."
                    },
                    {
                        question: "驴Cu谩ndo es seguro medir resistencia con un mult铆metro?",
                        options: ["Con el circuito energizado", "Solo con circuito apagado", "Con poca corriente", "Siempre es seguro"],
                        correct: 1,
                        explanation: "Solo se debe medir resistencia con el circuito completamente apagado y sin energ铆a."
                    },
                    {
                        question: "驴Qu茅 sucede si mides corriente en paralelo por error?",
                        options: ["Nada malo", "Se quema el fusible del mult铆metro", "Se rompe el circuito", "Se mide mal"],
                        correct: 1,
                        explanation: "Medir corriente en paralelo crea un cortocircuito que quema el fusible del mult铆metro."
                    },
                    {
                        question: "驴Cu谩l es el s铆mbolo el茅ctrico de una resistencia?",
                        options: ["Una l铆nea recta", "Un zigzag", "Un c铆rculo", "Un tri谩ngulo"],
                        correct: 1,
                        explanation: "El s铆mbolo de una resistencia es un zigzag (帮) en los esquemas el茅ctricos."
                    },
                    
                    // === APLICACIONES COTIDIANAS (5 preguntas) ===
                    {
                        question: "驴Cu谩l es el voltaje t铆pico de las pilas AA?",
                        options: ["1.5 V", "3 V", "9 V", "12 V"],
                        correct: 0,
                        explanation: "Las pilas AA comunes tienen 1.5 V cada una."
                    },
                    {
                        question: "驴Qu茅 voltaje encontramos en los tomacorrientes de casa?",
                        options: ["12 V", "24 V", "110-220 V", "1000 V"],
                        correct: 2,
                        explanation: "Los tomacorrientes dom茅sticos tienen 110V o 220V dependiendo del pa铆s."
                    },
                    {
                        question: "驴Cu谩nta corriente consume t铆picamente un LED?",
                        options: ["20 mA", "2 A", "20 A", "200 A"],
                        correct: 0,
                        explanation: "Un LED t铆pico consume alrededor de 20 miliamperios (20 mA)."
                    },
                    {
                        question: "驴Qu茅 voltaje usa el sistema el茅ctrico de un autom贸vil?",
                        options: ["6 V", "12 V", "24 V", "110 V"],
                        correct: 1,
                        explanation: "Los autom贸viles usan un sistema el茅ctrico de 12 voltios."
                    },
                    {
                        question: "驴Cu谩l consume m谩s corriente?",
                        options: ["Un LED", "Un cargador de celular", "Una plancha el茅ctrica", "Un reloj digital"],
                        correct: 2,
                        explanation: "Una plancha el茅ctrica consume mucha m谩s corriente (unos 10A) que los otros dispositivos."
                    },
                    
                    // === SEGURIDAD ELCTRICA (5 preguntas) ===
                    {
                        question: "驴Cu谩l es la regla m谩s importante en seguridad el茅ctrica?",
                        options: ["Trabajar r谩pido", "Usar guantes", "Apagar la energ铆a antes de trabajar", "Trabajar solo"],
                        correct: 2,
                        explanation: "Siempre apagar la energ铆a antes de trabajar es la regla #1 de seguridad el茅ctrica."
                    },
                    {
                        question: "驴Qu茅 NO debes usar para apagar un fuego el茅ctrico?",
                        options: ["Extintor CO2", "Agua", "Extintor de polvo qu铆mico", "Arena seca"],
                        correct: 1,
                        explanation: "NUNCA uses agua en fuegos el茅ctricos porque el agua conduce electricidad."
                    },
                    {
                        question: "驴Qu茅 voltaje se considera generalmente seguro al tocar?",
                        options: ["110 V", "50 V", "24 V", "Menos de 12 V"],
                        correct: 3,
                        explanation: "Voltajes menores a 12V generalmente se consideran seguros al contacto directo."
                    },
                    {
                        question: "Si alguien recibe una descarga el茅ctrica, 驴qu茅 debes hacer PRIMERO?",
                        options: ["Tocarlo para ayudarlo", "Cortar la energ铆a el茅ctrica", "Echarle agua", "Llamar emergencias"],
                        correct: 1,
                        explanation: "Primero corta la energ铆a. Nunca toques directamente a alguien que est谩 recibiendo descarga."
                    },
                    {
                        question: "驴Por qu茅 es peligroso trabajar con manos mojadas?",
                        options: ["Se resbalan las herramientas", "El agua reduce la resistencia del cuerpo", "Se oxidan los metales", "Se ve mal"],
                        correct: 1,
                        explanation: "El agua reduce dram谩ticamente la resistencia de tu cuerpo, aumentando el riesgo de descarga."
                    }
                ];
                
                this.concepts = [
                    {
                        title: " Corriente El茅ctrica (I)",
                        description: "Es el flujo de electrones a trav茅s de un conductor. Se mide en Amperios (A).",
                        analogy: "Imagina el agua fluyendo por una tuber铆a. La cantidad de agua que pasa es como la corriente.",
                        icon: ""
                    },
                    {
                        title: " Voltaje (V)",
                        description: "Es la fuerza que impulsa a los electrones. Se mide en Voltios (V).",
                        analogy: "Como la presi贸n del agua en la tuber铆a. Mayor presi贸n = mayor voltaje.",
                        icon: ""
                    },
                    {
                        title: "★ Resistencia (R)",
                        description: "Es la oposici贸n al flujo de corriente. Se mide en Ohmios (惟).",
                        analogy: "Como el grosor de la tuber铆a. Una tuber铆a angosta ofrece m谩s resistencia.",
                        icon: "★"
                    }
                ];
                
                this.init();
            }

            init() {
                // SIEMPRE COMENZAR DESDE CERO - No cargar progreso guardado
                this.clearAllProgress(); // Limpiar cualquier progreso anterior
                this.bindEvents();
                this.startBackgroundEffects();
                
                // Inicializar indicador m贸vil
                setTimeout(() => {
                    this.updateCurrentSessionIndicator(1);
                }, 100);
            }

            bindEvents() {
                // Eventos del teclado para navegaci贸n
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });

                // Eventos de ventana
                window.addEventListener('beforeunload', () => {
                    // DESHABILITADO - No guardar al salir para que siempre inicie desde cero
                    this.log('Saliendo sin guardar - pr贸xima vez iniciar谩 desde cero');
                });

                window.addEventListener('resize', () => {
                    this.handleResize();
                });
            }

            handleResize() {
                // Reajustar canvas de analog铆as si est谩n visibles
                Object.keys(this.analogyAnimations).forEach(index => {
                    if (this.analogyAnimations[index]) {
                        const canvas = document.getElementById(`analogyCanvas${index}`);
                        if (canvas) {
                            // Reajustar tama帽o del canvas
                            const rect = canvas.getBoundingClientRect();
                            canvas.width = Math.min(600, rect.width);
                        }
                    }
                });
            }

            closeAllModals() {
                // Cerrar cualquier modal o overlay abierto
                document.querySelectorAll('.analogy-display').forEach(el => {
                    if (el.style.display !== 'none') {
                        el.style.display = 'none';
                    }
                });
            }

            startBackgroundEffects() {
                // Efectos de part铆culas en el fondo
                setInterval(() => {
                    if (Math.random() > 0.8 && document.getElementById('mainSystem').style.display !== 'none') {
                        this.createParticle();
                    }
                }, 1000);
            }

            createParticle() {
                const particle = document.createElement('div');
                particle.className = 'spark';
                particle.style.position = 'fixed';
                particle.style.width = '3px';
                particle.style.height = '3px';
                particle.style.background = 'var(--primary-green)';
                particle.style.borderRadius = '50%';
                particle.style.left = Math.random() * window.innerWidth + 'px';
                particle.style.top = '-10px';
                particle.style.pointerEvents = 'none';
                particle.style.opacity = '0.7';
                particle.style.boxShadow = '0 0 6px var(--primary-green)';
                document.body.appendChild(particle);
                
                let y = -10;
                const fallSpeed = 1 + Math.random() * 2;
                const sway = Math.random() * 2 - 1;
                let x = parseFloat(particle.style.left);
                
                const fall = setInterval(() => {
                    y += fallSpeed;
                    x += sway;
                    particle.style.top = y + 'px';
                    particle.style.left = x + 'px';
                    particle.style.opacity = (1 - y / window.innerHeight) * 0.7;
                    
                    if (y > window.innerHeight) {
                        clearInterval(fall);
                        particle.remove();
                    }
                }, 16);
            }

            showSession(sessionNum) {
                // Permitir acceso a sesiones completadas o desbloqueadas
                if (!this.unlockedSessions.includes(sessionNum)) {
                    this.showAchievement('Sesi贸n Bloqueada', 'Completa las sesiones anteriores primero');
                    return;
                }

                // Ocultar todas las sesiones
                document.querySelectorAll('.session').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

                // Mostrar sesi贸n seleccionada
                const targetSession = document.getElementById(`session${sessionNum}`);
                const targetNav = document.getElementById(`nav${sessionNum}`);
                
                if (targetSession && targetNav) {
                    targetSession.classList.add('active');
                    targetNav.classList.add('active');
                    this.currentSession = sessionNum;
                    
                    // Actualizar indicador de sesi贸n actual en m贸viles
                    this.updateCurrentSessionIndicator(sessionNum);
                    
                    // Si la sesi贸n ya fue completada, mostrar contenido apropiado
                    this.restoreSessionContent(sessionNum);
                }
            }

            restoreSessionContent(sessionNum) {
                switch(sessionNum) {
                    case 1:
                        if (this.completedActions.has('conceptsStarted')) {
                            // Auto-mostrar el contenido si ya se inici贸 antes
                            setTimeout(() => {
                                if (document.getElementById('conceptsSection').style.display === 'none') {
                                    this.startConcepts();
                                }
                            }, 100);
                        }
                        break;
                        
                    case 2:
                        if (this.completedActions.has('ohmLawStarted')) {
                            setTimeout(() => {
                                if (document.getElementById('ohmCalculator').style.display === 'none') {
                                    this.startOhmLaw();
                                }
                            }, 100);
                        }
                        break;
                        
                    case 3:
                        if (this.completedActions.has('realWorldStarted')) {
                            setTimeout(() => {
                                if (document.getElementById('realWorldProblems').style.display === 'none') {
                                    this.startRealWorldProblems();
                                }
                            }, 100);
                        }
                        break;
                }
            }

            startConcepts() {
                // Verificar si ya se inici贸
                if (this.completedActions.has('conceptsStarted')) {
                    this.showAchievement('Conceptos Ya Iniciados', 'Ya has comenzado el estudio de los conceptos b谩sicos');
                    document.getElementById('conceptsSection').style.display = 'block';
                    return;
                }

                this.completedActions.add('conceptsStarted');
                const conceptsSection = document.getElementById('conceptsSection');
                conceptsSection.style.display = 'block';
                
                let conceptHTML = `
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid var(--primary-green);">
                        <h3 style="color: var(--primary-green); margin-bottom: 15px; text-align: center;"> Programa de Entrenamiento Completo</h3>
                        <p style="text-align: center; margin-bottom: 20px;">
                            Dominar谩s la electricidad paso a paso: desde conceptos b谩sicos hasta aplicaciones del mundo real
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; text-align: center;">
                            <div style="padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 5px;">
                                <strong> Conceptos</strong><br><small>V, I, R</small>
                            </div>
                            <div style="padding: 8px; background: rgba(0, 136, 255, 0.1); border-radius: 5px;">
                                <strong> Unidades</strong><br><small>mA, kV, M惟</small>
                            </div>
                            <div style="padding: 8px; background: rgba(255, 165, 0, 0.1); border-radius: 5px;">
                                <strong> Medici贸n</strong><br><small>Mult铆metros</small>
                            </div>
                            <div style="padding: 8px; background: rgba(255, 0, 136, 0.1); border-radius: 5px;">
                                <strong> Pr谩ctica</strong><br><small>Mundo real</small>
                            </div>
                            <div style="padding: 8px; background: rgba(138, 43, 226, 0.1); border-radius: 5px;">
                                <strong>★ Seguridad</strong><br><small>Protecci贸n</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // === CONCEPTOS BSICOS (EXISTENTE) ===
                conceptHTML += `<h3 style="color: var(--primary-green); margin-bottom: 25px; text-align: center;"> Paso 1: Conceptos Fundamentales</h3>`;
                
                this.concepts.forEach((concept, index) => {
                    conceptHTML += `
                        <div class="concept-card" data-concept="${index}">
                            <h4 class="concept-title">
                                ${concept.icon} ${concept.title}
                            </h4>
                            <p class="concept-description">${concept.description}</p>
                            <div class="concept-analogy">
                                <strong>Analog铆a:</strong> ${concept.analogy}
                            </div>
                            <button class="btn" onclick="game.toggleAnalogy(${index})" id="analogyBtn${index}">
                                Ver Analog铆a Animada
                            </button>
                            <div id="analogy${index}" class="analogy-display" style="display: none; margin-top: 20px; text-align: center;">
                                <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <button class="analogy-control-btn" onclick="game.pauseResumeAnalogy(${index})" id="analogyToggle${index}" style="background: var(--primary-green); color: #000; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: center;">
                                        <span id="analogyIcon${index}">革</span>
                                        <span id="analogyText${index}">Pausar</span>
                                    </button>
                                    <span style="color: #ccc; font-size: 0.9rem;">Haz clic para pausar/reanudar la animaci贸n</span>
                                </div>
                                <canvas id="analogyCanvas${index}" class="analogy-canvas" width="600" height="200"></canvas>
                                ${index === 0 ? `
                                    <div style="margin-top: 15px; background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 10px; border: 1px solid var(--primary-green);">
                                        <h5 style="color: var(--primary-green); margin-bottom: 15px;"> Control Interactivo de Corriente</h5>
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                                            <div style="text-align: center;">
                                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green); font-weight: bold;">Intensidad de Corriente:</label>
                                                <input type="range" id="currentSlider${index}" min="0.1" max="10" step="0.1" value="2.5" 
                                                       style="width: 200px;" onchange="game.updateCurrentAnimation(${index}, this.value)">
                                                <div style="margin-top: 5px;">
                                                    <span id="currentValue${index}" style="color: #fff; font-size: 1.2rem; font-weight: bold;">2.5A</span>
                                                </div>
                                            </div>
                                            <div style="text-align: center; color: #ccc;">
                                                <div style="font-size: 0.9rem; margin-bottom: 5px;">Efectos del flujo:</div>
                                                <div id="currentEffects${index}" style="font-size: 0.8rem; color: var(--primary-blue);">
                                                     Velocidad de electrones: Media<br>
                                                     Cantidad de electrones: Moderada<br>
                                                     Flujo de agua: Moderado
                                                </div>
                                            </div>
                                        </div>
                                        <div style="margin-top: 15px; padding: 15px; background: rgba(0, 255, 136, 0.1); border-radius: 5px; font-size: 0.9rem; color: #fff;">
                                            <strong> Concepto:</strong> La corriente mide cu谩ntos electrones pasan por un punto cada segundo
                                        </div>
                                        <div style="margin-top: 10px; padding: 10px; background: rgba(0, 136, 255, 0.1); border-radius: 5px; font-size: 0.85rem; color: #ccc;">
                                             <strong>Experimenta:</strong> Cambia la corriente y observa c贸mo m谩s electrones = m谩s flujo, igual que m谩s agua = r铆o m谩s caudaloso
                                        </div>
                                    </div>
                                ` : index === 1 ? `
                                    <div style="margin-top: 15px; background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 10px; border: 1px solid var(--primary-green);">
                                        <h5 style="color: var(--primary-green); margin-bottom: 15px;">锔 Control Interactivo del Voltaje</h5>
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                                            <div style="text-align: center;">
                                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green); font-weight: bold;">Voltaje de la Bater铆a:</label>
                                                <input type="range" id="voltageSlider${index}" min="1.5" max="24" step="0.5" value="12" 
                                                       style="width: 200px;" onchange="game.updateVoltageAnimation(${index}, this.value)">
                                                <div style="margin-top: 5px;">
                                                    <span id="voltageValue${index}" style="color: #fff; font-size: 1.2rem; font-weight: bold;">12V</span>
                                                </div>
                                            </div>
                                            <div style="text-align: center; color: #ccc;">
                                                <div style="font-size: 0.9rem; margin-bottom: 5px;">Efectos del cambio:</div>
                                                <div id="voltageEffects${index}" style="font-size: 0.8rem; color: var(--primary-blue);">
                                                     Velocidad de electrones: Normal<br>
                                                     Brillo de bombilla: Medio<br>
                                                     Presi贸n del agua: Alta
                                                </div>
                                            </div>
                                        </div>
                                        <div style="margin-top: 10px; padding: 10px; background: rgba(0, 255, 136, 0.1); border-radius: 5px; font-size: 0.9rem; color: #fff;">
                                             <strong>Experimenta:</strong> Mueve el control y observa c贸mo cambia la velocidad de los electrones, el brillo de la bombilla y la presi贸n del agua
                                        </div>
                                    </div>
                                ` : index === 2 ? `
                                    <div style="margin-top: 15px; background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 10px; border: 1px solid var(--primary-green);">
                                        <h5 style="color: var(--primary-green); margin-bottom: 15px;"> Laboratorio Interactivo de Resistencia</h5>
                                        <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px;">
                                            <div style="display: flex; flex-direction: column; align-items: center;">
                                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green); font-weight: bold; text-align: center;">Resistencia del Material:</label>
                                                <input type="range" id="resistanceSlider${index}" min="10" max="100" step="5" value="50" 
                                                       style="width: 90%; max-width: 200px;" onchange="game.updateResistanceAnimation(${index}, this.value)">
                                                <div style="margin-top: 5px;">
                                                    <span id="resistanceValue${index}" style="color: #fff; font-size: 1.1rem; font-weight: bold;">50惟</span>
                                                </div>
                                            </div>
                                            <div style="display: flex; flex-direction: column; align-items: center;">
                                                <label style="display: block; margin-bottom: 5px; color: var(--primary-blue); font-weight: bold; text-align: center;">Voltaje Aplicado:</label>
                                                <input type="range" id="voltageResistanceSlider${index}" min="3" max="24" step="1" value="12" 
                                                       style="width: 90%; max-width: 200px;" onchange="game.updateVoltageResistance(${index}, this.value)">
                                                <div style="margin-top: 5px;">
                                                    <span id="voltageResistanceValue${index}" style="color: #fff; font-size: 1.1rem; font-weight: bold;">12V</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="text-align: center; margin-bottom: 15px;">
                                            <div style="font-size: 0.9rem; margin-bottom: 8px; color: #ccc;">Efectos observados:</div>
                                            <div id="resistanceEffects${index}" style="font-size: 0.85rem; color: var(--primary-pink); background: rgba(255, 0, 136, 0.1); padding: 10px; border-radius: 8px;">
                                                 Oposici贸n alta<br>
                                                 Corriente: 0.24A<br>
                                                 Potencia: 2.9W<br>
                                                 Calentamiento notable
                                            </div>
                                        </div>
                                        
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                                            <div style="padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 5px; font-size: 0.8rem; color: #fff; text-align: center;">
                                                <strong> Ley de Ohm:</strong><br>I = V 梅 R
                                            </div>
                                            <div style="padding: 8px; background: rgba(255, 136, 0, 0.1); border-radius: 5px; font-size: 0.8rem; color: #fff; text-align: center;">
                                                <strong> Potencia:</strong><br>P = I虏  R
                                            </div>
                                        </div>
                                        
                                        <div style="margin-top: 12px; padding: 10px; background: rgba(0, 136, 255, 0.1); border-radius: 5px; font-size: 0.85rem; color: #ccc; text-align: center;">
                                             <strong>Experimenta:</strong> Mayor resistencia = menor corriente = m谩s calor. Observa la acumulaci贸n de part铆culas y el efecto t茅rmico.
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                // === NUEVA SECCIN: UNIDADES Y CONVERSIONES ===
                conceptHTML += `
                    <div style="margin-top: 40px;">
                        <h3 style="color: var(--primary-blue); margin-bottom: 25px; text-align: center;"> Paso 2: Unidades y Conversiones</h3>
                        <div style="background: rgba(0, 136, 255, 0.1); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--primary-blue);">
                            <h4 style="color: var(--primary-blue); margin-bottom: 15px;"> M煤ltiplos y Subm煤ltiplos</h4>
                            <p style="margin-bottom: 20px;">En electricidad usamos prefijos para manejar n煤meros muy grandes o muy peque帽os:</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                    <h5 style="color: var(--primary-green); margin-bottom: 8px;"> Corriente (A)</h5>
                                    <p style="font-size: 0.9rem;"> mA = miliamperios (1/1000)<br> A = amperios<br> kA = kiloamperios (1000)</p>
                                </div>
                                <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px;">
                                    <h5 style="color: var(--primary-blue); margin-bottom: 8px;"> Voltaje (V)</h5>
                                    <p style="font-size: 0.9rem;"> mV = milivoltios (1/1000)<br> V = voltios<br> kV = kilovoltios (1000)</p>
                                </div>
                                <div style="background: rgba(255, 0, 136, 0.1); padding: 15px; border-radius: 8px;">
                                    <h5 style="color: var(--primary-pink); margin-bottom: 8px;">★ Resistencia (惟)</h5>
                                    <p style="font-size: 0.9rem;"> m惟 = miliohmios (1/1000)<br> 惟 = ohmios<br> k惟 = kiloohmios (1000)<br> M惟 = megaohmios (1,000,000)</p>
                                </div>
                            </div>
                            
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 15px;">М Calculadora de Conversiones</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px;">Valor a convertir:</label>
                                        <input type="number" id="conversionValue" placeholder="Ej: 500" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary-blue); background: rgba(0, 0, 0, 0.7); color: #fff; margin-bottom: 10px;">
                                        <select id="conversionType" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary-blue); background: rgba(0, 0, 0, 0.7); color: #fff;">
                                            <option value="mA_to_A">mA  A</option>
                                            <option value="A_to_mA">A  mA</option>
                                            <option value="mV_to_V">mV  V</option>
                                            <option value="V_to_mV">V  mV</option>
                                            <option value="kV_to_V">kV  V</option>
                                            <option value="V_to_kV">V  kV</option>
                                            <option value="ohm_to_kohm">惟  k惟</option>
                                            <option value="kohm_to_ohm">k惟  惟</option>
                                            <option value="kohm_to_mohm">k惟  M惟</option>
                                            <option value="mohm_to_kohm">M惟  k惟</option>
                                        </select>
                                    </div>
                                    <div>
                                        <button class="btn" onclick="game.convertUnits()" style="width: 100%; margin-bottom: 10px;">Convertir</button>
                                        <div id="conversionResult" style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 5px; min-height: 40px; text-align: center; font-weight: bold;">
                                            Ingresa un valor y selecciona la conversi贸n
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 165, 0, 0.1); border-radius: 5px; text-align: center;">
                                    <strong> Ejemplos:</strong> 500mA = 0.5A | 12000mV = 12V | 2.5k惟 = 2500惟
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // === NUEVA SECCIN: MEDICIN PRCTICA ===
                conceptHTML += `
                    <div style="margin-top: 30px;">
                        <h3 style="color: #ffa500; margin-bottom: 25px; text-align: center;"> Paso 3: Medici贸n Pr谩ctica</h3>
                        <div style="background: rgba(255, 165, 0, 0.1); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #ffa500;">
                            <h4 style="color: #ffa500; margin-bottom: 15px;"> Mult铆metro: Tu Herramienta Principal</h4>
                            <p style="margin-bottom: 20px;">El mult铆metro es como el estetoscopio del electricista. Te permite "escuchar" qu茅 pasa en los circuitos:</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px;">
                                    <h5 style="color: var(--primary-green); margin-bottom: 10px;"> Medir Corriente (A)</h5>
                                    <p style="font-size: 0.9rem; margin-bottom: 10px;">El mult铆metro va EN SERIE (interrumpe el circuito)</p>
                                    <div style="background: rgba(0, 255, 136, 0.1); padding: 8px; border-radius: 5px; font-size: 0.8rem;">
                                        Bater铆a  Mult铆metro  Resistencia  Bater铆a
                                    </div>
                                </div>
                                
                                <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px;">
                                    <h5 style="color: var(--primary-blue); margin-bottom: 10px;"> Medir Voltaje (V)</h5>
                                    <p style="font-size: 0.9rem; margin-bottom: 10px;">El mult铆metro va EN PARALELO (sin interrumpir)</p>
                                    <div style="background: rgba(0, 136, 255, 0.1); padding: 8px; border-radius: 5px; font-size: 0.8rem;">
                                        Conectas + y - del mult铆metro a ambos lados
                                    </div>
                                </div>
                                
                                <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px;">
                                    <h5 style="color: var(--primary-pink); margin-bottom: 10px;">★ Medir Resistencia (惟)</h5>
                                    <p style="font-size: 0.9rem; margin-bottom: 10px;">SOLO con circuito APAGADO (sin energ铆a)</p>
                                    <div style="background: rgba(255, 0, 136, 0.1); padding: 8px; border-radius: 5px; font-size: 0.8rem;">
                                        Conectas directamente al componente aislado
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff0000; margin-bottom: 20px;">
                                <h5 style="color: #ff6666; margin-bottom: 8px;">锔 IMPORTANTE - Errores Comunes:</h5>
                                <ul style="margin-left: 20px; color: #fff;">
                                    <li> <strong>Medir corriente en paralelo</strong>  Quema el fusible del mult铆metro</li>
                                    <li> <strong>Medir resistencia con energ铆a</strong>  Lecturas incorrectas o da帽o</li>
                                    <li> <strong>Siempre verificar el rango</strong>  Empezar con el m谩s alto</li>
                                </ul>
                            </div>
                            
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 10px;"> S铆mbolos El茅ctricos B谩sicos</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; text-align: center;">
                                    <div style="padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;"></div>
                                        <small>Bater铆a</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;"></div>
                                        <small>Bombilla</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;">帮</div>
                                        <small>Resistor</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;"></div>
                                        <small>Interruptor</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;"></div>
                                        <small>Cable</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // === NUEVA SECCIN: APLICACIONES COTIDIANAS ===
                conceptHTML += `
                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--primary-pink); margin-bottom: 25px; text-align: center;"> Paso 4: Electricidad en el Mundo Real</h3>
                        <div style="background: rgba(255, 0, 136, 0.1); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--primary-pink);">
                            <h4 style="color: var(--primary-pink); margin-bottom: 15px;"> Voltajes que Encuentras Diariamente</h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <h5 style="color: var(--primary-green); margin-bottom: 8px;">1.5V - 9V</h5>
                                    <p style="font-size: 0.9rem;"> Pilas y bater铆as<br> Electr贸nicos peque帽os<br> Controles remotos</p>
                                    <div style="margin-top: 8px; color: var(--primary-green); font-weight: bold;"> Seguro al tocar</div>
                                </div>
                                
                                <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <h5 style="color: var(--primary-blue); margin-bottom: 8px;">12V</h5>
                                    <p style="font-size: 0.9rem;"> Autos y motos<br> LEDs de 12V<br> Audio del carro</p>
                                    <div style="margin-top: 8px; color: #ffa500; font-weight: bold;">锔 Cuidado en agua</div>
                                </div>
                                
                                <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <h5 style="color: #ffa500; margin-bottom: 8px;">110V - 220V</h5>
                                    <p style="font-size: 0.9rem;"> Tomacorrientes casa<br> Electrodom茅sticos<br> Iluminaci贸n</p>
                                    <div style="margin-top: 8px; color: #ff6666; font-weight: bold;">锔 PELIGROSO</div>
                                </div>
                                
                                <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <h5 style="color: #ff6666; margin-bottom: 8px;">Miles de V</h5>
                                    <p style="font-size: 0.9rem;"> Torres el茅ctricas<br> Industria pesada<br> Trenes el茅ctricos</p>
                                    <div style="margin-top: 8px; color: #ff0000; font-weight: bold;">锔 MORTAL</div>
                                </div>
                            </div>
                            
                            <h4 style="color: var(--primary-pink); margin-bottom: 15px; margin-top: 25px;"> Corrientes T铆picas</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px;">
                                    <h5 style="color: var(--primary-blue); margin-bottom: 10px;">mA (Miliamperios)</h5>
                                    <ul style="margin-left: 15px; font-size: 0.9rem;">
                                        <li> LED: 20mA</li>
                                        <li> Cargador en espera: 50mA</li>
                                        <li> Aud铆fonos: 100mA</li>
                                        <li> Reloj digital: 5mA</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px;">
                                    <h5 style="color: var(--primary-green); margin-bottom: 10px;">A (Amperios)</h5>
                                    <ul style="margin-left: 15px; font-size: 0.9rem;">
                                        <li> Bombilla: 0.5A</li>
                                        <li> Cargador de celular: 2A</li>
                                        <li> Plancha: 10A</li>
                                        <li>锔 Nevera: 5A</li>
                                        <li> Motor de arranque: 100A</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; margin-top: 20px;">
                                <h5 style="color: #ffa500; margin-bottom: 10px;"> Datos Curiosos</h5>
                                <ul style="margin-left: 15px; color: #fff;">
                                    <li> Tu cuerpo tiene resistencia de ~1000惟 (piel seca) a ~100惟 (piel mojada)</li>
                                    <li> Tu cerebro funciona con ~20 watts (como una bombilla LED)</li>
                                    <li> Un rayo puede tener hasta 30,000A por una fracci贸n de segundo</li>
                                    <li> La anguila el茅ctrica genera hasta 600V</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                // === NUEVA SECCIN: SEGURIDAD BSICA ===
                conceptHTML += `
                    <div style="margin-top: 30px;">
                        <h3 style="color: #ff6666; margin-bottom: 25px; text-align: center;">★ Paso 5: Seguridad El茅ctrica</h3>
                        <div style="background: rgba(255, 0, 0, 0.1); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #ff6666;">
                            <div style="background: rgba(255, 0, 0, 0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #ff0000;">
                                <h4 style="color: #ff6666; margin-bottom: 15px;">锔 REGLA DE ORO: Nunca subestimes la electricidad</h4>
                                <p style="font-size: 1.1rem; font-weight: bold; color: #fff; text-align: center;">
                                    "No es el voltaje el que mata, es la corriente. Pero el voltaje es lo que empuja esa corriente."
                                </p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <div style="background: rgba(255, 0, 0, 0.15); padding: 20px; border-radius: 10px;">
                                    <h5 style="color: #ff6666; margin-bottom: 15px;"> NUNCA Hagas Esto</h5>
                                    <ul style="margin-left: 15px; color: #fff; line-height: 1.8;">
                                        <li> Tocar cables pelados</li>
                                        <li> Trabajar con manos mojadas</li>
                                        <li> Usar herramientas met谩licas sin aislamiento</li>
                                        <li> Sobrecargar tomacorrientes</li>
                                        <li> Ignorar se帽ales de advertencia</li>
                                        <li> Trabajar solo en instalaciones grandes</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(0, 255, 136, 0.15); padding: 20px; border-radius: 10px;">
                                    <h5 style="color: var(--primary-green); margin-bottom: 15px;"> SIEMPRE Haz Esto</h5>
                                    <ul style="margin-left: 15px; color: #fff; line-height: 1.8;">
                                        <li> Apagar la energ铆a antes de trabajar</li>
                                        <li> Usar herramientas aisladas</li>
                                        <li> Verificar voltaje con mult铆metro</li>
                                        <li> Usar zapatos con suela de goma</li>
                                        <li> Trabajar en 谩rea seca</li>
                                        <li> Avisar a otros cuando trabajas</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h5 style="color: #ffa500; margin-bottom: 15px;"> 驴Qu茅 hacer en una Emergencia El茅ctrica?</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h6 style="color: #ff6666; margin-bottom: 10px;"> Si alguien recibe descarga:</h6>
                                        <ol style="margin-left: 20px; color: #fff;">
                                            <li><strong>NO toques</strong> a la persona directamente</li>
                                            <li><strong>Corta la energ铆a</strong> desde el breaker</li>
                                            <li><strong>Usa un objeto aislante</strong> (palo de madera)</li>
                                            <li><strong>Llama emergencias</strong> inmediatamente</li>
                                            <li><strong>RCP</strong> si sabes y es necesario</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h6 style="color: #ff6666; margin-bottom: 10px;"> Si hay fuego el茅ctrico:</h6>
                                        <ol style="margin-left: 20px; color: #fff;">
                                            <li><strong>Corta la energ铆a</strong> si es seguro</li>
                                            <li><strong>NUNCA uses agua</strong> en fuego el茅ctrico</li>
                                            <li><strong>Usa extintor tipo C</strong> (CO2 o polvo qu铆mico)</li>
                                            <li><strong>Evac煤a</strong> si es grande</li>
                                            <li><strong>Llama bomberos</strong></li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 10px;"> Principios de Seguridad</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; text-align: center;">
                                    <div style="padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <strong> Bloqueo</strong><br>
                                        <small>Apagar y bloquear breakers</small>
                                    </div>
                                    <div style="padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <strong>凤 Etiquetado</strong><br>
                                        <small>"Trabajando - No energizar"</small>
                                    </div>
                                    <div style="padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <strong> Verificaci贸n</strong><br>
                                        <small>Probar que no hay voltaje</small>
                                    </div>
                                    <div style="padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <strong> Comunicaci贸n</strong><br>
                                        <small>Avisar al equipo</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Solo mostrar el quiz si no se ha completado
                if (!this.completedActions.has('quizCompleted')) {
                    conceptHTML += `
                        <div class="content-card" style="text-align: center; margin-top: 30px; background: rgba(0, 255, 136, 0.1);">
                            <h3 style="color: var(--primary-green); margin-bottom: 20px;"> Evaluaci贸n Final: Conceptos B谩sicos</h3>
                            <p style="margin-bottom: 20px; color: #ccc;">
                                Has completado el entrenamiento b谩sico completo. Para desbloquear la pr贸xima misi贸n, 
                                demuestra tu dominio de todos los conceptos:
                            </p>
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="color: var(--primary-blue); margin-bottom: 10px;"> Temario de Evaluaci贸n:</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; text-align: center;">
                                    <div style="padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 5px;"> Conceptos V, I, R</div>
                                    <div style="padding: 8px; background: rgba(0, 136, 255, 0.1); border-radius: 5px;"> Conversiones de unidades</div>
                                    <div style="padding: 8px; background: rgba(255, 165, 0, 0.1); border-radius: 5px;"> Medici贸n pr谩ctica</div>
                                    <div style="padding: 8px; background: rgba(255, 0, 136, 0.1); border-radius: 5px;"> Aplicaciones reales</div>
                                    <div style="padding: 8px; background: rgba(138, 43, 226, 0.1); border-radius: 5px;"> Seguridad el茅ctrica</div>
                                </div>
                            </div>
                            <div id="miniQuiz"></div>
                            <button class="btn" onclick="game.startMiniQuiz()" id="startQuizBtn" style="background: var(--primary-green); color: #000; font-size: 1.1rem; padding: 15px 30px;">
                                 Comenzar Evaluaci贸n Completa
                            </button>
                        </div>
                    `;
                } else {
                    conceptHTML += `
                        <div class="content-card" style="text-align: center; margin-top: 30px; background: rgba(0, 255, 136, 0.2);">
                            <h3 style="color: var(--primary-green); margin-bottom: 15px;"> Sesi贸n 1 Completada</h3>
                            <p style="margin-bottom: 20px;">Has dominado todos los conceptos fundamentales de electricidad y aprobado la evaluaci贸n completa.</p>
                            ${this.unlockedSessions.includes(2) ? `
                                <button class="btn" onclick="game.showSession(2)" style="background: var(--primary-green); color: #000;">
                                    Continuar a Sesi贸n 2: Ley de Ohm 
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                document.getElementById('conceptDisplay').innerHTML = conceptHTML;
                this.addProgress('conceptos iniciados');
            }

            toggleAnalogy(index) {
                const analogyDiv = document.getElementById(`analogy${index}`);
                const btn = document.getElementById(`analogyBtn${index}`);
                
                if (!analogyDiv || !btn) return;

                // Verificar si est谩 visible o no
                const isVisible = analogyDiv.style.display !== 'none';

                if (isVisible) {
                    // Ocultar analog铆a
                    analogyDiv.style.display = 'none';
                    
                    // Pausar animaci贸n si est谩 corriendo
                    const state = this.analogyStates[index];
                    if (state && state.isPlaying) {
                        state.isPlaying = false;
                        if (state.animationId) {
                            cancelAnimationFrame(state.animationId);
                            state.animationId = null;
                        }
                    }
                    
                    // Cancelar animaci贸n principal si existe
                    if (this.analogyAnimations[index]) {
                        cancelAnimationFrame(this.analogyAnimations[index]);
                        this.analogyAnimations[index] = null;
                    }
                    
                    // Actualizar bot贸n
                    btn.textContent = 'Ver Analog铆a Animada';
                    btn.style.background = '';
                    btn.style.color = '';
                    
                    this.showAchievement('Analog铆a Ocultada', 'La simulaci贸n se ha ocultado');
                } else {
                    // Mostrar analog铆a
                    analogyDiv.style.display = 'block';
                    
                    // Marcar como vista si es la primera vez
                    if (!this.analogiesViewed.has(index)) {
                        this.analogiesViewed.add(index);
                        this.addProgress('analog铆a vista');
                        this.checkSession1Progress();
                    }
                    
                    // Inicializar estado si no existe
                    if (!this.analogyStates[index]) {
                        this.analogyStates[index] = { 
                            isPlaying: true, 
                            animationId: null 
                        };
                    } else {
                        this.analogyStates[index].isPlaying = true;
                    }
                    
                    // Obtener canvas y context
                    const canvas = document.getElementById(`analogyCanvas${index}`);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        
                        // Iniciar animaci贸n seg煤n el tipo
                        switch(index) {
                            case 0: // Corriente
                                this.animateCurrentAnalogy(ctx, canvas, index);
                                break;
                            case 1: // Voltaje
                                this.animateVoltageAnalogy(ctx, canvas, index);
                                break;
                            case 2: // Resistencia
                                this.animateResistanceAnalogy(ctx, canvas, index);
                                break;
                        }
                    }
                    
                    // Actualizar bot贸n
                    btn.textContent = 'Ocultar Analog铆a';
                    btn.style.background = 'var(--primary-pink)';
                    btn.style.color = '#fff';
                    
                    // Resetear bot贸n de control interno
                    const toggleIcon = document.getElementById(`analogyIcon${index}`);
                    const toggleText = document.getElementById(`analogyText${index}`);
                    const toggleBtn = document.getElementById(`analogyToggle${index}`);
                    
                    if (toggleIcon) toggleIcon.textContent = '革';
                    if (toggleText) toggleText.textContent = 'Pausar';
                    if (toggleBtn) {
                        toggleBtn.style.background = 'var(--primary-green)';
                        toggleBtn.style.color = '#000';
                    }
                    
                    this.showAchievement('Analog铆a Mostrada', 'La simulaci贸n est谩 ahora visible y activa');
                }
            }

            pauseResumeAnalogy(index) {
                const state = this.analogyStates[index];
                if (!state) return;

                const toggleIcon = document.getElementById(`analogyIcon${index}`);
                const toggleText = document.getElementById(`analogyText${index}`);
                const toggleBtn = document.getElementById(`analogyToggle${index}`);

                if (state.isPlaying) {
                    // Pausar animaci贸n
                    state.isPlaying = false;
                    if (state.animationId) {
                        cancelAnimationFrame(state.animationId);
                        state.animationId = null;
                    }
                    
                    // Actualizar UI
                    if (toggleIcon) toggleIcon.textContent = '讹';
                    if (toggleText) toggleText.textContent = 'Reanudar';
                    if (toggleBtn) {
                        toggleBtn.style.background = '#666';
                        toggleBtn.style.color = '#fff';
                    }
                    
                    this.showAchievement('Animaci贸n Pausada', 'La analog铆a se ha pausado');
                } else {
                    // Reanudar animaci贸n
                    state.isPlaying = true;
                    
                    // Actualizar UI
                    if (toggleIcon) toggleIcon.textContent = '革';
                    if (toggleText) toggleText.textContent = 'Pausar';
                    if (toggleBtn) {
                        toggleBtn.style.background = 'var(--primary-green)';
                        toggleBtn.style.color = '#000';
                    }
                    
                    // Reiniciar animaci贸n seg煤n el tipo
                    const canvas = document.getElementById(`analogyCanvas${index}`);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        switch(index) {
                            case 0:
                                this.animateCurrentAnalogy(ctx, canvas, index);
                                break;
                            case 1:
                                this.animateVoltageAnalogy(ctx, canvas, index);
                                break;
                            case 2:
                                this.animateResistanceAnalogy(ctx, canvas, index);
                                break;
                        }
                    }
                    
                    this.showAchievement('Animaci贸n Reanudada', 'La analog铆a se ha reanudado');
                }
            }

            checkSession1Progress() {
                // Verificar si se han visto todas las analog铆as
                const totalConcepts = this.concepts.length;
                
                if (this.analogiesViewed.size >= totalConcepts) {
                    if (!this.completedActions.has('allAnalogiesViewed')) {
                        this.completedActions.add('allAnalogiesViewed');
                        this.showAchievement('隆Conceptos Dominados!', 'Has visto todas las analog铆as. Ahora puedes hacer la evaluaci贸n.');
                    }
                }
            }

            startMiniQuiz() {
                // Verificar si ya se complet贸 el quiz
                if (this.completedActions.has('quizCompleted')) {
                    this.showAchievement('Quiz Ya Completado', 'Ya has completado exitosamente el quiz de la Sesi贸n 1');
                    return;
                }

                // Seleccionar 5 preguntas aleatorias del banco expandido de 30
                const selectedQuestions = this.getRandomQuestions(5);
                this.currentQuiz = selectedQuestions; // Guardar para verificaci贸n

                let quizHTML = `
                    <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--primary-blue);">
                        <h4 style="color: var(--primary-blue); margin-bottom: 15px; text-align: center;"> Evaluaci贸n Integral de Conceptos B谩sicos</h4>
                        <p style="text-align: center; margin-bottom: 15px;">
                            Esta evaluaci贸n cubre <strong>todos los temas</strong> que acabas de estudiar:
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; text-align: center; margin-bottom: 15px;">
                            <div style="padding: 5px; background: rgba(0, 255, 136, 0.1); border-radius: 4px; font-size: 0.8rem;">
                                 Conceptos V, I, R
                            </div>
                            <div style="padding: 5px; background: rgba(0, 136, 255, 0.1); border-radius: 4px; font-size: 0.8rem;">
                                 Conversiones
                            </div>
                            <div style="padding: 5px; background: rgba(255, 165, 0, 0.1); border-radius: 4px; font-size: 0.8rem;">
                                 Medici贸n
                            </div>
                            <div style="padding: 5px; background: rgba(255, 0, 136, 0.1); border-radius: 4px; font-size: 0.8rem;">
                                 Aplicaciones
                            </div>
                            <div style="padding: 5px; background: rgba(138, 43, 226, 0.1); border-radius: 4px; font-size: 0.8rem;">
                                ★ Seguridad
                            </div>
                        </div>
                        <p style="text-align: center; color: #ccc; font-size: 0.9rem;">
                            <strong>5 preguntas aleatorias</strong> de un banco de 30 preguntas
                        </p>
                    </div>
                    <div style="text-align: left;">`;
                
                selectedQuestions.forEach((q, index) => {
                    quizHTML += `
                        <div class="quiz-question" style="margin-bottom: 25px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid var(--primary-green);">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">${index + 1}. ${q.question}</h4>
                            <div class="quiz-options">
                    `;
                    
                    q.options.forEach((option, optIndex) => {
                        // Agregar indicador visual sutil de aleatorizaci贸n
                        const optionLetter = String.fromCharCode(65 + optIndex); // A, B, C, D
                        quizHTML += `
                            <label style="display: block; margin-bottom: 10px; cursor: pointer; padding: 10px; border-radius: 5px; transition: background 0.3s; border: 1px solid transparent;">
                                <input type="radio" name="question${index}" value="${optIndex}" style="margin-right: 10px;">
                                <span style="font-size: 0.95rem;"><strong>${optionLetter})</strong> ${option}</span>
                            </label>
                        `;
                    });
                    
                    quizHTML += `
                            </div>
                            <div id="explanation${index}" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0, 255, 136, 0.1); border-radius: 8px; border-left: 4px solid var(--primary-green);">
                                <strong style="color: var(--primary-green);"> Explicaci贸n:</strong> 
                                <span style="color: #fff;">${q.explanation}</span>
                            </div>
                        </div>
                    `;
                });
                
                quizHTML += `
                    <div style="text-align: center; margin-top: 25px; padding: 20px; background: rgba(0, 136, 255, 0.1); border-radius: 10px;">
                        <p style="margin-bottom: 15px; color: #ccc;">
                            <strong>Responde todas las preguntas y luego env铆a tus respuestas.</strong><br>
                            <small>Necesitas al menos 3 de 5 correctas (60%) para continuar.</small><br>
                            <small style="color: var(--primary-blue);"> Las preguntas cubren todos los conceptos fundamentales de electricidad</small>
                        </p>
                        <button class="btn" onclick="game.submitQuiz()" style="background: var(--primary-blue); color: #fff; font-size: 1.1rem; padding: 15px 30px;">
                             Enviar Respuestas
                        </button>
                    </div>
                </div>`;
                
                document.getElementById('miniQuiz').innerHTML = quizHTML;
                document.getElementById('startQuizBtn').style.display = 'none';
            }

            convertUnits() {
                const value = parseFloat(document.getElementById('conversionValue').value);
                const conversionType = document.getElementById('conversionType').value;
                const resultDiv = document.getElementById('conversionResult');
                
                if (isNaN(value) || value < 0) {
                    resultDiv.innerHTML = '<span style="color: var(--primary-pink);">锔 Ingresa un n煤mero v谩lido</span>';
                    return;
                }
                
                let result, fromUnit, toUnit, factor, resultValue;
                
                switch(conversionType) {
                    case 'mA_to_A':
                        resultValue = value / 1000;
                        fromUnit = 'mA';
                        toUnit = 'A';
                        factor = '梅 1000';
                        break;
                    case 'A_to_mA':
                        resultValue = value * 1000;
                        fromUnit = 'A';
                        toUnit = 'mA';
                        factor = ' 1000';
                        break;
                    case 'mV_to_V':
                        resultValue = value / 1000;
                        fromUnit = 'mV';
                        toUnit = 'V';
                        factor = '梅 1000';
                        break;
                    case 'V_to_mV':
                        resultValue = value * 1000;
                        fromUnit = 'V';
                        toUnit = 'mV';
                        factor = ' 1000';
                        break;
                    case 'kV_to_V':
                        resultValue = value * 1000;
                        fromUnit = 'kV';
                        toUnit = 'V';
                        factor = ' 1000';
                        break;
                    case 'V_to_kV':
                        resultValue = value / 1000;
                        fromUnit = 'V';
                        toUnit = 'kV';
                        factor = '梅 1000';
                        break;
                    case 'ohm_to_kohm':
                        resultValue = value / 1000;
                        fromUnit = '惟';
                        toUnit = 'k惟';
                        factor = '梅 1000';
                        break;
                    case 'kohm_to_ohm':
                        resultValue = value * 1000;
                        fromUnit = 'k惟';
                        toUnit = '惟';
                        factor = ' 1000';
                        break;
                    case 'kohm_to_mohm':
                        resultValue = value / 1000;
                        fromUnit = 'k惟';
                        toUnit = 'M惟';
                        factor = '梅 1000';
                        break;
                    case 'mohm_to_kohm':
                        resultValue = value * 1000;
                        fromUnit = 'M惟';
                        toUnit = 'k惟';
                        factor = ' 1000';
                        break;
                    default:
                        resultDiv.innerHTML = '<span style="color: var(--primary-pink);"> Tipo de conversi贸n no v谩lido</span>';
                        return;
                }
                
                const formattedResult = Number.isInteger(resultValue) ? resultValue.toString() : resultValue.toFixed(3);
                
                resultDiv.innerHTML = `
                    <div style="color: var(--primary-green); font-size: 1.1rem;">
                        <strong>${value} ${fromUnit} = ${formattedResult} ${toUnit}</strong>
                    </div>
                    <div style="color: #ccc; font-size: 0.9rem; margin-top: 5px;">
                        Operaci贸n: ${value} ${factor} = ${formattedResult}
                    </div>
                `;
                
                // Marcar como conversi贸n completada para el progreso
                if (!this.completedActions.has('conversionUsed')) {
                    this.completedActions.add('conversionUsed');
                    this.addProgress('conversi贸n de unidades usada');
                    this.showAchievement('隆Conversi贸n Realizada!', `Has convertido ${value} ${fromUnit} a ${formattedResult} ${toUnit}`);
                }
            }

            getRandomQuestions(count) {
                // Crear una copia del banco de preguntas para no modificar el original
                const availableQuestions = [...this.questionBank];
                const selectedQuestions = [];
                
                // Seleccionar preguntas aleatorias sin repetir
                for (let i = 0; i < count && availableQuestions.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                    const selectedQuestion = availableQuestions.splice(randomIndex, 1)[0];
                    
                    // Randomizar el orden de las opciones
                    const randomizedQuestion = this.randomizeQuestionOptions(selectedQuestion);
                    selectedQuestions.push(randomizedQuestion);
                }
                
                return selectedQuestions;
            }

            randomizeQuestionOptions(question) {
                // Crear arrays con las opciones y sus 铆ndices originales
                const optionsWithIndices = question.options.map((option, index) => ({
                    text: option,
                    originalIndex: index
                }));
                
                // Mezclar las opciones usando algoritmo Fisher-Yates
                for (let i = optionsWithIndices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [optionsWithIndices[i], optionsWithIndices[j]] = [optionsWithIndices[j], optionsWithIndices[i]];
                }
                
                // Crear la nueva pregunta con opciones mezcladas
                const shuffledQuestion = {
                    ...question,
                    options: optionsWithIndices.map(item => item.text),
                    // Encontrar la nueva posici贸n de la respuesta correcta
                    correct: optionsWithIndices.findIndex(item => item.originalIndex === question.correct)
                };
                
                return shuffledQuestion;
            }

            submitQuiz() {
                let correctAnswers = 0;
                const totalQuestions = this.currentQuiz.length;
                
                this.currentQuiz.forEach((q, index) => {
                    const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                    const explanationDiv = document.getElementById(`explanation${index}`);
                    const questionDiv = document.querySelector(`input[name="question${index}"]`).closest('.quiz-question');
                    
                    if (selectedOption) {
                        const selectedValue = parseInt(selectedOption.value);
                        const label = selectedOption.parentElement;
                        
                        if (selectedValue === q.correct) {
                            correctAnswers++;
                            label.style.background = 'rgba(0, 255, 136, 0.3)';
                            label.style.border = '2px solid var(--primary-green)';
                            label.style.color = '#fff';
                        } else {
                            label.style.background = 'rgba(255, 0, 136, 0.3)';
                            label.style.border = '2px solid var(--primary-pink)';
                            label.style.color = '#fff';
                        }
                    }
                    
                    // Mostrar explicaci贸n
                    explanationDiv.style.display = 'block';
                    
                    // Resaltar respuesta correcta si no fue seleccionada
                    const allLabels = questionDiv.querySelectorAll('label');
                    allLabels[q.correct].style.border = '2px solid var(--primary-green)';
                    if (!selectedOption || parseInt(selectedOption.value) !== q.correct) {
                        allLabels[q.correct].style.background = 'rgba(0, 255, 136, 0.2)';
                        allLabels[q.correct].innerHTML = ' ' + allLabels[q.correct].innerHTML;
                    }
                });
                
                const percentage = (correctAnswers / totalQuestions) * 100;
                
                // Mostrar resultado inmediato
                const resultMessage = document.createElement('div');
                resultMessage.style.cssText = `
                    text-align: center; 
                    margin-top: 20px; 
                    padding: 20px; 
                    border-radius: 10px; 
                    font-size: 1.2rem; 
                    font-weight: bold;
                    border: 2px solid;
                `;
                
                if (percentage >= 60) { // 3 de 5 o mejor (60%)
                    resultMessage.style.background = 'rgba(0, 255, 136, 0.2)';
                    resultMessage.style.borderColor = 'var(--primary-green)';
                    resultMessage.style.color = 'var(--primary-green)';
                    resultMessage.innerHTML = `
                         隆Excelente! ${correctAnswers}/${totalQuestions} respuestas correctas (${percentage.toFixed(1)}%)<br>
                        <span style="font-size: 1rem; color: #fff;">Has aprobado la evaluaci贸n completa. 隆Prepar谩ndote para la Ley de Ohm!</span>
                    `;
                } else {
                    resultMessage.style.background = 'rgba(255, 0, 136, 0.2)';
                    resultMessage.style.borderColor = 'var(--primary-pink)';
                    resultMessage.style.color = 'var(--primary-pink)';
                    resultMessage.innerHTML = `
                         Resultado: ${correctAnswers}/${totalQuestions} respuestas correctas (${percentage.toFixed(1)}%)<br>
                        <span style="font-size: 1rem; color: #fff;">Necesitas al menos 60% para continuar. 隆Revisa las explicaciones y vuelve a intentar!</span>
                    `;
                }
                
                document.getElementById('miniQuiz').appendChild(resultMessage);
                
                setTimeout(() => {
                    if (percentage >= 60) {
                        this.completedActions.add('quizCompleted');
                        this.completeSession1();
                    } else {
                        this.showAchievement('隆Sigue Estudiando!', `Obtuviste ${correctAnswers}/${totalQuestions} correctas. Revisa todos los conceptos y las explicaciones.`);
                        
                        // Agregar bot贸n para reintentar
                        setTimeout(() => {
                            const retryButton = document.createElement('div');
                            retryButton.style.cssText = 'text-align: center; margin-top: 15px;';
                            retryButton.innerHTML = `
                                <button class="btn" onclick="location.reload()" style="background: var(--primary-blue); color: #fff;">
                                     Intentar con Nuevas Preguntas
                                </button>
                            `;
                            resultMessage.appendChild(retryButton);
                        }, 1000);
                    }
                }, 1000);
            }

            completeSession1() {
                // Verificar si ya se complet贸 esta sesi贸n
                if (this.sessionsCompleted.has(1)) {
                    this.showAchievement('Sesi贸n Ya Completada', 'Ya has completado la Sesi贸n 1 anteriormente');
                    return;
                }

                this.log('Completando Sesi贸n 1...');

                // Marcar sesi贸n como completada
                this.sessionsCompleted.add(1);

                // Desbloquear sesi贸n 2
                if (!this.unlockedSessions.includes(2)) {
                    this.unlockedSessions.push(2);
                    const nav2 = document.getElementById('nav2');
                    if (nav2) {
                        nav2.classList.remove('locked');
                    }
                    this.log('Sesi贸n 2 desbloqueada');
                }
                
                this.addProgress('sesi贸n 1 completada');
                this.updateProgress();
                // NO GUARDAR - Para que siempre inicie desde cero
                
                this.showAchievement('隆Sesi贸n 1 Completada!', '隆Excelente! Has dominado todos los fundamentos de electricidad. Sesi贸n 2 desbloqueada.');
                
                // Mostrar opci贸n de continuar
                setTimeout(() => {
                    const continueHTML = `
                        <div style="text-align: center; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 136, 255, 0.2)); border-radius: 15px; border: 2px solid var(--primary-green);">
                            <h3 style="color: var(--primary-green); margin-bottom: 15px;"> 隆Entrenamiento B谩sico Completado!</h3>
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="color: var(--primary-blue); margin-bottom: 15px;"> Has Dominado:</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; text-align: center;">
                                    <div style="padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 5px;">
                                        <strong> Conceptos</strong><br><small>V, I, R y analog铆as</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(0, 136, 255, 0.1); border-radius: 5px;">
                                        <strong> Unidades</strong><br><small>mA, kV, M惟</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(255, 165, 0, 0.1); border-radius: 5px;">
                                        <strong> Medici贸n</strong><br><small>Mult铆metros</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(255, 0, 136, 0.1); border-radius: 5px;">
                                        <strong> Pr谩ctica</strong><br><small>Mundo real</small>
                                    </div>
                                    <div style="padding: 8px; background: rgba(138, 43, 226, 0.1); border-radius: 5px;">
                                        <strong>★ Seguridad</strong><br><small>Protecci贸n</small>
                                    </div>
                                </div>
                            </div>
                            <p style="margin-bottom: 20px;">Ahora tienes una base s贸lida para aprender la f贸rmula m谩s importante de la electricidad.</p>
                            <button class="btn" onclick="game.showSession(2)" style="background: var(--primary-green); color: #000; font-size: 1.2rem; padding: 15px 30px;">
                                Continuar a la Sesi贸n 2: Ley de Ohm 
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('conceptDisplay').innerHTML += continueHTML;
                }, 1500);
            }

            // Funciones para la Sesi贸n 2
            startOhmLaw() {
                // Verificar si ya se inici贸
                if (this.completedActions.has('ohmLawStarted')) {
                    this.showAchievement('Ya Iniciado', 'Ya has comenzado el estudio de la Ley de Ohm');
                    return;
                }

                this.completedActions.add('ohmLawStarted');
                document.getElementById('ohmCalculator').style.display = 'block';
                this.createOhmCalculator();
                this.addProgress('ley de Ohm iniciada');
            }

            createOhmCalculator() {
                const calculatorHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                        <div style="background: rgba(0, 0, 0, 0.5); padding: 25px; border-radius: 15px;">
                            <h4 style="color: var(--primary-green); text-align: center; margin-bottom: 20px;">М Calculadora V = I  R</h4>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green);">Voltaje (V):</label>
                                <input type="number" id="voltage" placeholder="Ingresa voltaje" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-blue);">Corriente (I):</label>
                                <input type="number" id="current" placeholder="Ingresa corriente" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-blue); background: rgba(0, 0, 0, 0.7); color: #fff;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-pink);">Resistencia (R):</label>
                                <input type="number" id="resistance" placeholder="Ingresa resistencia" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-pink); background: rgba(0, 0, 0, 0.7); color: #fff;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="btn" onclick="game.calculateOhm('voltage')">Calcular V</button>
                                <button class="btn" onclick="game.calculateOhm('current')">Calcular I</button>
                                <button class="btn" onclick="game.calculateOhm('resistance')" style="grid-column: 1 / -1;">Calcular R</button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.5); padding: 25px; border-radius: 15px;">
                            <h4 style="color: var(--primary-green); text-align: center; margin-bottom: 20px;"> Resultado</h4>
                            <div id="calculationResult" style="text-align: center; font-size: 1.2rem; color: #fff; min-height: 100px; display: flex; align-items: center; justify-content: center;">
                                Ingresa dos valores y selecciona qu茅 calcular
                            </div>
                            <div id="calculationSteps" style="margin-top: 20px; padding: 15px; background: rgba(0, 255, 136, 0.1); border-radius: 10px; display: none;">
                                <h5 style="color: var(--primary-green); margin-bottom: 10px;">Pasos del c谩lculo:</h5>
                                <div id="stepsContent"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="game.showOhmExercises()" style="background: var(--primary-blue); color: #fff;">
                            Practicar con Ejercicios 
                        </button>
                    </div>
                `;
                
                document.getElementById('calculatorContent').innerHTML = calculatorHTML;
            }

            calculateOhm(calculate) {
                const voltage = parseFloat(document.getElementById('voltage').value) || 0;
                const current = parseFloat(document.getElementById('current').value) || 0;
                const resistance = parseFloat(document.getElementById('resistance').value) || 0;
                
                let result = '';
                let steps = '';
                let isValid = false;
                
                // Crear clave 煤nica para este c谩lculo
                const calculationKey = `calc_${calculate}_${voltage}_${current}_${resistance}`;
                
                // Funci贸n helper para formatear n煤meros
                const formatNumber = (num) => {
                    return Number.isInteger(num) ? num.toString() : num.toFixed(2);
                };

                switch(calculate) {
                    case 'voltage':
                        if (current && resistance) {
                            const calculatedV = current * resistance;
                            const formattedV = formatNumber(calculatedV);
                            result = `V = I  R = ${current} A  ${resistance} 惟 = ${formattedV} V`;
                            steps = `
                                <p>1. F贸rmula: V = I  R</p>
                                <p>2. Sustituci贸n: V = ${current}  ${resistance}</p>
                                <p>3. Resultado: V = ${formattedV} Voltios</p>
                            `;
                            isValid = true;
                        } else {
                            result = 'Necesitas ingresar valores de Corriente y Resistencia';
                        }
                        break;
                        
                    case 'current':
                        if (voltage && resistance) {
                            const calculatedI = voltage / resistance;
                            const formattedI = formatNumber(calculatedI);
                            result = `I = V 梅 R = ${voltage} V 梅 ${resistance} 惟 = ${formattedI} A`;
                            steps = `
                                <p>1. F贸rmula: I = V 梅 R</p>
                                <p>2. Sustituci贸n: I = ${voltage} 梅 ${resistance}</p>
                                <p>3. Resultado: I = ${formattedI} Amperios</p>
                            `;
                            isValid = true;
                        } else {
                            result = 'Necesitas ingresar valores de Voltaje y Resistencia';
                        }
                        break;
                        
                    case 'resistance':
                        if (voltage && current) {
                            const calculatedR = voltage / current;
                            const formattedR = formatNumber(calculatedR);
                            result = `R = V 梅 I = ${voltage} V 梅 ${current} A = ${formattedR} 惟`;
                            steps = `
                                <p>1. F贸rmula: R = V 梅 I</p>
                                <p>2. Sustituci贸n: R = ${voltage} 梅 ${current}</p>
                                <p>3. Resultado: R = ${formattedR} Ohmios</p>
                            `;
                            isValid = true;
                        } else {
                            result = 'Necesitas ingresar valores de Voltaje y Corriente';
                        }
                        break;
                }
                
                document.getElementById('calculationResult').innerHTML = result;
                
                if (isValid) {
                    document.getElementById('stepsContent').innerHTML = steps;
                    document.getElementById('calculationSteps').style.display = 'block';
                    
                    // Solo dar puntos si es un c谩lculo nuevo
                    if (!this.completedActions.has(calculationKey)) {
                        this.completedActions.add(calculationKey);
                        this.addProgress('c谩lculo completado');
                    }
                } else {
                    document.getElementById('calculationSteps').style.display = 'none';
                }
            }

            showOhmExercises() {
                // Verificar si ya se mostraron los ejercicios
                if (this.completedActions.has('exercisesShown')) {
                    this.showAchievement('Ejercicios Ya Disponibles', 'Los ejercicios ya est谩n disponibles m谩s abajo');
                    return;
                }

                this.completedActions.add('exercisesShown');
                document.getElementById('ohmExercises').style.display = 'block';
                this.createOhmExercises();
            }

            createOhmExercises() {
                const exercises = [
                    {
                        problem: "Un circuito tiene una resistencia de 10惟 y una corriente de 2A. 驴Cu谩l es el voltaje?",
                        answer: 20,
                        unit: "V",
                        hint: "Usa la f贸rmula V = I  R"
                    },
                    {
                        problem: "Si aplicamos 12V a una resistencia de 4惟, 驴cu谩l ser谩 la corriente?",
                        answer: 3,
                        unit: "A", 
                        hint: "Usa la f贸rmula I = V 梅 R"
                    },
                    {
                        problem: "Una bombilla consume 0.5A con 110V. 驴Cu谩l es su resistencia?",
                        answer: 220,
                        unit: "惟",
                        hint: "Usa la f贸rmula R = V 梅 I"
                    }
                ];

                let exercisesHTML = '<div style="display: grid; gap: 25px;">';
                
                exercises.forEach((exercise, index) => {
                    exercisesHTML += `
                        <div style="background: rgba(0, 0, 0, 0.5); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-green);">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">Ejercicio ${index + 1}</h4>
                            <p style="margin-bottom: 15px; font-size: 1.1rem;">${exercise.problem}</p>
                            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                                <input type="number" id="exercise${index}" placeholder="Tu respuesta" style="flex: 1; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff;">
                                <span style="color: #ccc;">${exercise.unit}</span>
                                <button class="btn" onclick="game.checkExercise(${index}, ${exercise.answer}, '${exercise.unit}')" style="padding: 10px 20px;">Verificar</button>
                            </div>
                            <div id="hint${index}" style="color: var(--primary-blue); font-style: italic; margin-bottom: 10px;"> ${exercise.hint}</div>
                            <div id="result${index}" style="display: none;"></div>
                        </div>
                    `;
                });
                
                exercisesHTML += `
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="game.completeSession2()" id="completeSession2Btn" style="display: none; background: var(--primary-green); color: #000; font-size: 1.2rem;">
                            隆Completar Sesi贸n 2! 
                        </button>
                    </div>
                </div>`;
                
                document.getElementById('exercisesContent').innerHTML = exercisesHTML;
            }

            checkExercise(index, correctAnswer, unit) {
                // Verificar si ya se resolvi贸 correctamente este ejercicio
                if (this.exercisesCompleted.has(index)) {
                    this.showAchievement('Ejercicio Ya Resuelto', `Ya resolviste correctamente el ejercicio ${index + 1}`);
                    return;
                }

                const userAnswer = parseFloat(document.getElementById(`exercise${index}`).value);
                const resultDiv = document.getElementById(`result${index}`);
                
                if (Math.abs(userAnswer - correctAnswer) < 0.1) {
                    resultDiv.innerHTML = `<p style="color: var(--primary-green); font-weight: bold;"> 隆Correcto! La respuesta es ${correctAnswer} ${unit}</p>`;
                    resultDiv.style.display = 'block';
                    
                    // Marcar como completado y dar puntos solo una vez
                    this.exercisesCompleted.add(index);
                    this.addProgress('ejercicio completado');
                    
                    // Deshabilitar el input y bot贸n
                    document.getElementById(`exercise${index}`).disabled = true;
                    document.querySelector(`button[onclick*="checkExercise(${index}"]`).disabled = true;
                    document.querySelector(`button[onclick*="checkExercise(${index}"]`).style.background = 'var(--primary-green)';
                    document.querySelector(`button[onclick*="checkExercise(${index}"]`).style.color = '#000';
                    document.querySelector(`button[onclick*="checkExercise(${index}"]`).textContent = ' Correcto';
                    
                } else {
                    resultDiv.innerHTML = `<p style="color: var(--primary-pink); font-weight: bold;"> Incorrecto. La respuesta correcta es ${correctAnswer} ${unit}. 隆Int茅ntalo de nuevo!</p>`;
                    resultDiv.style.display = 'block';
                    
                    // Marcar como intentado (para el conteo)
                    if (!this.completedActions.has(`exercise_attempted_${index}`)) {
                        this.completedActions.add(`exercise_attempted_${index}`);
                    }
                }
                
                // Verificar si se completaron todos los ejercicios despu茅s de cada intento
                this.checkAllExercisesCompleted();
            }

            checkAllExercisesCompleted() {
                const totalExercises = 3;
                const exercisesCorrect = this.exercisesCompleted.size;
                
                // Contar ejercicios intentados (correctos + incorrectos)
                let exercisesAttempted = exercisesCorrect;
                for (let i = 0; i < totalExercises; i++) {
                    if (this.completedActions.has(`exercise_attempted_${i}`) && !this.exercisesCompleted.has(i)) {
                        exercisesAttempted++;
                    }
                }
                
                this.log(`Ejercicios: ${exercisesCorrect} correctos, ${exercisesAttempted} intentados de ${totalExercises} totales`);
                
                // Mostrar bot贸n de completar solo si:
                // 1. Se han intentado los 3 ejercicios Y se tienen al menos 2 correctos
                // 2. O se han completado correctamente los 3 ejercicios
                if ((exercisesAttempted >= totalExercises && exercisesCorrect >= 2) || exercisesCorrect >= totalExercises) {
                    if (!this.completedActions.has('exercisesCompleted')) {
                        this.completedActions.add('exercisesCompleted');
                        this.showExerciseStats(exercisesCorrect, totalExercises);
                    }
                }
            }

            showExerciseStats(exercisesCorrect, totalExercises) {
                // Mostrar estad铆sticas detalladas
                const statsHTML = `
                    <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 15px; margin: 20px 0; border: 1px solid var(--primary-blue);">
                        <h4 style="color: var(--primary-blue); margin-bottom: 15px; text-align: center;"> Estad铆sticas de la Sesi贸n 2</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 5px;"> Ley de Ohm</h5>
                                <p style="color: #fff; margin: 0;"> Dominada</p>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 5px;">М Calculadora</h5>
                                <p style="color: #fff; margin: 0;"> Usada</p>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 5px;"> Ejercicios</h5>
                                <p style="color: #fff; margin: 0;">${exercisesCorrect}/${totalExercises} Correctos</p>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 5px;"> Progreso</h5>
                                <p style="color: #fff; margin: 0;">${exercisesCorrect >= 2 ? 'Aprobado' : 'En progreso'}</p>
                            </div>
                        </div>
                        
                        ${exercisesCorrect >= 2 ? `
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                                <h5 style="color: var(--primary-green); margin-bottom: 10px;"> 隆Excelente Trabajo!</h5>
                                <p style="color: #fff; margin: 0;">Has demostrado dominio de la Ley de Ohm con ${exercisesCorrect} ejercicios correctos.</p>
                            </div>
                        ` : `
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                                <h5 style="color: #ffa500; margin-bottom: 10px;"> Contin煤a Practicando</h5>
                                <p style="color: #fff; margin: 0;">Necesitas al menos 2 ejercicios correctos para continuar. 隆Sigue intentando!</p>
                            </div>
                        `}
                    </div>
                `;
                
                // Agregar las estad铆sticas antes del bot贸n
                const exercisesContent = document.getElementById('exercisesContent');
                if (exercisesContent && !exercisesContent.innerHTML.includes(' Estad铆sticas de la Sesi贸n 2')) {
                    exercisesContent.innerHTML += statsHTML;
                }
                
                // Solo mostrar el bot贸n si se aprueban los ejercicios
                if (exercisesCorrect >= 2) {
                    const completeBtnContainer = document.getElementById('completeSession2Btn')?.parentElement;
                    if (completeBtnContainer) {
                        completeBtnContainer.style.textAlign = 'center';
                        completeBtnContainer.style.display = 'flex';
                        completeBtnContainer.style.justifyContent = 'center';
                        completeBtnContainer.style.alignItems = 'center';
                    }
                    
                    document.getElementById('completeSession2Btn').style.display = 'block';
                    this.showAchievement('隆Ejercicios Aprobados!', `Has resuelto ${exercisesCorrect} de ${totalExercises} ejercicios correctamente`);
                }
            }

            completeSession2() {
                // Verificar si ya se complet贸 esta sesi贸n
                if (this.sessionsCompleted.has(2)) {
                    this.showAchievement('Sesi贸n Ya Completada', 'Ya has completado la Sesi贸n 2 anteriormente');
                    return;
                }

                this.log('Completando Sesi贸n 2...');

                // Marcar sesi贸n como completada
                this.sessionsCompleted.add(2);

                // Desbloquear sesi贸n 3
                if (!this.unlockedSessions.includes(3)) {
                    this.unlockedSessions.push(3);
                    const nav3 = document.getElementById('nav3');
                    if (nav3) {
                        nav3.classList.remove('locked');
                    }
                    this.log('Sesi贸n 3 desbloqueada');
                }
                
                this.addProgress('sesi贸n 2 completada');
                this.updateProgress();
                // NO GUARDAR - Para que siempre inicie desde cero
                
                // Deshabilitar el bot贸n
                const completeBtn = document.getElementById('completeSession2Btn');
                if (completeBtn) {
                    completeBtn.disabled = true;
                    completeBtn.textContent = ' Sesi贸n 2 Completada';
                    completeBtn.style.background = '#666';
                }
                
                this.showAchievement('隆Sesi贸n 2 Completada!', '隆Excelente! Has dominado la Ley de Ohm. Sesi贸n 3 desbloqueada.');
                
                // Mostrar resumen de finalizaci贸n similar a la Sesi贸n 1
                setTimeout(() => {
                    const completionSummaryHTML = `
                        <div style="text-align: center; margin-top: 30px; padding: 25px; background: rgba(0, 0, 0, 0.95); border: 2px solid var(--primary-green); border-radius: 20px; box-shadow: 0 0 40px rgba(0, 255, 136, 0.4);">
                            
                            <!-- Actividades completadas -->
                            <div style="margin-bottom: 25px;">
                                <p style="color: #ccc; font-size: 1rem; margin-bottom: 15px;">
                                    Domina los c谩lculos con la Ley de Ohm y luego env铆a tus resultados.
                                </p>
                                <p style="color: #ccc; font-size: 0.9rem; margin-bottom: 20px;">
                                    Necesitas al menos 2 ejercicios correctos para continuar.
                                </p>
                                <button disabled style="background: #666; color: #fff; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1rem; cursor: not-allowed;">
                                     LEY DE OHM DOMINADA
                                </button>
                            </div>

                            <!-- Resultado exitoso -->
                            <div style="background: rgba(0, 255, 136, 0.2); border: 2px solid var(--primary-green); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
                                <h3 style="color: var(--primary-green); margin-bottom: 10px; font-size: 1.2rem;">
                                     隆Excelente! ${this.exercisesCompleted.size}/3 ejercicios resueltos correctamente
                                </h3>
                                <p style="color: #fff; margin: 0;">
                                    Has dominado la Ley de Ohm. 隆Prepar谩ndote para las aplicaciones pr谩cticas!
                                </p>
                            </div>

                            <!-- Mensaje final -->
                            <div style="background: rgba(0, 136, 255, 0.2); border: 2px solid var(--primary-blue); border-radius: 15px; padding: 25px;">
                                <h2 style="color: var(--primary-blue); margin-bottom: 15px; font-size: 1.4rem;">
                                     隆Misi贸n 2 Completada!
                                </h2>
                                <p style="color: #fff; font-size: 1.1rem; margin-bottom: 20px;">
                                    Has dominado la f贸rmula m谩s importante de la electricidad: <strong style="color: var(--primary-green);">V = I  R</strong>
                                </p>
                                <button class="ready-btn" onclick="game.showSession(3)" style="font-size: 1.1rem; padding: 18px 40px; background: linear-gradient(135deg, var(--primary-blue), #0066cc);">
                                    CONTINUAR A LA SESIN 3 
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Reemplazar el contenido de ejercicios con el resumen
                    const exercisesContent = document.getElementById('exercisesContent');
                    if (exercisesContent) {
                        exercisesContent.innerHTML = completionSummaryHTML;
                    }
                }, 3000);
            }

            // ===== FUNCIONES PARA LA NUEVA SESIN 3: CONCEPTOS AVANZADOS =====

            startAdvancedConcepts() {
                if (this.completedActions.has('advancedConceptsStarted')) {
                    this.showAchievement('Ya Iniciado', 'Ya has comenzado los conceptos avanzados');
                    return;
                }

                this.completedActions.add('advancedConceptsStarted');
                this.createWireGaugeContent();
                this.createEfficiencyContent();
                this.createSafetyContent();
                
                // Mostrar todas las secciones
                document.getElementById('wireGaugeSection').style.display = 'block';
                document.getElementById('efficiencySection').style.display = 'block';
                document.getElementById('safetySection').style.display = 'block';
                
                this.addProgress('conceptos avanzados iniciados');
                this.showAchievement('Conceptos Avanzados Desbloqueados', 'Has accedido al conocimiento especializado de un Ohm-Venger');
            }

            createWireGaugeContent() {
                const wireContent = `
                    <div style="background: rgba(0, 0, 0, 0.5); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 15px;">驴Qu茅 son los Calibres AWG?</h4>
                        <p style="margin-bottom: 15px; line-height: 1.6;">
                            El sistema AWG (American Wire Gauge) especifica el grosor de los cables el茅ctricos. 
                            <strong style="color: var(--primary-green);">N煤mero menor = cable m谩s grueso = mayor capacidad de corriente.</strong>
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: rgba(255, 0, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-pink); margin-bottom: 8px;">AWG 18 (Delgado)</h5>
                                <p style="font-size: 0.9rem;">Capacidad: ~7A<br>Uso: Electr贸nicos, luces LED</p>
                            </div>
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: #ffa500; margin-bottom: 8px;">AWG 16 (Mediano)</h5>
                                <p style="font-size: 0.9rem;">Capacidad: ~10A<br>Uso: Electrodom茅sticos peque帽os</p>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 8px;">AWG 14 (Est谩ndar)</h5>
                                <p style="font-size: 0.9rem;">Capacidad: ~15A<br>Uso: Circuitos residenciales</p>
                            </div>
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 8px;">AWG 12 (Grueso)</h5>
                                <p style="font-size: 0.9rem;">Capacidad: ~20A<br>Uso: Equipos de alta potencia</p>
                            </div>
                        </div>

                        <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h5 style="color: var(--primary-green); margin-bottom: 15px;"> Reglas Claras de Selecci贸n:</h5>
                            
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h6 style="color: var(--primary-blue); margin-bottom: 10px;"> Paso 1: Calcular la corriente</h6>
                                <p style="margin-bottom: 8px;">I = P 梅 V (usando la Ley de Ohm)</p>
                                <p style="color: #ccc; font-size: 0.9rem;">Ejemplo: Horno microondas 1200W 梅 110V = 10.9A</p>
                            </div>

                            <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h6 style="color: var(--primary-blue); margin-bottom: 10px;">★ Paso 2: Aplicar factor de seguridad</h6>
                                <p style="margin-bottom: 8px;">I_segura = I_calculada  1.25</p>
                                <p style="color: #ccc; font-size: 0.9rem;">Ejemplo: 10.9A  1.25 = 13.6A</p>
                            </div>

                            <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h6 style="color: var(--primary-blue); margin-bottom: 10px;"> Paso 3: Seleccionar cable</h6>
                                <p style="margin-bottom: 8px;">Elegir AWG con capacidad  I_segura</p>
                                <p style="color: #ccc; font-size: 0.9rem;">Ejemplo: 13.6A  AWG 16 (10A) NO es suficiente  AWG 14 (15A) </p>
                            </div>

                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffa500;">
                                <h6 style="color: #ffa500; margin-bottom: 10px;"> Regla Especial - Aplicaciones Cr铆ticas:</h6>
                                <p style="margin-bottom: 8px;"><strong>Centros de datos, laboratorios, salas de servidores:</strong> Usar el cable inmediatamente superior.</p>
                                <p style="color: #ccc; font-size: 0.9rem;">Si calculas AWG 14, usar AWG 12. Si calculas AWG 12, usar AWG 10.</p>
                            </div>

                            <div style="background: rgba(0, 255, 136, 0.15); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h6 style="color: var(--primary-green); margin-bottom: 10px;"> Ejemplo Completo - Oficina Comercial:</h6>
                                <p style="margin-bottom: 5px;"><strong>Dados:</strong> 8 computadoras de 300W cada una a 220V</p>
                                <p style="margin-bottom: 5px;"><strong>Paso 1:</strong> I = (8  300W) 梅 220V = 2400W 梅 220V = 10.9A</p>
                                <p style="margin-bottom: 5px;"><strong>Paso 2:</strong> I_segura = 10.9A  1.25 = 13.6A</p>
                                <p style="margin-bottom: 5px;"><strong>Paso 3:</strong> AWG 14 (15A) ser铆a suficiente</p>
                                <p style="margin-bottom: 5px;"><strong>Cr铆tico:</strong> Como es oficina normal  usar AWG 14 est谩 bien</p>
                                <p style="color: var(--primary-green); font-weight: bold;"> Resultado: AWG 14 para uso comercial est谩ndar</p>
                            </div>
                        </div>

                        <!-- Espacio reservado para simulador futuro -->
                        <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 10px; border: 2px dashed var(--primary-blue); text-align: center;">
                            <h5 style="color: var(--primary-blue); margin-bottom: 10px;"> Simulador de Calibres (Pr贸ximamente)</h5>
                            <p style="color: #ccc; font-style: italic;">Aqu铆 podr谩s experimentar con diferentes calibres y ver sus efectos en tiempo real.</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('wireGaugeContent').innerHTML = wireContent;
            }

            createEfficiencyContent() {
                const efficiencyContent = `
                    <div style="background: rgba(0, 0, 0, 0.5); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                        <h4 style="color: var(--primary-blue); margin-bottom: 15px;">驴Qu茅 es la Eficiencia?</h4>
                        <p style="margin-bottom: 15px; line-height: 1.6;">
                            La eficiencia mide qu茅 porcentaje de la energ铆a de entrada se convierte en trabajo 煤til. 
                            <strong style="color: var(--primary-blue);">Siempre hay p茅rdidas en forma de calor.</strong>
                        </p>
                        
                        <div style="background: rgba(0, 136, 255, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h5 style="color: var(--primary-blue); margin-bottom: 15px;"> F贸rmula Principal:</h5>
                            <div style="text-align: center; font-size: 1.3rem; color: var(--primary-blue); font-weight: bold; margin-bottom: 15px;">
                                Potencia_Fuente = Potencia_Carga 梅 Eficiencia
                            </div>
                            <p style="text-align: center; color: #ccc;">
                                Si necesitas 500W 煤tiles con 85% de eficiencia:<br>
                                Potencia_Fuente = 500W 梅 0.85 = 588W
                            </p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: rgba(255, 0, 136, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--primary-pink); margin-bottom: 8px;">Muy Baja</h5>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-pink);">60-70%</div>
                                <p style="font-size: 0.9rem;">Equipos antiguos</p>
                            </div>
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: #ffa500; margin-bottom: 8px;">Media</h5>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #ffa500;">80-85%</div>
                                <p style="font-size: 0.9rem;">Equipos est谩ndar</p>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--primary-green); margin-bottom: 8px;">Alta</h5>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-green);">90-95%</div>
                                <p style="font-size: 0.9rem;">Equipos modernos</p>
                            </div>
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 8px;">Premium</h5>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">95-98%</div>
                                <p style="font-size: 0.9rem;">Equipos de alta gama</p>
                            </div>
                        </div>

                        <!-- Espacio reservado para simulador futuro -->
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 10px; border: 2px dashed var(--primary-green); text-align: center;">
                            <h5 style="color: var(--primary-green); margin-bottom: 10px;">锔 Simulador de Eficiencia (Pr贸ximamente)</h5>
                            <p style="color: #ccc; font-style: italic;">Experimenta con diferentes niveles de eficiencia y observa el impacto en costos.</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('efficiencyContent').innerHTML = efficiencyContent;
            }

            createSafetyContent() {
                const safetyContent = `
                    <div style="background: rgba(0, 0, 0, 0.5); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                        <h4 style="color: #ffa500; margin-bottom: 15px;">驴Por qu茅 Factores de Seguridad?</h4>
                        <p style="margin-bottom: 15px; line-height: 1.6;">
                            Los factores de seguridad protegen contra sobrecargas y fallos. 
                            <strong style="color: #ffa500;">Nunca uses el 100% de la capacidad nominal.</strong>
                        </p>
                        
                        <div style="background: rgba(255, 165, 0, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h5 style="color: #ffa500; margin-bottom: 15px;">★ Regla del 125% (Factor 1.25):</h5>
                            <div style="text-align: center; font-size: 1.3rem; color: #ffa500; font-weight: bold; margin-bottom: 15px;">
                                Capacidad_Necesaria = Corriente_Calculada  1.25
                            </div>
                            <p style="text-align: center; color: #ccc;">
                                Si calculas 8A para fusible de una lavadora:<br>
                                Fusible = 8A  1.25 = 10A  <strong>Usar 10A o 15A</strong>
                            </p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: rgba(255, 0, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-pink); margin-bottom: 8px;">锔 Sin Factor de Seguridad</h5>
                                <ul style="font-size: 0.9rem; margin-left: 15px;">
                                    <li>Fusibles que se queman constantemente</li>
                                    <li>Cables que se sobrecalientan</li>
                                    <li>Equipos que fallan prematuramente</li>
                                    <li>Riesgo de incendios</li>
                                </ul>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 8px;"> Con Factor de Seguridad</h5>
                                <ul style="font-size: 0.9rem; margin-left: 15px;">
                                    <li>Sistema confiable y estable</li>
                                    <li>Protecci贸n contra picos de corriente</li>
                                    <li>Vida 煤til extendida de equipos</li>
                                    <li>Operaci贸n segura</li>
                                </ul>
                            </div>
                        </div>

                        <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff0000; margin-bottom: 20px;">
                            <h5 style="color: #ff6666; margin-bottom: 10px;"> Casos Cr铆ticos:</h5>
                            <p style="color: #fff;">En hospitales, centros de datos y aplicaciones cr铆ticas, usar factores de seguridad a煤n mayores (1.5x o m谩s).</p>
                        </div>

                        <!-- Espacio reservado para simulador futuro -->
                        <div style="background: rgba(255, 165, 0, 0.1); padding: 20px; border-radius: 10px; border: 2px dashed #ffa500; text-align: center;">
                            <h5 style="color: #ffa500; margin-bottom: 10px;">★ Simulador de Seguridad (Pr贸ximamente)</h5>
                            <p style="color: #ccc; font-style: italic;">Observa qu茅 pasa cuando no usas factores de seguridad adecuados.</p>
                        </div>

                        <div style="text-align: center; margin-top: 25px;">
                            <button class="btn" onclick="game.startAdvancedQuiz()" style="background: var(--primary-green); color: #000; font-size: 1.1rem;">
                                Evaluaci贸n: Conceptos Avanzados 
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('safetyContent').innerHTML = safetyContent;
            }

            startAdvancedQuiz() {
                if (this.completedActions.has('advancedQuizStarted')) {
                    this.showAchievement('Ya Iniciado', 'Ya has comenzado la evaluaci贸n de conceptos avanzados');
                    return;
                }

                this.completedActions.add('advancedQuizStarted');
                document.getElementById('advancedQuiz').style.display = 'block';
                this.createAdvancedQuiz();
            }

            createAdvancedQuiz() {
                const advancedQuestions = [
                    {
                        question: "Para un circuito de 5A, 驴qu茅 calibre de cable es m谩s seguro para uso cr铆tico?",
                        options: ["AWG 18 (7A)", "AWG 16 (10A)", "AWG 14 (15A)", "AWG 12 (20A)"],
                        correct: 2,
                        explanation: "AWG 14 proporciona mayor margen de seguridad para aplicaciones cr铆ticas."
                    },
                    {
                        question: "Si un sistema necesita 400W 煤tiles con 90% de eficiencia, 驴cu谩nta potencia debe generar la fuente?",
                        options: ["400W", "444W", "360W", "500W"],
                        correct: 1,
                        explanation: "Potencia_fuente = 400W 梅 0.90 = 444W"
                    },
                    {
                        question: "驴Por qu茅 usamos factor de seguridad 1.25 en fusibles?",
                        options: ["Para ahorrar dinero", "Para proteger contra sobrecargas", "Para usar menos corriente", "Para aumentar la eficiencia"],
                        correct: 1,
                        explanation: "El factor 1.25 protege contra picos de corriente y sobrecargas imprevistas."
                    }
                ];

                let quizHTML = '<div style="text-align: left;">';
                
                advancedQuestions.forEach((q, index) => {
                    quizHTML += `
                        <div class="quiz-question" style="margin-bottom: 25px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid var(--primary-green);">
                            <h4 style="color: var(--primary-green); margin-bottom: 15px;">${index + 1}. ${q.question}</h4>
                            <div class="quiz-options">
                    `;
                    
                    q.options.forEach((option, optIndex) => {
                        const optionLetter = String.fromCharCode(65 + optIndex);
                        quizHTML += `
                            <label style="display: block; margin-bottom: 10px; cursor: pointer; padding: 10px; border-radius: 5px; transition: background 0.3s; border: 1px solid transparent;">
                                <input type="radio" name="advancedQuestion${index}" value="${optIndex}" style="margin-right: 10px;">
                                <span style="font-size: 0.95rem;"><strong>${optionLetter})</strong> ${option}</span>
                            </label>
                        `;
                    });
                    
                    quizHTML += `
                            </div>
                            <div id="advancedExplanation${index}" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0, 255, 136, 0.1); border-radius: 8px; border-left: 4px solid var(--primary-green);">
                                <strong style="color: var(--primary-green);"> Explicaci贸n:</strong> 
                                <span style="color: #fff;">${q.explanation}</span>
                            </div>
                        </div>
                    `;
                });
                
                quizHTML += `
                    <div style="text-align: center; margin-top: 25px; padding: 20px; background: rgba(0, 136, 255, 0.1); border-radius: 10px;">
                        <p style="margin-bottom: 15px; color: #ccc;">
                            <strong>Responde todas las preguntas y luego env铆a tus respuestas.</strong><br>
                            <small>Necesitas todas correctas para completar la sesi贸n.</small>
                        </p>
                        <button class="btn" onclick="game.submitAdvancedQuiz()" style="background: var(--primary-blue); color: #fff; font-size: 1.1rem; padding: 15px 30px;">
                             Enviar Respuestas
                        </button>
                    </div>
                </div>`;
                
                document.getElementById('advancedQuizContent').innerHTML = quizHTML;
                this.currentAdvancedQuiz = advancedQuestions;
            }

            submitAdvancedQuiz() {
                let correctAnswers = 0;
                const totalQuestions = this.currentAdvancedQuiz.length;
                
                this.currentAdvancedQuiz.forEach((q, index) => {
                    const selectedOption = document.querySelector(`input[name="advancedQuestion${index}"]:checked`);
                    const explanationDiv = document.getElementById(`advancedExplanation${index}`);
                    const questionDiv = document.querySelector(`input[name="advancedQuestion${index}"]`).closest('.quiz-question');
                    
                    if (selectedOption) {
                        const selectedValue = parseInt(selectedOption.value);
                        const label = selectedOption.parentElement;
                        
                        if (selectedValue === q.correct) {
                            correctAnswers++;
                            label.style.background = 'rgba(0, 255, 136, 0.3)';
                            label.style.border = '2px solid var(--primary-green)';
                        } else {
                            label.style.background = 'rgba(255, 0, 136, 0.3)';
                            label.style.border = '2px solid var(--primary-pink)';
                        }
                    }
                    
                    explanationDiv.style.display = 'block';
                    
                    // Resaltar respuesta correcta
                    const allLabels = questionDiv.querySelectorAll('label');
                    allLabels[q.correct].style.border = '2px solid var(--primary-green)';
                    if (!selectedOption || parseInt(selectedOption.value) !== q.correct) {
                        allLabels[q.correct].style.background = 'rgba(0, 255, 136, 0.2)';
                    }
                });
                
                const percentage = (correctAnswers / totalQuestions) * 100;
                
                setTimeout(() => {
                    if (percentage === 100) {
                        this.completeAdvancedSession(); // Cambiar el nombre para evitar conflicto
                    } else {
                        this.showAchievement('隆Sigue Estudiando!', `Obtuviste ${correctAnswers}/${totalQuestions} correctas. Revisa los conceptos avanzados.`);
                    }
                }, 2000);
            }

            completeAdvancedSession() {
                if (this.sessionsCompleted.has(3)) {
                    this.showAchievement('Sesi贸n Ya Completada', 'Ya has completado la Sesi贸n 3 anteriormente');
                    return;
                }

                this.sessionsCompleted.add(3);

                // Desbloquear sesi贸n 4
                if (!this.unlockedSessions.includes(4)) {
                    this.unlockedSessions.push(4);
                    const nav4 = document.getElementById('nav4');
                    if (nav4) {
                        nav4.classList.remove('locked');
                    }
                }
                
                this.addProgress('sesi贸n 3 completada');
                this.updateProgress();
                
                this.showAchievement('隆Sesi贸n 3 Completada!', '隆Excelente! Has dominado los conceptos avanzados. Sesi贸n 4 desbloqueada.');
                
                // Mostrar opci贸n de continuar
                setTimeout(() => {
                    const continueHTML = `
                        <div style="text-align: center; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 136, 255, 0.2)); border-radius: 15px; border: 2px solid var(--primary-green);">
                            <h3 style="color: var(--primary-green); margin-bottom: 15px;"> 隆Conceptos Avanzados Dominados!</h3>
                            <p style="margin-bottom: 20px;">Ahora tienes todo el conocimiento necesario para el desaf铆o final.</p>
                            <button class="btn" onclick="game.showSession(4)" style="background: var(--primary-green); color: #000; font-size: 1.2rem; padding: 15px 30px;">
                                Continuar a las Aplicaciones Pr谩cticas 
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('advancedQuizContent').innerHTML += continueHTML;
                }, 3000);
            }

            startRealWorldProblems() {
                if (this.completedActions.has('realWorldStarted')) {
                    this.showAchievement('Ya Iniciado', 'Ya has comenzado los problemas del mundo real');
                    document.getElementById('realWorldProblems').style.display = 'block';
                    return;
                }

                this.completedActions.add('realWorldStarted');
                document.getElementById('realWorldProblems').style.display = 'block';
                this.createRealWorldProblems();
                this.addProgress('problemas mundo real iniciados');
            }

            createRealWorldProblems() {
                const problems = [
                    {
                        id: 0,
                        title: " Consumo de Electrodom茅sticos",
                        description: "Una familia quiere calcular el consumo de su refrigerador. Si consume 150W y funciona 24 horas al d铆a, 驴cu谩nta corriente consume si est谩 conectado a 120V?",
                        answer: 1.25,
                        unit: "A",
                        hint: "Usa P = V  I, entonces I = P 梅 V",
                        explanation: "I = P 梅 V = 150W 梅 120V = 1.25A"
                    },
                    {
                        id: 1,
                        title: " Cable Industrial",
                        description: "Una m谩quina industrial necesita 25A de corriente. Si el cable tiene 2惟 de resistencia, 驴qu茅 voltaje se pierde en el cable?",
                        answer: 50,
                        unit: "V",
                        hint: "Usa V = I  R para calcular la ca铆da de voltaje",
                        explanation: "V = I  R = 25A  2惟 = 50V"
                    },
                    {
                        id: 2,
                        title: " Sistema de Iluminaci贸n",
                        description: "Un edificio tiene 20 bombillas LED de 10W cada una conectadas a 220V. 驴Cu谩l es la corriente total del sistema?",
                        answer: 0.91,
                        unit: "A",
                        hint: "Primero calcula la potencia total, luego I = P_total 梅 V",
                        explanation: "P_total = 20  10W = 200W, entonces I = 200W 梅 220V = 0.91A"
                    },
                    {
                        id: 3,
                        title: " Calentador El茅ctrico",
                        description: "Un calentador el茅ctrico de 1500W est谩 conectado a 110V. 驴Cu谩l es su resistencia interna?",
                        answer: 8.07,
                        unit: "惟",
                        hint: "Usa P = V虏/R, entonces R = V虏 梅 P",
                        explanation: "R = V虏 梅 P = (110)虏 梅 1500 = 12100 梅 1500 = 8.07惟"
                    },
                    {
                        id: 4,
                        title: " Equipo M茅dico",
                        description: "Un equipo m茅dico cr铆tico necesita exactamente 5A para funcionar. Si el voltaje de suministro es 240V, 驴cu谩l debe ser su resistencia?",
                        answer: 48,
                        unit: "惟",
                        hint: "Usa V = I  R, entonces R = V 梅 I",
                        explanation: "R = V 梅 I = 240V 梅 5A = 48惟"
                    }
                ];

                let problemsHTML = `
                    <div style="background: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 15px;"> Misi贸n: Resolver Problemas Cr铆ticos</h4>
                        <p style="margin-bottom: 15px;">
                            El sistema el茅ctrico de la ciudad necesita tu experiencia. 
                            Resuelve al menos <strong style="color: var(--primary-green);">3 de estos 5 problemas</strong> 
                            para continuar con la misi贸n.
                        </p>
                        <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ffa500; margin-bottom: 10px;">
                            <strong style="color: #ffa500;">锔 Importante:</strong> 
                            <span style="color: #fff;">No necesitas resolver TODOS los problemas. Con 3 correctos puedes avanzar al simulador.</span>
                        </div>
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 8px;">
                            <strong>Progreso:</strong> <span id="realWorldProgress">0/5 problemas resueltos</span>
                        </div>
                    </div>
                `;

                problems.forEach((problem, index) => {
                    const isCompleted = this.realWorldSolved.has(problem.id);
                    const cardStyle = isCompleted ? 'background: rgba(0, 255, 136, 0.2); border: 2px solid var(--primary-green);' : 'background: rgba(0, 0, 0, 0.5); border: 1px solid #666;';
                    
                    problemsHTML += `
                        <div style="${cardStyle} padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                            <h4 style="color: ${isCompleted ? 'var(--primary-green)' : '#fff'}; margin-bottom: 15px; font-size: 1.2rem;">
                                ${problem.title} ${isCompleted ? '' : ''}
                            </h4>
                            <p style="margin-bottom: 15px; line-height: 1.6; color: ${isCompleted ? '#fff' : '#ccc'};">
                                ${problem.description}
                            </p>
                            
                            ${!isCompleted ? `
                                <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 136, 255, 0.1); border-radius: 8px; border-left: 4px solid var(--primary-blue);">
                                    <strong style="color: var(--primary-blue);"> Pista:</strong> ${problem.hint}
                                </div>
                                
                                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                                    <input type="number" id="realWorld${problem.id}" placeholder="Tu respuesta" 
                                           style="flex: 1; min-width: 200px; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff;">
                                    <span style="color: #ccc; font-weight: bold;">${problem.unit}</span>
                                    <button class="btn" onclick="game.checkRealWorldProblem(${problem.id}, ${problem.answer}, '${problem.unit}', '${problem.explanation}')" 
                                            style="padding: 10px 20px;">Verificar</button>
                                </div>
                            ` : `
                                <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <strong style="color: var(--primary-green);"> 隆Correcto!</strong> 
                                    Respuesta: <strong>${problem.answer} ${problem.unit}</strong>
                                    <br><strong>Explicaci贸n:</strong> ${problem.explanation}
                                </div>
                            `}
                            
                            <div id="realWorldResult${problem.id}" style="display: none;"></div>
                        </div>
                    `;
                });



                document.getElementById('realWorldContent').innerHTML = problemsHTML;
                this.updateRealWorldProgress();
            }

            checkRealWorldProblem(problemId, correctAnswer, unit, explanation) {
                if (this.realWorldSolved.has(problemId)) {
                    this.showAchievement('Ya Resuelto', `Ya resolviste correctamente este problema`);
                    return;
                }

                const userAnswer = parseFloat(document.getElementById(`realWorld${problemId}`).value);
                const resultDiv = document.getElementById(`realWorldResult${problemId}`);
                
                // Tolerancia espec铆fica para cada problema
                let tolerance = 0.1;
                if (problemId === 2) { // Sistema de Iluminaci贸n (0.91A)
                    tolerance = 0.02; // Tolerancia m谩s estricta para 0.91
                } else if (problemId === 3) { // Calentador El茅ctrico (8.07惟)
                    tolerance = 0.1;
                } else if (problemId === 1) { // Cable Industrial (50V)
                    tolerance = 1;
                }
                
                if (Math.abs(userAnswer - correctAnswer) <= tolerance) {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary-green);">
                            <p style="color: var(--primary-green); font-weight: bold; margin-bottom: 8px;">
                                 隆Excelente! La respuesta es ${correctAnswer} ${unit}
                            </p>
                            <p style="color: #fff;"><strong>Explicaci贸n:</strong> ${explanation}</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    
                    this.realWorldSolved.add(problemId);
                    this.addProgress('problema mundo real resuelto');
                    
                    // Deshabilitar input y bot贸n
                    const inputElement = document.getElementById(`realWorld${problemId}`);
                    const buttonElement = document.querySelector(`button[onclick*="checkRealWorldProblem(${problemId}"]`);
                    
                    if (inputElement) inputElement.disabled = true;
                    if (buttonElement) {
                        buttonElement.disabled = true;
                        buttonElement.textContent = ' Correcto';
                        buttonElement.style.background = 'var(--primary-green)';
                        buttonElement.style.color = '#000';
                    }
                    
                    this.updateRealWorldProgress();
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(255, 0, 136, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary-pink);">
                            <p style="color: var(--primary-pink); font-weight: bold;">
                                 Incorrecto. Revisa tus c谩lculos e int茅ntalo de nuevo.
                            </p>
                            <p style="color: #ccc; font-size: 0.9rem;">
                                Tip: La respuesta correcta est谩 cerca de ${correctAnswer.toFixed(2)} ${unit}
                            </p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                }
            }

            updateRealWorldProgress() {
                const solved = this.realWorldSolved.size;
                const total = 5;
                const progressElement = document.getElementById('realWorldProgress');
                if (progressElement) {
                    progressElement.textContent = `${solved}/${total} problemas resueltos`;
                }
                
                // Verificar si realmente necesitamos 3 problemas DIFERENTES
                if (solved >= 3) {
                    
                    // Buscar el bot贸n con m谩s insistencia
                    let circuitBtn = document.getElementById('circuitSimulatorBtn');
                    
                    // Si no existe, intentar crearlo de nuevo
                    if (!circuitBtn) {
                        
                        // Crear el bot贸n si no existe
                        const realWorldContent = document.getElementById('realWorldContent');
                        if (realWorldContent) {
                            const buttonContainer = document.createElement('div');
                            buttonContainer.style.cssText = 'text-align: center; margin-top: 30px;';
                            buttonContainer.innerHTML = `
                                <button class="btn" onclick="game.showCircuitSimulator()" id="circuitSimulatorBtn" 
                                        style="display: block; background: var(--primary-blue); color: #fff; font-size: 1.1rem; padding: 15px 30px;">
                                     Continuar al Simulador de Circuitos 
                                </button>
                            `;
                            realWorldContent.appendChild(buttonContainer);
                        }
                    } else {
                        // Si existe, simplemente mostrarlo
                        circuitBtn.style.display = 'block';
                    }
                    
                    if (!this.completedActions.has('realWorldCompleted')) {
                        this.completedActions.add('realWorldCompleted');
                        this.showAchievement('隆3 Problemas Resueltos!', 'Has resuelto suficientes problemas para continuar al simulador. 隆Puedes resolver los otros 2 como pr谩ctica adicional!');
                    }
                }
                
                // Debug final: Verificar si el bot贸n est谩 visible
                setTimeout(() => {
                    const finalCheck = document.getElementById('circuitSimulatorBtn');
                }, 100);
            }

            showCircuitSimulator() {
                if (this.realWorldSolved.size < 3) {
                    this.showAchievement('Requisito Pendiente', 'Resuelve al menos 3 problemas del mundo real primero');
                    return;
                }

                const circuitElement = document.getElementById('circuitSimulator');
                if (circuitElement) {
                    circuitElement.style.display = 'block';
                    this.createCircuitSimulator();
                }
            }

            createCircuitSimulator() {
                const simulatorHTML = `
                    <div style="background: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 15px;"> Simulador de Circuitos Interactivo</h4>
                        <p style="margin-bottom: 20px;">
                            Aprende c贸mo funciona la electricidad en circuitos serie y paralelo. 
                            Experimenta con diferentes configuraciones y observa c贸mo cambian los valores.
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; justify-items: center;">
                        <!-- Circuito en Serie -->
                        <div style="background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-green); max-width: 450px; width: 100%;">
                            <h4 style="color: var(--primary-green); margin-bottom: 20px; text-align: center;"> Circuito en Serie</h4>
                            
                            <canvas id="seriesCanvas" width="350" height="200" style="width: 100%; max-width: 350px; border: 1px solid #333; border-radius: 8px; background: #000; margin: 0 auto 15px auto; display: block;"></canvas>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green);">Voltaje de la fuente (V):</label>
                                <input type="range" id="seriesVoltage" min="1" max="24" value="12" 
                                       style="width: 100%; margin-bottom: 5px;" onchange="game.updateSeriesCircuit()">
                                <span id="seriesVoltageValue" style="color: #fff;">12V</span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-blue);">Resistencia 1 (惟):</label>
                                <input type="range" id="seriesR1" min="1" max="100" value="10" 
                                       style="width: 100%; margin-bottom: 5px;" onchange="game.updateSeriesCircuit()">
                                <span id="seriesR1Value" style="color: #fff;">10惟</span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-blue);">Resistencia 2 (惟):</label>
                                <input type="range" id="seriesR2" min="1" max="100" value="20" 
                                       style="width: 100%; margin-bottom: 5px;" onchange="game.updateSeriesCircuit()">
                                <span id="seriesR2Value" style="color: #fff;">20惟</span>
                            </div>
                            
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 10px;">Resultados:</h5>
                                <div id="seriesResults"></div>
                            </div>
                        </div>

                        <!-- Circuito en Paralelo -->
                        <div style="background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-blue); max-width: 450px; width: 100%;">
                            <h4 style="color: var(--primary-blue); margin-bottom: 20px; text-align: center;"> Circuito en Paralelo</h4>
                            
                            <canvas id="parallelCanvas" width="350" height="200" style="width: 100%; max-width: 350px; border: 1px solid #333; border-radius: 8px; background: #000; margin: 0 auto 15px auto; display: block;"></canvas>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-blue);">Voltaje de la fuente (V):</label>
                                <input type="range" id="parallelVoltage" min="1" max="24" value="12" 
                                       style="width: 100%; margin-bottom: 5px;" onchange="game.updateParallelCircuit()">
                                <span id="parallelVoltageValue" style="color: #fff;">12V</span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green);">Resistencia 1 (惟):</label>
                                <input type="range" id="parallelR1" min="1" max="100" value="10" 
                                       style="width: 100%; margin-bottom: 5px;" onchange="game.updateParallelCircuit()">
                                <span id="parallelR1Value" style="color: #fff;">10惟</span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green);">Resistencia 2 (惟):</label>
                                <input type="range" id="parallelR2" min="1" max="100" value="20" 
                                       style="width: 100%; margin-bottom: 5px;" onchange="game.updateParallelCircuit()">
                                <span id="parallelR2Value" style="color: #fff;">20惟</span>
                            </div>
                            
                            <div style="background: rgba(0, 136, 255, 0.1); padding: 15px; border-radius: 8px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 10px;">Resultados:</h5>
                                <div id="parallelResults"></div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="game.completeSimulator()" id="completeSimulatorBtn" 
                                style="background: var(--primary-pink); color: #fff; font-size: 1.1rem;">
                            Completar Simulaci贸n 
                        </button>
                    </div>
                `;

                document.getElementById('simulatorContent').innerHTML = simulatorHTML;
                
                // Inicializar simulaciones con un peque帽o delay para asegurar que el DOM est茅 listo
                setTimeout(() => {
                    // Verificar que los elementos existen antes de inicializar
                    if (document.getElementById('seriesVoltage') && document.getElementById('parallelVoltage')) {
                        this.updateSeriesCircuit();
                        this.updateParallelCircuit();
                        this.log('Simulaciones inicializadas correctamente');
                    } else {
                        this.log('Error: Elementos del simulador no encontrados');
                    }
                }, 200);
                
                this.addProgress('simulador iniciado');
            }

            updateSeriesCircuit() {
                const voltage = parseFloat(document.getElementById('seriesVoltage').value);
                const r1 = parseFloat(document.getElementById('seriesR1').value);
                const r2 = parseFloat(document.getElementById('seriesR2').value);
                
                // Actualizar displays
                document.getElementById('seriesVoltageValue').textContent = voltage + 'V';
                document.getElementById('seriesR1Value').textContent = r1 + '惟';
                document.getElementById('seriesR2Value').textContent = r2 + '惟';
                
                // Calcular valores para circuito en serie
                const totalR = r1 + r2;
                const current = voltage / totalR;
                const v1 = current * r1;
                const v2 = current * r2;
                const power1 = Math.pow(current, 2) * r1;
                const power2 = Math.pow(current, 2) * r2;
                const totalPower = power1 + power2;
                
                // Mostrar resultados
                const formatNumber = (num) => Number.isInteger(num) ? num.toString() : num.toFixed(2);
                document.getElementById('seriesResults').innerHTML = `
                    <p><strong>Resistencia Total:</strong> ${formatNumber(totalR)} 惟</p>
                    <p><strong>Corriente:</strong> ${formatNumber(current)} A</p>
                    <p><strong>Voltaje en R1:</strong> ${formatNumber(v1)} V</p>
                    <p><strong>Voltaje en R2:</strong> ${formatNumber(v2)} V</p>
                    <p><strong>Potencia R1:</strong> ${formatNumber(power1)} W</p>
                    <p><strong>Potencia R2:</strong> ${formatNumber(power2)} W</p>
                    <p><strong>Potencia Total:</strong> ${formatNumber(totalPower)} W</p>
                `;
                
                // Actualizar la animaci贸n del circuito - forzar recreaci贸n
                if (this.seriesAnimationData && this.seriesAnimationData.animationId) {
                    cancelAnimationFrame(this.seriesAnimationData.animationId);
                    this.seriesAnimationData = null;
                }
                this.drawSeriesCircuit(voltage, r1, r2, current);
            }

            updateParallelCircuit() {
                const voltage = parseFloat(document.getElementById('parallelVoltage').value);
                const r1 = parseFloat(document.getElementById('parallelR1').value);
                const r2 = parseFloat(document.getElementById('parallelR2').value);
                
                // Actualizar displays
                document.getElementById('parallelVoltageValue').textContent = voltage + 'V';
                document.getElementById('parallelR1Value').textContent = r1 + '惟';
                document.getElementById('parallelR2Value').textContent = r2 + '惟';
                
                // Calcular valores
                const totalR = (r1 * r2) / (r1 + r2);
                const i1 = voltage / r1;
                const i2 = voltage / r2;
                const totalCurrent = i1 + i2;
                const power = voltage * totalCurrent;
                
                // Mostrar resultados
                const formatNumber = (num) => Number.isInteger(num) ? num.toString() : num.toFixed(2);
                document.getElementById('parallelResults').innerHTML = `
                    <p><strong>Resistencia Total:</strong> ${formatNumber(totalR)} 惟</p>
                    <p><strong>Corriente en R1:</strong> ${formatNumber(i1)} A</p>
                    <p><strong>Corriente en R2:</strong> ${formatNumber(i2)} A</p>
                    <p><strong>Corriente Total:</strong> ${formatNumber(totalCurrent)} A</p>
                    <p><strong>Potencia Total:</strong> ${formatNumber(power)} W</p>
                `;
                
                // Forzar recreaci贸n de animaci贸n paralela
                if (this.parallelAnimationData && this.parallelAnimationData.animationId) {
                    cancelAnimationFrame(this.parallelAnimationData.animationId);
                    this.parallelAnimationData = null;
                }
                
                // Dibujar circuito
                this.drawParallelCircuit(voltage, r1, r2, i1, i2);
            }

            drawSeriesCircuit(voltage, r1, r2, current) {
                const canvas = document.getElementById('seriesCanvas');
                if (!canvas) return;
                
                // Inicializar animaci贸n si no existe
                if (!this.seriesAnimationData) {
                    this.seriesAnimationData = {
                        time: 0,
                        electrons: [],
                        animationId: null
                    };
                    
                    // Crear electrones
                    for (let i = 0; i < 8; i++) {
                        this.seriesAnimationData.electrons.push({
                            progress: i * (400 / 8),
                            size: 2 + Math.random() * 0.5
                        });
                    }
                }
                
                const animateFrame = () => {
                    // Verificar si la animaci贸n debe continuar
                    const state = this.analogyStates[index];
                    if (!state || !state.isPlaying) {
                        return; // Salir si est谩 pausada
                    }

                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    this.seriesAnimationData.time += 0.02;
                    
                    // Configuraci贸n de estilo
                    ctx.strokeStyle = '#00ff88';
                    ctx.fillStyle = '#fff';
                    ctx.lineWidth = 3;
                    ctx.font = '14px Arial';
                    
                    // Dibujar circuito en serie con brillo
                    const currentBrightness = Math.min(current * 0.3, 1);
                    ctx.strokeStyle = `rgba(0, 255, 136, ${0.8 + currentBrightness * 0.2})`;
                    ctx.shadowBlur = current * 2;
                    ctx.shadowColor = '#00ff88';
                    ctx.lineWidth = 2 + current * 0.2;
                    
                    // L铆neas del circuito
                    ctx.beginPath();
                    ctx.moveTo(50, 50);
                    ctx.lineTo(150, 50);
                    ctx.lineTo(250, 50);
                    ctx.lineTo(300, 50);
                    ctx.lineTo(300, 150);
                    ctx.lineTo(50, 150);
                    ctx.lineTo(50, 50);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    
                    // Bater铆a
                    ctx.strokeStyle = '#0088ff';
                    ctx.lineWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(45, 60);
                    ctx.lineTo(45, 90);
                    ctx.stroke();
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(55, 70);
                    ctx.lineTo(55, 80);
                    ctx.stroke();
                    
                    // Resistencia 1
                    ctx.strokeStyle = '#0088ff';
                    this.drawResistor(ctx, 130, 35, 40, 30);
                    ctx.fillStyle = '#0088ff';
                    ctx.fillText(`R1: ${r1}惟`, 120, 30);
                    
                    // Resistencia 2
                    this.drawResistor(ctx, 230, 35, 40, 30);
                    ctx.fillText(`R2: ${r2}惟`, 220, 30);
                    
                    // Etiquetas
                    ctx.fillStyle = '#00ff88';
                    ctx.fillText(`${voltage}V`, 20, 80);
                    ctx.fillStyle = '#ffff00';
                    ctx.fillText(`I: ${(current).toFixed(2)}A`, 150, 170);
                    
                    // Animar electrones
                    const electronSpeed = Math.max(0.5, current * 15);
                    
                    this.seriesAnimationData.electrons.forEach((electron, index) => {
                        electron.progress += electronSpeed;
                        
                        if (electron.progress > 400) {
                            electron.progress = 0;
                        }
                        
                        let x, y;
                        const progress = electron.progress;
                        
                        if (progress < 100) {
                            // L铆nea superior
                            x = 50 + progress * 2.5;
                            y = 50;
                        } else if (progress < 150) {
                            // L铆nea derecha hacia abajo
                            x = 300;
                            y = 50 + (progress - 100) * 2;
                        } else if (progress < 350) {
                            // L铆nea inferior
                            x = 300 - (progress - 150) * 1.25;
                            y = 150;
                        } else {
                            // L铆nea izquierda hacia arriba
                            x = 50;
                            y = 150 - (progress - 350) * 2;
                        }
                        
                        // Dibujar electr贸n con efectos
                        ctx.fillStyle = `rgba(255, 255, 0, 0.9)`;
                        ctx.shadowBlur = 3;
                        ctx.shadowColor = '#ffff00';
                        
                        ctx.beginPath();
                        ctx.arc(x, y, electron.size, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Signo negativo ocasional
                        if (index % 3 === 0) {
                            ctx.fillStyle = '#000';
                            ctx.font = 'bold 8px Arial';
                            ctx.fillText('-', x - 2, y + 2);
                        }
                    });
                    ctx.shadowBlur = 0;
                    
                    // Informaci贸n adicional
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.fillText('Circuito en Serie', 150, 15);
                    ctx.fillText('(Misma corriente en todos los componentes)', 90, 185);
                    
                    this.seriesAnimationData.animationId = requestAnimationFrame(animateFrame);
                    // Guardar ID de animaci贸n en el estado
                    if (this.analogyStates[index]) {
                        this.analogyStates[index].animationId = this.seriesAnimationData.animationId;
                    }
                };
                
                // Cancelar animaci贸n anterior si existe
                if (this.seriesAnimationData.animationId) {
                    cancelAnimationFrame(this.seriesAnimationData.animationId);
                }
                
                animateFrame();
            }

            drawParallelCircuit(voltage, r1, r2, i1, i2) {
                const canvas = document.getElementById('parallelCanvas');
                if (!canvas) return;
                
                // Inicializar animaci贸n si no existe
                if (!this.parallelAnimationData) {
                    this.parallelAnimationData = {
                        time: 0,
                        electrons: [],
                        animationId: null
                    };
                    
                    // Crear electrones para ambas ramas
                    for (let i = 0; i < 12; i++) {
                        this.parallelAnimationData.electrons.push({
                            progress: i * (320 / 12),
                            branch: i < 6 ? 'top' : 'bottom', // Primera mitad va por arriba, segunda por abajo
                            size: 2 + Math.random() * 0.5
                        });
                    }
                }
                
                const animateFrame = () => {
                    // Verificar si la animaci贸n debe continuar
                    const state = this.analogyStates[index];
                    if (!state || !state.isPlaying) {
                        return; // Salir si est谩 pausada
                    }

                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    this.parallelAnimationData.time += 0.02;
                    
                    // Configuraci贸n de estilo
                    ctx.strokeStyle = '#0088ff';
                    ctx.fillStyle = '#fff';
                    ctx.lineWidth = 3;
                    ctx.font = '14px Arial';
                    
                    // Calcular corrientes y potencias
                    const totalCurrent = i1 + i2;
                    const power1 = voltage * i1;
                    const power2 = voltage * i2;
                    
                    // Dibujar circuito en paralelo con brillo din谩mico
                    ctx.strokeStyle = `rgba(0, 136, 255, ${0.6 + totalCurrent * 0.1})`;
                    ctx.shadowBlur = totalCurrent * 2;
                    ctx.shadowColor = '#0088ff';
                    ctx.lineWidth = 2 + totalCurrent * 0.3;
                    
                    // L铆nea principal izquierda
                    ctx.beginPath();
                    ctx.moveTo(50, 100);
                    ctx.lineTo(100, 100);
                    ctx.stroke();
                    
                    // Rama superior (con brillo seg煤n corriente i1)
                    ctx.strokeStyle = `rgba(0, 255, 136, ${0.6 + i1 * 0.2})`;
                    ctx.shadowBlur = i1 * 3;
                    ctx.shadowColor = '#00ff88';
                    ctx.lineWidth = 2 + i1 * 0.4;
                    ctx.beginPath();
                    ctx.moveTo(100, 100);
                    ctx.lineTo(100, 50);
                    ctx.lineTo(250, 50);
                    ctx.lineTo(250, 100);
                    ctx.stroke();
                    
                    // Rama inferior (con brillo seg煤n corriente i2)
                    ctx.strokeStyle = `rgba(255, 136, 0, ${0.6 + i2 * 0.2})`;
                    ctx.shadowBlur = i2 * 3;
                    ctx.shadowColor = '#ff8800';
                    ctx.lineWidth = 2 + i2 * 0.4;
                    ctx.beginPath();
                    ctx.moveTo(100, 100);
                    ctx.lineTo(100, 150);
                    ctx.lineTo(250, 150);
                    ctx.lineTo(250, 100);
                    ctx.stroke();
                    
                    // L铆nea final
                    ctx.strokeStyle = `rgba(0, 136, 255, ${0.6 + totalCurrent * 0.1})`;
                    ctx.shadowBlur = totalCurrent * 2;
                    ctx.shadowColor = '#0088ff';
                    ctx.lineWidth = 2 + totalCurrent * 0.3;
                    ctx.beginPath();
                    ctx.moveTo(250, 100);
                    ctx.lineTo(300, 100);
                    ctx.lineTo(300, 170);
                    ctx.lineTo(50, 170);
                    ctx.lineTo(50, 100);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    
                    // Bater铆a
                    ctx.strokeStyle = '#0088ff';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(45, 110);
                    ctx.lineTo(45, 160);
                    ctx.stroke();
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(55, 120);
                    ctx.lineTo(55, 150);
                    ctx.stroke();
                    
                    // Resistencias
                    ctx.strokeStyle = '#0088ff';
                    this.drawResistor(ctx, 155, 35, 40, 30);
                    this.drawResistor(ctx, 155, 135, 40, 30);
                    
                    // Animar electrones fluyendo por ambas ramas
                    const electronSpeed1 = Math.max(0.5, i1 * 15);
                    const electronSpeed2 = Math.max(0.5, i2 * 15);
                    
                    this.parallelAnimationData.electrons.forEach((electron, index) => {
                        const speed = electron.branch === 'top' ? electronSpeed1 : electronSpeed2;
                        electron.progress += speed;
                        
                        if (electron.progress > 320) {
                            electron.progress = 0;
                        }
                        
                        let x, y;
                        const progress = electron.progress;
                        
                        if (electron.branch === 'top') {
                            // Rama superior
                            if (progress < 50) {
                                // L铆nea principal hacia uni贸n
                                x = 50 + progress;
                                y = 100;
                            } else if (progress < 100) {
                                // Subida hacia rama superior
                                x = 100;
                                y = 100 - (progress - 50);
                            } else if (progress < 250) {
                                // L铆nea horizontal superior
                                x = 100 + (progress - 100);
                                y = 50;
                            } else if (progress < 300) {
                                // Bajada hacia uni贸n
                                x = 250;
                                y = 50 + (progress - 250);
                            } else {
                                // L铆nea final
                                x = 250 + (progress - 300);
                                y = 100;
                            }
                        } else {
                            // Rama inferior
                            if (progress < 50) {
                                // L铆nea principal hacia uni贸n
                                x = 50 + progress;
                                y = 100;
                            } else if (progress < 100) {
                                // Bajada hacia rama inferior
                                x = 100;
                                y = 100 + (progress - 50);
                            } else if (progress < 250) {
                                // L铆nea horizontal inferior
                                x = 100 + (progress - 100);
                                y = 150;
                            } else if (progress < 300) {
                                // Subida hacia uni贸n
                                x = 250;
                                y = 150 - (progress - 250);
                            } else {
                                // L铆nea final
                                x = 250 + (progress - 300);
                                y = 100;
                            }
                        }
                        
                        // Color de electrones seg煤n la rama
                        let electronColor = electron.branch === 'top' ? '#00ff88' : '#ff8800';
                        let electronAlpha = 0.9;
                        let electronSize = electron.size;
                        
                        // Efectos especiales en resistores
                        if (progress >= 150 && progress <= 200) {
                            electronAlpha = 0.7;
                        }
                        
                        // Dibujar electr贸n
                        ctx.fillStyle = electronColor;
                        ctx.shadowBlur = 4;
                        ctx.shadowColor = electronColor;
                        
                        ctx.beginPath();
                        ctx.arc(x, y, electron.size, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Signo negativo ocasional
                        if (index % 3 === 0) {
                            ctx.fillStyle = '#000';
                            ctx.font = 'bold 8px Arial';
                            ctx.fillText('-', x - 2, y + 2);
                        }
                    });
                    ctx.shadowBlur = 0;
                    
                    // Etiquetas
                    ctx.fillStyle = '#00ff88';
                    ctx.font = '12px Arial';
                    ctx.fillText(`R1: ${r1}惟`, 145, 30);
                    
                    ctx.fillStyle = '#ff8800';
                    ctx.fillText(`R2: ${r2}惟`, 145, 130);
                    
                    ctx.fillStyle = '#0088ff';
                    ctx.fillText(`${voltage}V`, 15, 140);
                    
                    ctx.fillStyle = '#00ff88';
                    ctx.fillText(`I1: ${i1.toFixed(2)}A`, 260, 50);
                    
                    ctx.fillStyle = '#ff8800';
                    ctx.fillText(`I2: ${i2.toFixed(2)}A`, 260, 150);
                    
                    ctx.fillStyle = '#ffff00';
                    ctx.fillText(`IT: ${(i1 + i2).toFixed(2)}A`, 310, 100);
                    
                    // Informaci贸n adicional
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.fillText('Circuito en Paralelo', 110, 15);
                    ctx.fillText('(Mismo voltaje, corrientes diferentes)', 80, 185);
                    
                    this.parallelAnimationData.animationId = requestAnimationFrame(animateFrame);
                    // Guardar ID de animaci贸n en el estado
                    if (this.analogyStates[index]) {
                        this.analogyStates[index].animationId = this.parallelAnimationData.animationId;
                    }
                };
                
                // Cancelar animaci贸n anterior si existe
                if (this.parallelAnimationData.animationId) {
                    cancelAnimationFrame(this.parallelAnimationData.animationId);
                }
                
                animateFrame();
            }

            drawResistor(ctx, x, y, width, height) {
                ctx.strokeRect(x, y, width, height);
                // L铆neas internas del resistor
                for (let i = 1; i < 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x + (width/4) * i, y);
                    ctx.lineTo(x + (width/4) * i, y + height);
                    ctx.stroke();
                }
            }

            animateCurrentFlow(ctx, current, type) {
                // Esta funci贸n ya no se usa - las animaciones est谩n integradas en drawSeriesCircuit y drawParallelCircuit
                return;
            }

            completeSimulator() {
                if (this.simulatorCompleted) {
                    this.showAchievement('Ya Completado', 'Ya has completado el simulador de circuitos');
                    return;
                }

                this.simulatorCompleted = true;
                this.addProgress('simulador completado');
                
                const simulatorBtn = document.getElementById('completeSimulatorBtn');
                if (simulatorBtn) {
                    simulatorBtn.disabled = true;
                    simulatorBtn.textContent = ' Simulador Completado';
                    simulatorBtn.style.background = '#666';
                }
                
                this.showAchievement('隆Simulador Dominado!', 'Has completado el simulador de circuitos');
                
                // Mostrar calculadora de potencia
                setTimeout(() => {
                    const powerElement = document.getElementById('powerCalculator');
                    if (powerElement) {
                        powerElement.style.display = 'block';
                        this.createPowerCalculator();
                    }
                }, 1000);
            }

            createPowerCalculator() {
                const calculatorHTML = `
                    <div style="background: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 15px;"> Calculadora Avanzada de Potencia</h4>
                        <p style="margin-bottom: 20px;">
                            La potencia el茅ctrica es fundamental para el dise帽o de sistemas. 
                            Usa las tres f贸rmulas principales: <strong>P = V  I</strong>, <strong>P = I虏  R</strong>, <strong>P = V虏 梅 R</strong>
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;">
                        <!-- Calculadora Principal -->
                        <div style="background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-green);">
                            <h4 style="color: var(--primary-green); text-align: center; margin-bottom: 20px;">М Calculadora de Potencia</h4>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-green);">Voltaje (V):</label>
                                <input type="number" id="powerVoltage" placeholder="Ingresa voltaje" 
                                       style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-blue);">Corriente (I):</label>
                                <input type="number" id="powerCurrent" placeholder="Ingresa corriente" 
                                       style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-blue); background: rgba(0, 0, 0, 0.7); color: #fff;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--primary-pink);">Resistencia (R):</label>
                                <input type="number" id="powerResistance" placeholder="Ingresa resistencia" 
                                       style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid var(--primary-pink); background: rgba(0, 0, 0, 0.7); color: #fff;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <button class="btn" onclick="game.calculatePower('vi')" style="font-size: 0.9rem; padding: 8px;">P = VI</button>
                                <button class="btn" onclick="game.calculatePower('ir')" style="font-size: 0.9rem; padding: 8px;">P = I虏R</button>
                                <button class="btn" onclick="game.calculatePower('vr')" style="font-size: 0.9rem; padding: 8px;">P = V虏梅R</button>
                            </div>
                            
                            <div style="background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 8px; min-height: 80px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 10px;">Resultado:</h5>
                                <div id="powerResult">Ingresa valores y selecciona una f贸rmula</div>
                            </div>
                        </div>

                        <!-- Ejemplos Pr谩cticos -->
                        <div style="background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-blue);">
                            <h4 style="color: var(--primary-blue); text-align: center; margin-bottom: 20px;"> Ejemplos Pr谩cticos</h4>
                            
                            <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffa500;">
                                <h5 style="color: #ffa500; margin-bottom: 8px;"> Bombilla LED</h5>
                                <p style="font-size: 0.9rem; margin-bottom: 8px;">Una bombilla LED de 220V consume 0.05A</p>
                                <button class="btn" onclick="game.loadExample(220, 0.05, null)" style="font-size: 0.8rem; padding: 6px 12px;">Cargar Ejemplo</button>
                            </div>
                            
                            <div style="background: rgba(50, 205, 50, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #32cd32;">
                                <h5 style="color: #32cd32; margin-bottom: 8px;"> Calentador</h5>
                                <p style="font-size: 0.9rem; margin-bottom: 8px;">Un calentador de 110V con resistencia de 12惟</p>
                                <button class="btn" onclick="game.loadExample(110, null, 12)" style="font-size: 0.8rem; padding: 6px 12px;">Cargar Ejemplo</button>
                            </div>
                            
                            <div style="background: rgba(138, 43, 226, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #8a2be2;">
                                <h5 style="color: #8a2be2; margin-bottom: 8px;"> Motor Industrial</h5>
                                <p style="font-size: 0.9rem; margin-bottom: 8px;">Un motor que consume 15A a 240V</p>
                                <button class="btn" onclick="game.loadExample(240, 15, null)" style="font-size: 0.8rem; padding: 6px 12px;">Cargar Ejemplo</button>
                            </div>

                            <div style="margin-top: 20px; text-align: center;">
                                <button class="btn" onclick="game.completePowerCalculator()" id="completePowerBtn" 
                                        style="background: var(--primary-pink); color: #fff;">
                                    Dominar Potencia El茅ctrica
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('powerContent').innerHTML = calculatorHTML;
                this.addProgress('calculadora potencia iniciada');
            }

            loadExample(voltage, current, resistance) {
                if (voltage) document.getElementById('powerVoltage').value = voltage;
                if (current) document.getElementById('powerCurrent').value = current;
                if (resistance) document.getElementById('powerResistance').value = resistance;
                
                this.showAchievement('Ejemplo Cargado', 'Ahora puedes calcular la potencia con estos valores');
            }

            calculatePower(formula) {
                const voltage = parseFloat(document.getElementById('powerVoltage').value) || 0;
                const current = parseFloat(document.getElementById('powerCurrent').value) || 0;
                const resistance = parseFloat(document.getElementById('powerResistance').value) || 0;
                
                let result = '';
                let isValid = false;
                const formatNumber = (num) => Number.isInteger(num) ? num.toString() : num.toFixed(2);
                
                switch(formula) {
                    case 'vi':
                        if (voltage && current) {
                            const power = voltage * current;
                            result = `P = V  I = ${voltage}V  ${current}A = ${formatNumber(power)}W`;
                            isValid = true;
                        } else {
                            result = 'Necesitas ingresar Voltaje y Corriente';
                        }
                        break;
                        
                    case 'ir':
                        if (current && resistance) {
                            const power = current * current * resistance;
                            result = `P = I虏  R = (${current}A)虏  ${resistance}惟 = ${formatNumber(power)}W`;
                            isValid = true;
                        } else {
                            result = 'Necesitas ingresar Corriente y Resistencia';
                        }
                        break;
                        
                    case 'vr':
                        if (voltage && resistance) {
                            const power = (voltage * voltage) / resistance;
                            result = `P = V虏 梅 R = (${voltage}V)虏 梅 ${resistance}惟 = ${formatNumber(power)}W`;
                            isValid = true;
                        } else {
                            result = 'Necesitas ingresar Voltaje y Resistencia';
                        }
                        break;
                }
                
                document.getElementById('powerResult').innerHTML = `
                    <div style="color: ${isValid ? 'var(--primary-green)' : 'var(--primary-pink)'}; font-weight: bold; font-size: 1.1rem;">
                        ${result}
                    </div>
                `;
                
                if (isValid && !this.powerCalculatorUsed) {
                    this.powerCalculatorUsed = true;
                    this.addProgress('calculadora potencia usada');
                }
            }

            completePowerCalculator() {
                if (!this.powerCalculatorUsed) {
                    this.showAchievement('Pr谩ctica Requerida', 'Usa la calculadora al menos una vez antes de continuar');
                    return;
                }

                const powerBtn = document.getElementById('completePowerBtn');
                if (powerBtn) {
                    powerBtn.disabled = true;
                    powerBtn.textContent = ' Potencia Dominada';
                    powerBtn.style.background = '#666';
                }
                
                this.addProgress('calculadora potencia completada');
                this.showAchievement('隆Potencia Dominada!', 'Has completado la calculadora de potencia');
                
                // Mostrar desaf铆o final
                setTimeout(() => {
                    const finalElement = document.getElementById('finalChallenge');
                    if (finalElement) {
                        finalElement.style.display = 'block';
                        this.createFinalChallenge();
                    }
                }, 1000);
            }

            createFinalChallenge() {
                const challengeHTML = `
                    <div style="background: linear-gradient(135deg, rgba(255, 0, 136, 0.2), rgba(139, 0, 255, 0.2)); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid var(--primary-pink);">
                        <h4 style="color: var(--primary-pink); margin-bottom: 15px; font-size: 1.3rem;"> DESAFO FINAL: Dise帽o de Sistema El茅ctrico</h4>
                        <p style="margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6;">
                            <strong>Situaci贸n:</strong> Un hospital necesita un sistema de respaldo para sus equipos cr铆ticos. 
                            Como ingeniero el茅ctrico principal, debes dise帽ar un sistema que garantice el suministro seguro y eficiente.
                        </p>
                        
                        <div style="background: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h5 style="color: var(--primary-green); margin-bottom: 10px;"> Especificaciones del Sistema:</h5>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><strong>Equipo 1:</strong> Respirador artificial - 150W, 120V</li>
                                <li><strong>Equipo 2:</strong> Monitor card铆aco - 75W, 120V</li>
                                <li><strong>Equipo 3:</strong> Bomba de infusi贸n - 25W, 120V</li>
                                <li><strong>Iluminaci贸n de emergencia:</strong> 10 focos LED de 12W cada uno, 120V</li>
                                <li><strong>Voltaje del sistema:</strong> 120V DC (corriente continua)</li>
                            </ul>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
                        <!-- C谩lculos Paso a Paso -->
                        <div style="background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-green);">
                            <h4 style="color: var(--primary-green); margin-bottom: 20px;">М C谩lculos del Sistema</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 10px;">Paso 1: Potencia Total</h5>
                                <p style="margin-bottom: 10px;">Calcula la potencia total que debe suministrar el sistema:</p>
                                <input type="number" id="challengeTotalPower" placeholder="Potencia total en W" 
                                       style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff; margin-bottom: 10px;">
                                <button class="btn" onclick="game.checkChallenge('power', 370)" style="font-size: 0.9rem; padding: 6px 15px;">Verificar</button>
                                <div id="challengePowerHint" style="color: #ffa500; font-size: 0.9rem; margin-top: 5px;">
                                     Suma: 150 + 75 + 25 + (10  12) = ?
                                </div>
                                <div id="challengePowerResult" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px;"></div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 10px;">Paso 2: Corriente Total</h5>
                                <p style="margin-bottom: 10px;">Calcula la corriente total del sistema (A):</p>
                                <input type="number" id="totalCurrent" placeholder="Corriente total en A" step="0.01"
                                       style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff; margin-bottom: 10px;">
                                <button class="btn" onclick="game.checkChallenge('current', 3.08)" style="font-size: 0.9rem; padding: 6px 15px;">Verificar</button>
                                <div id="currentHint" style="color: #ffa500; font-size: 0.9rem; margin-top: 5px;">
                                     Usa I = P 梅 V = ? 梅 120V
                                </div>
                                <div id="currentResult" style="display: none; margin-top: 10px;"></div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 10px;">Paso 3: Fusible de Protecci贸n</h5>
                                <p style="margin-bottom: 10px;">Selecciona el fusible adecuado (A) - debe ser 25% mayor que la corriente calculada:</p>
                                <select id="fuseRating" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff; margin-bottom: 10px;">
                                    <option value="">Selecciona un fusible</option>
                                    <option value="3">3A</option>
                                    <option value="4">4A</option>
                                    <option value="5">5A</option>
                                    <option value="6">6A</option>
                                </select>
                                <button class="btn" onclick="game.checkChallenge('fuse', '4')" style="font-size: 0.9rem; padding: 6px 15px;">Verificar</button>
                                <div id="fuseHint" style="color: #ffa500; font-size: 0.9rem; margin-top: 5px;">
                                     Fusible = Corriente  1.25 = ?  1.25
                                </div>
                                <div id="fuseResult" style="display: none; margin-top: 10px;"></div>
                            </div>
                        </div>

                        <!-- Dise帽o del Sistema -->
                        <div style="background: rgba(0, 0, 0, 0.7); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-blue);">
                            <h4 style="color: var(--primary-blue); margin-bottom: 20px;">锔 Dise帽o del Sistema</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 10px;">Paso 4: Calibre del Cable</h5>
                                <p style="margin-bottom: 10px;">Para 4A de corriente continua en un hospital, el calibre recomendado es:</p>
                                <select id="wireGauge" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff; margin-bottom: 10px;">
                                    <option value="">Selecciona el calibre</option>
                                    <option value="18">AWG 18</option>
                                    <option value="16">AWG 16</option>
                                    <option value="14">AWG 14</option>
                                    <option value="12">AWG 12</option>
                                </select>
                                <button class="btn" onclick="game.checkChallenge('wire', '14')" style="font-size: 0.9rem; padding: 6px 15px;">Verificar</button>
                                <div id="wireHint" style="color: #ffa500; font-size: 0.9rem; margin-top: 5px;">
                                     Para aplicaciones cr铆ticas usa cable m谩s grueso del necesario
                                </div>
                                <div id="wireResult" style="display: none; margin-top: 10px;"></div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--primary-green); margin-bottom: 10px;">Paso 5: Eficiencia del Sistema</h5>
                                <p style="margin-bottom: 10px;">Si el sistema tiene 92% de eficiencia, 驴cu谩nta potencia debe generar la fuente?</p>
                                <input type="number" id="sourcePower" placeholder="Potencia de la fuente en W" step="0.1"
                                       style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary-green); background: rgba(0, 0, 0, 0.7); color: #fff; margin-bottom: 10px;">
                                <button class="btn" onclick="game.checkChallenge('source', 402.2)" style="font-size: 0.9rem; padding: 6px 15px;">Verificar</button>
                                <div id="sourceHint" style="color: #ffa500; font-size: 0.9rem; margin-top: 5px;">
                                     Potencia_fuente = Potencia_carga 梅 Eficiencia
                                </div>
                                <div id="sourceResult" style="display: none; margin-top: 10px;"></div>
                            </div>

                            <div style="text-align: center; margin-top: 25px;">
                                <button class="btn" onclick="game.completeSession3()" id="completeSession3Btn" 
                                        style="display: none; background: var(--primary-green); color: #000; font-size: 1.2rem; padding: 15px 30px;">
                                     隆Completar Sesi贸n 3!
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('challengeContent').innerHTML = challengeHTML;
                this.addProgress('desaf铆o final iniciado');
            }

            checkChallenge(type, correctAnswer) {
                let userAnswer, resultDiv, hintDiv;
                let tolerance = 0.1;
                
                switch(type) {
                    case 'power':
                        const powerInput = document.getElementById('challengeTotalPower');
                        userAnswer = powerInput ? parseFloat(powerInput.value) : NaN;
                        resultDiv = document.getElementById('challengePowerResult');
                        hintDiv = document.getElementById('challengePowerHint');
                        tolerance = 1;
                        break;
                    case 'current':
                        userAnswer = parseFloat(document.getElementById('totalCurrent').value);
                        resultDiv = document.getElementById('currentResult');
                        hintDiv = document.getElementById('currentHint');
                        tolerance = 0.05;
                        break;
                    case 'fuse':
                        userAnswer = document.getElementById('fuseRating').value;
                        resultDiv = document.getElementById('fuseResult');
                        hintDiv = document.getElementById('fuseHint');
                        break;
                    case 'wire':
                        userAnswer = document.getElementById('wireGauge').value;
                        resultDiv = document.getElementById('wireResult');
                        hintDiv = document.getElementById('wireHint');
                        break;
                    case 'source':
                        userAnswer = parseFloat(document.getElementById('sourcePower').value);
                        resultDiv = document.getElementById('sourceResult');
                        hintDiv = document.getElementById('sourceHint');
                        tolerance = 1;
                        break;
                }
                
                // Verificar que encontramos los elementos
                if (!resultDiv) {
                    alert('Error: No se encontr贸 el elemento de resultado. Tipo: ' + type);
                    return;
                }
                
                // Verificar que el usuario ingres贸 algo v谩lido
                if (userAnswer === null || userAnswer === undefined || (typeof userAnswer === 'string' && userAnswer === '') || 
                    (typeof userAnswer === 'number' && isNaN(userAnswer))) {
                    resultDiv.innerHTML = `
                        <div style="color: var(--primary-pink); font-weight: bold;">
                            锔 Por favor ingresa una respuesta v谩lida antes de verificar.
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    return;
                }
                
                const isCorrect = (type === 'fuse' || type === 'wire') ? 
                    userAnswer === correctAnswer.toString() : 
                    Math.abs(userAnswer - correctAnswer) <= tolerance;
                
                if (isCorrect) {
                    // Forzar visibilidad completa
                    resultDiv.style.display = 'block';
                    resultDiv.style.visibility = 'visible';
                    resultDiv.style.opacity = '1';
                    resultDiv.style.position = 'relative';
                    resultDiv.style.zIndex = '1000';
                    
                    resultDiv.innerHTML = `
                        <div style="
                            color: var(--primary-green); 
                            font-weight: bold; 
                            background: rgba(0, 255, 136, 0.2); 
                            padding: 20px; 
                            border-radius: 10px; 
                            border: 3px solid var(--primary-green);
                            margin: 15px 0;
                            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
                            text-align: center;
                            font-size: 1.1rem;
                        ">
                             隆CORRECTO! ${type === 'fuse' || type === 'wire' ? userAnswer : correctAnswer}${type === 'power' ? 'W' : type === 'current' ? 'A' : type === 'source' ? 'W' : ''}
                        </div>
                    `;
                    
                    if (hintDiv) hintDiv.style.display = 'none';
                    
                    // Scroll hacia el resultado para asegurar que se vea
                    setTimeout(() => {
                        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                    
                    if (!this.completedActions.has(`challenge_${type}`)) {
                        this.completedActions.add(`challenge_${type}`);
                        this.addProgress(`desaf铆o ${type} completado`);
                    }
                    
                    this.checkFinalChallengeCompletion();
                } else {
                    // Forzar visibilidad completa para incorrectos tambi茅n
                    resultDiv.style.display = 'block';
                    resultDiv.style.visibility = 'visible';
                    resultDiv.style.opacity = '1';
                    resultDiv.style.position = 'relative';
                    resultDiv.style.zIndex = '1000';
                    
                    resultDiv.innerHTML = `
                        <div style="
                            color: var(--primary-pink); 
                            font-weight: bold; 
                            background: rgba(255, 0, 136, 0.2); 
                            padding: 20px; 
                            border-radius: 10px; 
                            border: 3px solid var(--primary-pink);
                            margin: 15px 0;
                            box-shadow: 0 0 20px rgba(255, 0, 136, 0.4);
                            text-align: center;
                            font-size: 1.1rem;
                        ">
                             INCORRECTO<br>
                            Tu respuesta: ${userAnswer} / Correcta: ${correctAnswer}${type === 'power' ? 'W' : ''}
                            ${type === 'power' ? '<br><br> <strong>Tip:</strong> Suma todos los equipos:<br>150 + 75 + 25 + (10  12) = 370W' : ''}
                            ${type === 'current' ? '<br><br> <strong>Tip:</strong> Usa I = P 梅 V con la potencia total' : ''}
                            ${type === 'source' ? '<br><br> <strong>Tip:</strong> Potencia_fuente = Potencia_carga 梅 Eficiencia' : ''}
                        </div>
                    `;
                    
                    // Scroll hacia el resultado
                    setTimeout(() => {
                        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }

            checkFinalChallengeCompletion() {
                const requiredSteps = ['challenge_power', 'challenge_current', 'challenge_fuse', 'challenge_wire', 'challenge_source'];
                const completedSteps = requiredSteps.filter(step => this.completedActions.has(step));
                
                if (completedSteps.length >= 4) { // Al menos 4 de 5 pasos
                    document.getElementById('completeSession3Btn').style.display = 'block';
                    if (!this.finalChallengeCompleted) {
                        this.finalChallengeCompleted = true;
                        this.showAchievement('隆Desaf铆o Final Listo!', 'Has completado suficientes pasos del dise帽o');
                    }
                }
            }

            completeSession3() {
                // Esta funci贸n es para la Sesi贸n 4 (despu茅s del desaf铆o final)
                if (this.sessionsCompleted.has(4)) {
                    this.showAchievement('Sesi贸n Ya Completada', 'Ya has completado la Sesi贸n 4 anteriormente');
                    return;
                }

                this.sessionsCompleted.add(4);

                // Desbloquear sesi贸n 5 (final)
                if (!this.unlockedSessions.includes(5)) {
                    this.unlockedSessions.push(5);
                    const nav5 = document.getElementById('nav5');
                    if (nav5) {
                        nav5.classList.remove('locked');
                    }
                }
                
                this.addProgress('sesi贸n 4 completada');
                this.updateProgress();
                
                const completeBtn = document.getElementById('completeSession3Btn');
                if (completeBtn) {
                    completeBtn.disabled = true;
                    completeBtn.textContent = ' Sesi贸n 4 Completada';
                    completeBtn.style.background = '#666';
                }
                
                this.showAchievement('隆Sesi贸n 4 Completada!', '隆Incre铆ble! Has dominado las aplicaciones pr谩cticas. Sesi贸n Final desbloqueada.');
                
                // Mostrar resumen de finalizaci贸n
                setTimeout(() => {
                    const completionSummaryHTML = `
                        <div style="text-align: center; margin-top: 30px; padding: 25px; background: rgba(0, 0, 0, 0.95); border: 2px solid var(--primary-green); border-radius: 20px; box-shadow: 0 0 40px rgba(0, 255, 136, 0.4);">
                            
                            <!-- Actividades completadas -->
                            <div style="margin-bottom: 25px;">
                                <p style="color: #ccc; font-size: 1rem; margin-bottom: 15px;">
                                    Has completado todos los desaf铆os pr谩cticos de electricidad.
                                </p>
                                <button disabled style="background: #666; color: #fff; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1rem; cursor: not-allowed;">
                                     APLICACIONES PRCTICAS DOMINADAS
                                </button>
                            </div>

                            <!-- Mensaje final -->
                            <div style="background: rgba(255, 165, 0, 0.2); border: 2px solid #ffa500; border-radius: 15px; padding: 25px;">
                                <h2 style="color: #ffa500; margin-bottom: 15px; font-size: 1.4rem;">
                                     隆Misi贸n Completada!
                                </h2>
                                <p style="color: #fff; font-size: 1.1rem; margin-bottom: 20px;">
                                    Has dominado las aplicaciones pr谩cticas de la electricidad y dise帽ado sistemas reales.
                                </p>
                                <button class="ready-btn" onclick="game.showSession(5)" style="font-size: 1.1rem; padding: 18px 40px; background: linear-gradient(135deg, #ffa500, #ff8c00);">
                                    VER CERTIFICACIN FINAL 
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Reemplazar todo el contenido del desaf铆o con el resumen
                    const challengeContent = document.getElementById('challengeContent');
                    if (challengeContent) {
                        challengeContent.innerHTML = completionSummaryHTML;
                    }
                }, 2000);
            }

            animateCurrentAnalogy(ctx, canvas, index) {
                let time = 0;
                let mouseX = 0;
                let mouseY = 0;
                let showTooltip = false;
                let tooltipText = '';
                let currentIntensity = 2.5; // Corriente inicial en Amperios
                
                // Funci贸n para actualizar la corriente desde el control
                this.updateCurrentAnimation = (analogyIndex, newCurrent) => {
                    if (analogyIndex === index) {
                        currentIntensity = parseFloat(newCurrent);
                        
                        // Actualizar display de la corriente
                        const valueDisplay = document.getElementById(`currentValue${index}`);
                        if (valueDisplay) {
                            valueDisplay.textContent = currentIntensity + 'A';
                        }
                        
                        // Actualizar efectos visuales
                        const effectsDisplay = document.getElementById(`currentEffects${index}`);
                        if (effectsDisplay) {
                            let speedText, quantityText, flowText;
                            
                            if (currentIntensity < 1) {
                                speedText = "Muy lenta";
                                quantityText = "Muy pocos";
                                flowText = "Goteo lento";
                            } else if (currentIntensity < 2) {
                                speedText = "Lenta";
                                quantityText = "Pocos";
                                flowText = "Flujo suave";
                            } else if (currentIntensity < 5) {
                                speedText = "Moderada";
                                quantityText = "Moderada";
                                flowText = "Flujo constante";
                            } else if (currentIntensity < 8) {
                                speedText = "R谩pida";
                                quantityText = "Muchos";
                                flowText = "Flujo intenso";
                            } else {
                                speedText = "Muy r谩pida";
                                quantityText = "Much铆simos";
                                flowText = "R铆o caudaloso";
                            }
                            
                            effectsDisplay.innerHTML = `
                                 Velocidad de electrones: ${speedText}<br>
                                 Cantidad de electrones: ${quantityText}<br>
                                 Flujo de agua: ${flowText}
                            `;
                        }
                    }
                };
                
                // Agregar eventos de mouse para tooltips
                const handleMouseMove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    mouseX = e.clientX - rect.left;
                    mouseY = e.clientY - rect.top;
                    
                    showTooltip = false;
                    
                    // Tuber铆a superior (50-550, 30-70)
                    if (mouseX >= 50 && mouseX <= 550 && mouseY >= 30 && mouseY <= 70) {
                        showTooltip = true;
                        const flowRate = Math.round(currentIntensity * 10);
                        tooltipText = `Tuber铆a: ${flowRate} gotas/segundo (${currentIntensity}A equivalente)`;
                    }
                    // Cable inferior (50-550, 130-170)
                    else if (mouseX >= 50 && mouseX <= 550 && mouseY >= 130 && mouseY <= 170) {
                        showTooltip = true;
                        const electronRate = Math.round(currentIntensity * 4);
                        tooltipText = `Cable: ${electronRate} electrones/segundo (${currentIntensity}A)`;
                    }
                };
                
                canvas.addEventListener('mousemove', handleMouseMove);
                
                const animate = () => {
                    // Verificar si la animaci贸n debe continuar
                    const state = this.analogyStates[index];
                    if (!state || !state.isPlaying) {
                        return; // Salir si est谩 pausada
                    }

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    time += 0.02;
                    
                    // Calcular factores basados en la corriente
                    const currentNormalized = currentIntensity / 5; // Normalizar basado en 5A como referencia
                    const speedFactor = Math.max(0.2, currentNormalized); // M铆nimo 20% de velocidad
                    const quantityFactor = Math.max(0.3, currentNormalized); // M铆nimo 30% de cantidad
                    
                    // T铆tulos
                    ctx.fillStyle = '#00ff88';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText('FLUJO DE AGUA (Analog铆a)', 50, 20);
                    ctx.fillText('CORRIENTE ELCTRICA', 350, 20);
                    
                    // === LADO SUPERIOR: ANALOGA DEL AGUA ===
                    
                    // Tuber铆a de agua (grosor variable seg煤n corriente)
                    const pipeThickness = 15 + (quantityFactor * 25); // Grosor variable
                    const pipeY = 50 - (pipeThickness / 2);
                    
                    ctx.strokeStyle = '#4a90e2';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(50, pipeY, 500, pipeThickness);
                    
                    // Fondo de la tuber铆a
                    ctx.fillStyle = 'rgba(74, 144, 226, 0.1)';
                    ctx.fillRect(52, pipeY + 2, 496, pipeThickness - 4);
                    
                    // Flujo de agua (cantidad y velocidad variable)
                    const numDrops = Math.ceil(5 + currentIntensity * 3); // M谩s gotas = m谩s corriente
                    const dropSpeed = 20 + (speedFactor * 60); // Velocidad variable
                    const dropSize = 2 + (quantityFactor * 3); // Tama帽o variable
                    
                    ctx.fillStyle = `rgba(74, 144, 226, ${0.6 + quantityFactor * 0.4})`;
                    
                    for (let i = 0; i < numDrops; i++) {
                        const dropX = 50 + ((time * dropSpeed + i * (500/numDrops)) % 500);
                        const dropY = 50 + Math.sin(time * 2 + i) * 2; // Movimiento ondulante
                        
                        ctx.beginPath();
                        ctx.arc(dropX, dropY, dropSize, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Estela del agua para mayor realismo
                        if (currentIntensity > 3) {
                            ctx.beginPath();
                            ctx.arc(dropX - 15, dropY, dropSize * 0.6, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                    
                    // === LADO INFERIOR: CIRCUITO ELCTRICO ===
                    
                    // Cable el茅ctrico (grosor visual variable)
                    const cableThickness = 8 + (quantityFactor * 12);
                    const cableY = 150 - (cableThickness / 2);
                    
                    // Fondo del cable
                    ctx.fillStyle = '#333';
                    ctx.fillRect(50, cableY, 500, cableThickness);
                    
                    // Conductor interno (brillo controlado)
                    const backgroundAlpha = Math.min(0.2 + quantityFactor * 0.2, 0.4); // M谩ximo 40% de opacidad
                    ctx.fillStyle = `rgba(255, 255, 0, ${backgroundAlpha})`;
                    ctx.fillRect(52, cableY + 2, 496, cableThickness - 4);
                    
                    // Borde del cable
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(50, cableY, 500, cableThickness);
                    
                    // Electrones (cantidad y velocidad variable)
                    const numElectrons = Math.ceil(8 + currentIntensity * 4); // M谩s electrones = m谩s corriente
                    const electronSpeed = 25 + (speedFactor * 50); // Velocidad variable
                    const electronSize = 1.5 + (quantityFactor * 1.5); // Tama帽o m谩s controlado
                    
                    // Color de electrones m谩s visible con alta corriente
                    const electronBrightness = currentIntensity > 5 ? 0.9 : 1.0; // Menos brillante con alta corriente
                    ctx.fillStyle = `rgba(255, 255, 0, ${electronBrightness})`;
                    
                    // Shadow m谩s controlado
                    const shadowIntensity = Math.min(5 + (quantityFactor * 5), 8); // M谩ximo shadow de 8
                    ctx.shadowBlur = shadowIntensity;
                    ctx.shadowColor = currentIntensity > 5 ? 'rgba(255, 255, 0, 0.6)' : '#ffff00';
                    
                    for (let i = 0; i < numElectrons; i++) {
                        const electronX = 50 + ((time * electronSpeed + i * (500/numElectrons)) % 500);
                        const electronY = 150 + Math.sin(time * 3 + i) * 1.5; // Movimiento sutil
                        
                        // Alternar colores para mejor visibilidad con alta corriente
                        if (currentIntensity > 6) {
                            // Con alta corriente, usar colores alternados para mejor visibilidad
                            ctx.fillStyle = i % 2 === 0 ? 'rgba(255, 255, 100, 0.9)' : 'rgba(255, 200, 0, 0.9)';
                        } else {
                            ctx.fillStyle = `rgba(255, 255, 0, ${electronBrightness})`;
                        }
                        
                        ctx.beginPath();
                        ctx.arc(electronX, electronY, electronSize, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Borde oscuro en electrones para mayor contraste con alta corriente
                        if (currentIntensity > 7) {
                            ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                        
                        // Signo negativo en algunos electrones (m谩s visible)
                        if (i % 4 === 0 && currentIntensity > 1) {
                            ctx.fillStyle = currentIntensity > 6 ? '#000' : '#000';
                            ctx.font = 'bold 8px Arial';
                            ctx.fillText('-', electronX - 2, electronY + 2);
                        }
                    }
                    ctx.shadowBlur = 0;
                    
                    // Indicadores de flujo con posiciones fijas y espaciado amplio
                    ctx.fillStyle = '#4a90e2';
                    ctx.font = 'bold 12px Arial';
                    const waterFlow = Math.round(currentIntensity * 10);
                    ctx.fillText(`${waterFlow} gotas/seg`, 410, 75); // Movido m谩s a la derecha
                    
                    ctx.fillStyle = '#ffff00';
                    const electronFlow = Math.round(currentIntensity * 4);
                    ctx.fillText(`${electronFlow} electrones/seg`, 370, 190); // Movido m谩s abajo y a la derecha
                    
                    // Flechas de direcci贸n - separadas m谩s del centro
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    
                    // Flecha superior (agua)
                    ctx.beginPath();
                    ctx.moveTo(180, 25);
                    ctx.lineTo(200, 25);
                    ctx.moveTo(195, 20);
                    ctx.lineTo(200, 25);
                    ctx.lineTo(195, 30);
                    ctx.stroke();
                    
                    // Flecha inferior (electrones)
                    ctx.beginPath();
                    ctx.moveTo(180, 125);
                    ctx.lineTo(200, 125);
                    ctx.moveTo(195, 120);
                    ctx.lineTo(200, 125);
                    ctx.lineTo(195, 130);
                    ctx.stroke();
                    
                    // Comparaci贸n central - simplificada y con mejor espaciado
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    ctx.fillText('M谩s gotas/seg =', 230, 80);
                    ctx.fillText('Mayor flujo', 245, 92);
                    ctx.fillText('尖', 265, 104);
                    ctx.fillText('M谩s electrones/seg =', 210, 120);
                    ctx.fillText('Mayor corriente', 230, 132);
                    
                    // Medidor visual de corriente - posici贸n fija sin solapamiento
                    ctx.strokeStyle = '#00ff88';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(440, 100, 80, 20);
                    ctx.fillStyle = `rgba(0, 255, 136, ${quantityFactor})`;
                    ctx.fillRect(442, 102, (currentIntensity / 10) * 76, 16);
                    
                    ctx.fillStyle = '#00ff88';
                    ctx.font = 'bold 9px Arial';
                    ctx.fillText('MEDIDOR', 455, 95);
                    ctx.fillText(`${currentIntensity}A`, 465, 135);
                    
                    // Etiquetas din谩micas - posiciones fijas sin solapamiento
                    let flowDescription = "";
                    if (currentIntensity < 1) {
                        flowDescription = "Goteo lento";
                    } else if (currentIntensity < 3) {
                        flowDescription = "Flujo suave";
                    } else if (currentIntensity < 6) {
                        flowDescription = "Corriente moderada";
                    } else if (currentIntensity < 8) {
                        flowDescription = "Flujo intenso";
                    } else {
                        flowDescription = "R铆o caudaloso";
                    }
                    
                    ctx.fillStyle = '#4a90e2';
                    ctx.font = 'bold 9px Arial';
                    ctx.fillText(flowDescription, 60, 75); // Posici贸n fija arriba
                    
                    ctx.fillStyle = '#ffff00';
                    const electronDescription = currentIntensity < 2 ? "Pocos electrones" : 
                                               currentIntensity < 5 ? "Flujo moderado" : 
                                               currentIntensity < 8 ? "Muchos electrones" : "Corriente intensa";
                    ctx.fillText(electronDescription, 60, 190); // Posici贸n fija abajo
                    
                    // Mostrar tooltip si est谩 activo
                    if (showTooltip) {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.fillRect(mouseX + 10, mouseY - 30, tooltipText.length * 6, 20);
                        ctx.fillStyle = '#00ff88';
                        ctx.font = '11px Arial';
                        ctx.fillText(tooltipText, mouseX + 15, mouseY - 15);
                    }
                    
                    this.analogyAnimations[index] = requestAnimationFrame(animate);
                    // Guardar ID de animaci贸n en el estado
                    if (this.analogyStates[index]) {
                        this.analogyStates[index].animationId = this.analogyAnimations[index];
                    }
                    // Guardar ID de animaci贸n en el estado
                    if (this.analogyStates[index]) {
                        this.analogyStates[index].animationId = this.analogyAnimations[index];
                    }
                    // Guardar ID de animaci贸n en el estado
                    if (this.analogyStates[index]) {
                        this.analogyStates[index].animationId = this.analogyAnimations[index];
                    }
                };
                
                animate();
            }

            animateVoltageAnalogy(ctx, canvas, index) {
                let time = 0;
                let mouseX = 0;
                let mouseY = 0;
                let showTooltip = false;
                let tooltipText = '';
                let currentVoltage = 12; // Voltaje inicial
                
                // Funci贸n para actualizar el voltaje desde el control
                this.updateVoltageAnimation = (analogyIndex, newVoltage) => {
                    if (analogyIndex === index) {
                        currentVoltage = parseFloat(newVoltage);
                        
                        // Actualizar display del voltaje
                        const valueDisplay = document.getElementById(`voltageValue${index}`);
                        if (valueDisplay) {
                            valueDisplay.textContent = currentVoltage + 'V';
                        }
                        
                        // Actualizar efectos visuales
                        const effectsDisplay = document.getElementById(`voltageEffects${index}`);
                        if (effectsDisplay) {
                            let speedText, brightText, pressureText;
                            
                            if (currentVoltage < 3) {
                                speedText = "Muy lenta";
                                brightText = "Muy tenue";
                                pressureText = "Muy baja";
                            } else if (currentVoltage < 6) {
                                speedText = "Lenta";
                                brightText = "Tenue";
                                pressureText = "Baja";
                            } else if (currentVoltage < 12) {
                                speedText = "Moderada";
                                brightText = "Medio";
                                pressureText = "Media";
                            } else if (currentVoltage < 18) {
                                speedText = "R谩pida";
                                brightText = "Brillante";
                                pressureText = "Alta";
                            } else {
                                speedText = "Muy r谩pida";
                                brightText = "Muy brillante";
                                pressureText = "Muy alta";
                            }
                            
                            effectsDisplay.innerHTML = `
                                 Velocidad de electrones: ${speedText}<br>
                                 Brillo de bombilla: ${brightText}<br>
                                 Presi贸n del agua: ${pressureText}
                            `;
                        }
                    }
                };
                
                // Agregar eventos de mouse para tooltips
                const handleMouseMove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    mouseX = e.clientX - rect.left;
                    mouseY = e.clientY - rect.top;
                    
                    // Detectar 谩rea del mouse y mostrar tooltip correspondiente
                    showTooltip = false;
                    
                    // Torre de agua (60-100, 50-120)
                    if (mouseX >= 60 && mouseX <= 100 && mouseY >= 50 && mouseY <= 120) {
                        showTooltip = true;
                        tooltipText = `Torre: Presi贸n ${currentVoltage > 12 ? 'muy alta' : currentVoltage > 6 ? 'alta' : 'baja'}`;
                    }
                    // Casa (180-210, 120-145)
                    else if (mouseX >= 180 && mouseX <= 210 && mouseY >= 120 && mouseY <= 145) {
                        showTooltip = true;
                        tooltipText = 'Casa: Recibe agua con presi贸n variable';
                    }
                    // Tuber铆a (80-180, 135-145)
                    else if (mouseX >= 80 && mouseX <= 180 && mouseY >= 135 && mouseY <= 145) {
                        showTooltip = true;
                        tooltipText = `Tuber铆a: Flujo ${currentVoltage > 12 ? 'intenso' : currentVoltage > 6 ? 'moderado' : 'd茅bil'}`;
                    }
                    // Actualizar 谩rea de detecci贸n de la bater铆a para tooltips
                    // Bater铆a (375-405, 65-115)
                    else if (mouseX >= 375 && mouseX <= 405 && mouseY >= 65 && mouseY <= 115) {
                        showTooltip = true;
                        tooltipText = `Bater铆a ${currentVoltage}V: ${currentVoltage > 12 ? 'Alto' : currentVoltage > 6 ? 'Medio' : 'Bajo'} voltaje`;
                    }
                    // Bombilla (465-495, 70-100)
                    else if (mouseX >= 465 && mouseX <= 495 && mouseY >= 70 && mouseY <= 100) {
                        showTooltip = true;
                        tooltipText = `Bombilla: Brillo ${currentVoltage > 12 ? 'intenso' : currentVoltage > 6 ? 'medio' : 'tenue'}`;
                    }
                    // Cables - ajustar 谩rea de detecci贸n
                    else if (mouseX >= 375 && mouseX <= 495 && ((mouseY >= 45 && mouseY <= 55) || (mouseY >= 125 && mouseY <= 135))) {
                        showTooltip = true;
                        tooltipText = `Cable: Electrones a velocidad ${currentVoltage > 12 ? 'alta' : currentVoltage > 6 ? 'media' : 'baja'}`;
                    }
                };
                
                canvas.addEventListener('mousemove', handleMouseMove);
                
                const animate = () => {
                    // Verificar si la animaci贸n debe continuar
                    const state = this.analogyStates[index];
                    if (!state || !state.isPlaying) {
                        return; // Salir si est谩 pausada
                    }

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    time += 0.02;
                    
                    // Calcular factores basados en el voltaje
                    const voltageNormalized = currentVoltage / 12; // Normalizar basado en 12V
                    const speedFactor = Math.max(0.2, voltageNormalized); // M铆nimo 20% de velocidad
                    const brightnessFactor = Math.max(0.1, voltageNormalized); // M铆nimo 10% de brillo
                    const waterLevel = Math.max(0.3, voltageNormalized); // M铆nimo 30% de nivel
                    
                    // T铆tulos con mejor espaciado
                    ctx.fillStyle = '#00ff88';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText('PRESIN DE AGUA', 80, 25);
                    ctx.fillText('VOLTAJE ELCTRICO', 380, 25);
                    
                    // === LADO IZQUIERDO: ANALOGA DEL AGUA (din谩mico) ===
                    
                    // Torre de agua (altura variable seg煤n voltaje, pero controlada)
                    ctx.strokeStyle = '#4a90e2';
                    ctx.lineWidth = 3;
                    
                    // Base de la torre
                    ctx.fillStyle = '#666';
                    ctx.fillRect(75, 120, 10, 30);
                    
                    // Tanque elevado (altura variable pero limitada)
                    const maxTankHeight = 60; // Altura m谩xima del tanque
                    const minTankHeight = 35; // Altura m铆nima del tanque
                    const tankHeight = minTankHeight + (voltageNormalized * (maxTankHeight - minTankHeight));
                    const tankY = 120 - tankHeight; // Posici贸n Y del tanque
                    
                    ctx.strokeStyle = '#4a90e2';
                    ctx.strokeRect(60, tankY, 40, tankHeight);
                    
                    // Agua en el tanque (siempre dentro de los l铆mites)
                    const waterLevelPercentage = Math.max(0.7, Math.min(0.95, 0.7 + (voltageNormalized * 0.2))); // Entre 70% y 95%
                    const waterHeight = tankHeight * waterLevelPercentage;
                    const waterY = tankY + (tankHeight - waterHeight) + Math.sin(time) * 1; // Peque帽a oscilaci贸n
                    
                    // Asegurar que el agua nunca se salga del tanque
                    const finalWaterY = Math.max(tankY + 2, Math.min(waterY, tankY + tankHeight - 5));
                    const finalWaterHeight = Math.min(waterHeight, (tankY + tankHeight - 3) - finalWaterY);
                    
                    ctx.fillStyle = `rgba(74, 144, 226, ${0.5 + brightnessFactor * 0.3})`;
                    ctx.fillRect(62, finalWaterY, 36, finalWaterHeight);
                    
                    // Tuber铆a principal
                    ctx.strokeStyle = '#4a90e2';
                    ctx.lineWidth = 4 + (voltageNormalized * 2); // Grosor variable
                    ctx.beginPath();
                    ctx.moveTo(80, 120);
                    ctx.lineTo(80, 140);
                    ctx.lineTo(180, 140);
                    ctx.stroke();
                    
                    // Casa
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 3;
                    ctx.fillStyle = '#D2B48C';
                    ctx.fillRect(180, 120, 30, 25);
                    ctx.strokeRect(180, 120, 30, 25);
                    
                    // Techo
                    ctx.fillStyle = '#8B0000';
                    ctx.beginPath();
                    ctx.moveTo(175, 120);
                    ctx.lineTo(195, 105);
                    ctx.lineTo(215, 120);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // Ventana y puerta
                    ctx.fillStyle = '#87CEEB';
                    ctx.fillRect(185, 125, 8, 8);
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(200, 130, 6, 15);
                    
                    // Flujo de agua (velocidad variable)
                    const numDrops = Math.ceil(3 + voltageNormalized * 5); // N煤mero variable de gotas
                    const dropSpeed = 30 + (speedFactor * 40); // Velocidad variable
                    ctx.fillStyle = `rgba(74, 144, 226, ${0.7 + brightnessFactor * 0.3})`;
                    
                    for (let i = 0; i < numDrops; i++) {
                        const dropX = 80 + ((time * dropSpeed + i * (100/numDrops)) % 100);
                        if (dropX <= 180) {
                            const dropSize = 2 + (voltageNormalized * 2);
                            ctx.beginPath();
                            ctx.arc(dropX, 140, dropSize, 0, Math.PI * 2);
                            ctx.fill();
                            // Estela del agua
                            ctx.beginPath();
                            ctx.arc(dropX - 8, 140, dropSize * 0.5, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                    
                    // === LADO DERECHO: CIRCUITO ELCTRICO (din谩mico) ===
                    
                    // Bater铆a centrada verticalmente y m谩s peque帽a
                    ctx.strokeStyle = '#00ff88';
                    ctx.lineWidth = 3;
                    
                    // Terminal positivo arriba (color variable)
                    const batteryAlpha = 0.5 + brightnessFactor * 0.5;
                    ctx.fillStyle = `rgba(0, 255, 136, ${batteryAlpha})`;
                    ctx.fillRect(375, 65, 30, 20);
                    ctx.strokeRect(375, 65, 30, 20);
                    
                    // Terminal negativo abajo
                    ctx.fillStyle = '#666';
                    ctx.fillRect(375, 95, 30, 20);
                    ctx.strokeRect(375, 95, 30, 20);
                    
                    // S铆mbolos
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 18px Arial';
                    ctx.fillText('+', 387, 80);
                    ctx.fillStyle = '#fff';
                    ctx.fillText('-', 388, 110);
                    
                    // Voltaje indicado (din谩mico)
                    ctx.fillStyle = '#00ff88';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(currentVoltage + 'V', 355, 130);
                    
                    // Cables (brillo variable) - usando colores iguales al simulador de corriente
                    ctx.shadowBlur = brightnessFactor * 10;
                    ctx.shadowColor = '#ffff00';
                    ctx.strokeStyle = `rgba(255, 255, 0, ${0.6 + brightnessFactor * 0.4})`;
                    ctx.lineWidth = 3 + (voltageNormalized * 2);
                    ctx.beginPath();
                    // Desde terminal positivo hacia arriba y luego a la bombilla
                    ctx.moveTo(390, 65);
                    ctx.lineTo(390, 50);
                    ctx.lineTo(480, 50);
                    ctx.lineTo(480, 67); // Conectar a bombilla
                    // Desde bombilla hacia abajo y retorno
                    ctx.moveTo(480, 103);
                    ctx.lineTo(480, 130);
                    ctx.lineTo(390, 130);
                    ctx.lineTo(390, 115); // Conectar a terminal negativo
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    
                    // Bombilla (brillo variable)
                    ctx.strokeStyle = '#ff6600';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(480, 85, 18, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // Base de la bombilla
                    ctx.strokeRect(472, 95, 16, 8);
                    
                    // Filamento (brillo seg煤n voltaje) - usando colores iguales al simulador de corriente
                    const filamentBrightness = brightnessFactor;
                    ctx.strokeStyle = `rgba(255, 255, 0, ${filamentBrightness})`;
                    ctx.lineWidth = 2;
                    ctx.shadowBlur = filamentBrightness * 15;
                    ctx.shadowColor = '#ffff00';
                    
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.moveTo(474 + i * 4, 78);
                        ctx.lineTo(474 + i * 4, 92);
                        ctx.stroke();
                    }
                    ctx.shadowBlur = 0;
                    
                    // Electrones (velocidad y cantidad variable) - rutas corregidas
                    const numElectrons = Math.ceil(4 + voltageNormalized * 6);
                    const electronSpeed = 40 + (speedFactor * 40);
                    
                    // Colores iguales al simulador de corriente
                    const electronBrightness = currentVoltage > 5 ? 0.9 : 1.0; // Menos brillante con alto voltaje
                    ctx.fillStyle = `rgba(255, 255, 0, ${electronBrightness})`;
                    
                    // Shadow m谩s controlado como en corriente
                    const shadowIntensity = Math.min(5 + (voltageNormalized * 5), 8); // M谩ximo shadow de 8
                    ctx.shadowBlur = shadowIntensity;
                    ctx.shadowColor = currentVoltage > 5 ? 'rgba(255, 255, 0, 0.6)' : '#ffff00';
                    
                    for (let i = 0; i < numElectrons; i++) {
                        let electronX, electronY;
                        const totalPath = 180; // Longitud total del recorrido
                        const progress = (time * electronSpeed + i * (totalPath/numElectrons)) % totalPath;
                        
                        if (progress < 15) {
                            // Desde terminal positivo hacia arriba
                            electronX = 390;
                            electronY = 65 - progress;
                        } else if (progress < 105) {
                            // L铆nea horizontal superior hacia la bombilla
                            electronX = 390 + (progress - 15);
                            electronY = 50;
                        } else if (progress < 122) {
                            // Bajada hacia la bombilla (lado derecho)
                            electronX = 480;
                            electronY = 50 + (progress - 105);
                        } else if (progress < 139) {
                            // Bajada desde bombilla hacia l铆nea inferior
                            electronX = 480;
                            electronY = 103 + (progress - 122);
                        } else if (progress < 229) {
                            // L铆nea horizontal inferior de retorno (m谩s corta)
                            const returnProgress = progress - 139;
                            electronX = 480 - returnProgress;
                            electronY = 130;
                        } else {
                            // Subida hacia terminal negativo
                            electronX = 390;
                            electronY = 130 - (progress - 229);
                        }
                        
                        // Tama帽o como en el simulador de corriente
                        const electronSize = 1.5 + (voltageNormalized * 1.5);
                        
                        // Con alto voltaje, usar colores alternados para mejor visibilidad como en corriente
                        if (currentVoltage > 6) {
                            // Con alto voltaje, usar colores alternados para mejor visibilidad
                            ctx.fillStyle = i % 2 === 0 ? 'rgba(255, 255, 100, 0.9)' : 'rgba(255, 200, 0, 0.9)';
                        } else {
                            ctx.fillStyle = `rgba(255, 255, 0, ${electronBrightness})`;
                        }
                        
                        ctx.beginPath();
                        ctx.arc(electronX, electronY, electronSize, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Borde oscuro en electrones para mayor contraste con alto voltaje como en corriente
                        if (currentVoltage > 7) {
                            ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                        
                        // Signo negativo en algunos electrones (m谩s visible) como en corriente
                        if (i % 4 === 0 && currentVoltage > 1) {
                            ctx.fillStyle = currentVoltage > 6 ? '#000' : '#000';
                            ctx.font = 'bold 8px Arial';
                            ctx.fillText('-', electronX - 2, electronY + 2);
                        }
                    }
                    ctx.shadowBlur = 0;
                    
                    // Etiquetas din谩micas - ajustadas para nueva posici贸n
                    ctx.fillStyle = '#00ff88';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(`${currentVoltage > 12 ? 'ALTO' : currentVoltage > 6 ? 'MEDIO' : 'BAJO'} VOLTAJE`, 350, 40);
                    
                    ctx.fillStyle = '#ffff00';
                    const currentIntensity = currentVoltage > 12 ? 'intensa' : currentVoltage > 6 ? 'media' : 'baja';
                    ctx.fillText(`Corriente ${currentIntensity} `, 330, 145);
                    
                    ctx.fillStyle = '#4a90e2';
                    const pressureLevel = currentVoltage > 12 ? 'ALTA' : currentVoltage > 6 ? 'MEDIA' : 'BAJA';
                    ctx.fillText(`${pressureLevel} PRESIN`, 70, 175);
                    const flowLevel = currentVoltage > 12 ? 'fuerte' : currentVoltage > 6 ? 'medio' : 'd茅bil';
                    ctx.fillText(`Flujo ${flowLevel} `, 110, 160);
                    
                    // Comparaci贸n central
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 11px Arial';
                    ctx.fillText('Mayor altura =', 250, 60);
                    ctx.fillText('Mayor presi贸n', 250, 75);
                    ctx.fillText('', 285, 85);
                    ctx.fillText('', 285, 95);
                    ctx.fillText('Mayor voltaje =', 250, 105);
                    ctx.fillText('Mayor "empuje"', 250, 120);
                    
                    // Mostrar tooltip si est谩 activo
                    if (showTooltip) {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.fillRect(mouseX + 10, mouseY - 30, tooltipText.length * 7, 20);
                        ctx.fillStyle = '#00ff88';
                        ctx.font = '12px Arial';
                        ctx.fillText(tooltipText, mouseX + 15, mouseY - 15);
                    }
                    
                    this.analogyAnimations[index] = requestAnimationFrame(animate);
                };
                
                animate();
            }

            animateResistanceAnalogy(ctx, canvas, index) {
                let particles = [];
                let time = 0;
                let currentResistance = 50; // Resistencia inicial en Ohmios
                let appliedVoltage = 12; // Voltaje inicial
                let mouseX = 0;
                let mouseY = 0;
                let showTooltip = false;
                let tooltipText = '';
                let heatLevel = 0; // Nivel de calor del resistor
                
                // Crear part铆culas m谩s din谩micas
                for (let i = 0; i < 15; i++) {
                    particles.push({
                        x: 50 + i * 30,
                        baseSpeed: 1.5,
                        waterY: 57,
                        electronY: 150,
                        id: i,
                        inQueue: false,
                        queueTime: 0
                    });
                }
                
                // Funci贸n para actualizar resistencia desde el control
                this.updateResistanceAnimation = (analogyIndex, newResistance) => {
                    if (analogyIndex === index) {
                        currentResistance = parseFloat(newResistance);
                        heatLevel = (currentResistance / 100) * 0.7; // Calor basado en resistencia
                        
                        // Actualizar display
                        const valueDisplay = document.getElementById(`resistanceValue${index}`);
                        if (valueDisplay) {
                            valueDisplay.textContent = currentResistance + '惟';
                        }
                        
                        // Actualizar efectos calculados
                        const current = appliedVoltage / currentResistance;
                        const power = appliedVoltage * current;
                        
                        const effectsDisplay = document.getElementById(`resistanceEffects${index}`);
                        if (effectsDisplay) {
                            let flowText, heatText, difficultyText;
                            
                            if (currentResistance < 20) {
                                flowText = "Flujo muy f谩cil";
                                heatText = "Sin calentamiento";
                                difficultyText = "Muy baja oposici贸n";
                            } else if (currentResistance < 50) {
                                flowText = "Flujo moderado";
                                heatText = "Poco calor";
                                difficultyText = "Oposici贸n baja";
                            } else if (currentResistance < 80) {
                                flowText = "Flujo dif铆cil";
                                heatText = "Calentamiento notable";
                                difficultyText = "Oposici贸n alta";
                            } else {
                                flowText = "Flujo muy dif铆cil";
                                heatText = "Mucho calor";
                                difficultyText = "Oposici贸n muy alta";
                            }
                            
                            effectsDisplay.innerHTML = `
                                 ${difficultyText}<br>
                                 Corriente: ${current.toFixed(2)}A<br>
                                 Potencia: ${power.toFixed(1)}W<br>
                                 ${heatText}
                            `;
                        }
                    }
                };
                
                // Funci贸n para actualizar voltaje
                this.updateVoltageResistance = (analogyIndex, newVoltage) => {
                    if (analogyIndex === index) {
                        appliedVoltage = parseFloat(newVoltage);
                        
                        const voltageDisplay = document.getElementById(`voltageResistanceValue${index}`);
                        if (voltageDisplay) {
                            voltageDisplay.textContent = newVoltage + 'V';
                        }
                        
                        // Recalcular efectos
                        this.updateResistanceAnimation(index, currentResistance);
                    }
                };
                
                // Eventos de mouse para tooltips interactivos
                const handleMouseMove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    mouseX = e.clientX - rect.left;
                    mouseY = e.clientY - rect.top;
                    
                    showTooltip = false;
                    
                    // Detectar 谩reas y mostrar info espec铆fica
                    if (mouseX >= 50 && mouseX <= 200 && mouseY >= 40 && mouseY <= 75) {
                        showTooltip = true;
                        const current = appliedVoltage / currentResistance;
                        tooltipText = `Entrada: ${current.toFixed(2)}A - Flujo libre`;
                    } else if (mouseX >= 200 && mouseX <= 350 && mouseY >= 50 && mouseY <= 65) {
                        showTooltip = true;
                        const power = Math.pow(appliedVoltage / currentResistance, 2) * currentResistance;
                        tooltipText = `Resistor: ${currentResistance}惟 - Genera ${power.toFixed(1)}W de calor`;
                    } else if (mouseX >= 350 && mouseX <= 500 && mouseY >= 40 && mouseY <= 75) {
                        showTooltip = true;
                        tooltipText = `Salida: Flujo reducido por resistencia`;
                    } else if (mouseX >= 200 && mouseX <= 350 && mouseY >= 135 && mouseY <= 165) {
                        showTooltip = true;
                        tooltipText = `Resistor el茅ctrico: Convierte energ铆a en calor`;
                    }
                };
                
                canvas.addEventListener('mousemove', handleMouseMove);
                
                const animate = () => {
                    // Verificar si la animaci贸n debe continuar
                    const state = this.analogyStates[index];
                    if (!state || !state.isPlaying) {
                        return; // Salir si est谩 pausada
                    }

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    time += 0.02;
                    
                    // Calcular factores din谩micos
                    const resistanceFactor = currentResistance / 100; // 0-1
                    const voltageFactor = appliedVoltage / 24; // 0-1
                    const currentFlow = appliedVoltage / currentResistance;
                    const speedMultiplier = Math.max(0.1, 1 - resistanceFactor * 0.8);
                    
                    // Fondo con gradiente din谩mico
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                    gradient.addColorStop(0, 'rgba(0, 0, 0, 0.8)');
                    gradient.addColorStop(0.5, `rgba(255, ${Math.floor(100 - resistanceFactor * 100)}, 0, ${resistanceFactor * 0.3})`);
                    gradient.addColorStop(1, 'rgba(0, 0, 0, 0.8)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, 100);
                    
                    // L铆nea divisoria con brillo
                    ctx.strokeStyle = `rgba(0, 255, 136, ${0.3 + voltageFactor * 0.4})`;
                    ctx.lineWidth = 2;
                    ctx.shadowBlur = 5;
                    ctx.shadowColor = '#00ff88';
                    ctx.beginPath();
                    ctx.moveTo(0, 100);
                    ctx.lineTo(canvas.width, 100);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    
                    // T铆tulos din谩micos
                    ctx.fillStyle = '#4a90e2';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText(`ANALOGA: PRESIN ${appliedVoltage}V`, 20, 20);
                    
                    ctx.fillStyle = '#00ff88';
                    ctx.fillText(`CIRCUITO: RESISTENCIA ${currentResistance}惟`, 20, 120);
                    
                    // === TUBERA DE AGUA (SUPERIOR) ===
                    
                    // Tuber铆a con efectos de presi贸n
                    ctx.strokeStyle = '#4a90e2';
                    ctx.lineWidth = 3 + voltageFactor;
                    
                    // Secci贸n inicial (presi贸n alta)
                    const initialPressure = voltageFactor * 5;
                    ctx.shadowBlur = initialPressure;
                    ctx.shadowColor = '#4a90e2';
                    ctx.strokeRect(50, 40, 150, 35);
                    
                    // Secci贸n estrecha (resistencia) con efectos de calor
                    const restrictionHeight = 15 + resistanceFactor * 10;
                    const restrictionY = 57 - restrictionHeight / 2;
                    ctx.shadowColor = `rgba(255, ${Math.floor(255 - resistanceFactor * 155)}, 0, ${resistanceFactor})`;
                    ctx.shadowBlur = resistanceFactor * 8;
                    ctx.strokeStyle = `rgba(255, ${Math.floor(255 - resistanceFactor * 155)}, 0, 1)`;
                    ctx.strokeRect(200, restrictionY, 150, restrictionHeight);
                    
                    // Secci贸n final (presi贸n reducida)
                    ctx.shadowBlur = Math.max(1, initialPressure - resistanceFactor * 3);
                    ctx.shadowColor = '#4a90e2';
                    ctx.strokeStyle = '#4a90e2';
                    ctx.strokeRect(350, 40, 150, 35);
                    ctx.shadowBlur = 0;
                    
                    // === CABLE ELCTRICO (INFERIOR) ===
                    
                    // Cable inicial
                    ctx.strokeStyle = '#00ff88';
                    ctx.lineWidth = 4 + voltageFactor;
                    ctx.shadowBlur = voltageFactor * 3;
                    ctx.shadowColor = '#00ff88';
                    ctx.beginPath();
                    ctx.moveTo(50, 150);
                    ctx.lineTo(200, 150);
                    ctx.stroke();
                    
                    // Resistor con efectos de calor y brillo
                    ctx.shadowBlur = resistanceFactor * 10;
                    ctx.shadowColor = `rgba(255, ${Math.floor(100 + resistanceFactor * 155)}, 0, 0.8)`;
                    ctx.strokeStyle = `rgba(255, ${Math.floor(200 - resistanceFactor * 100)}, 0, 1)`;
                    ctx.lineWidth = 3 + resistanceFactor;
                    
                    // Zigzag m谩s dram谩tico
                    ctx.beginPath();
                    ctx.moveTo(200, 150);
                    for (let i = 0; i < 6; i++) {
                        const zigzagHeight = 12 + resistanceFactor * 8;
                        ctx.lineTo(210 + i * 25, 150 + (i % 2 === 0 ? -zigzagHeight : zigzagHeight));
                    }
                    ctx.lineTo(350, 150);
                    ctx.stroke();
                    
                    // Cable final
                    ctx.shadowBlur = Math.max(1, voltageFactor * 3 - resistanceFactor * 2);
                    ctx.shadowColor = '#00ff88';
                    ctx.strokeStyle = '#00ff88';
                    ctx.lineWidth = 4 + voltageFactor - resistanceFactor;
                    ctx.beginPath();
                    ctx.moveTo(350, 150);
                    ctx.lineTo(500, 150);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    
                    // === PARTCULAS DINMICAS ===
                    
                    // Part铆culas de agua con acumulaci贸n
                    let queueCount = 0;
                    particles.forEach(particle => {
                        // Calcular velocidad din谩mica
                        let currentSpeed = particle.baseSpeed * speedMultiplier * voltageFactor;
                        let size = 3 + voltageFactor;
                        let alpha = 0.8 + voltageFactor * 0.2;
                        
                        // Efecto de cola en la restricci贸n
                        if (particle.x >= 180 && particle.x <= 220 && !particle.inQueue) {
                            particle.inQueue = true;
                            particle.queueTime = resistanceFactor * 60;
                            queueCount++;
                        }
                        
                        if (particle.inQueue && particle.queueTime > 0) {
                            particle.queueTime--;
                            currentSpeed = 0.1;
                            size = 2;
                            alpha = 0.9;
                        } else {
                            particle.inQueue = false;
                        }
                        
                        // En la restricci贸n
                        if (particle.x > 200 && particle.x < 350) {
                            currentSpeed *= 0.3;
                            size = 1.5;
                        }
                        
                        // Dibujar part铆cula de agua
                        ctx.fillStyle = `rgba(74, 144, 226, ${alpha})`;
                        ctx.shadowBlur = 3;
                        ctx.shadowColor = '#4a90e2';
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.waterY, size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        
                        particle.x += currentSpeed;
                        if (particle.x > 520) {
                            particle.x = 30;
                            particle.inQueue = false;
                            particle.queueTime = 0;
                        }
                    });
                    
                    // Electrones con efectos similares
                    particles.forEach((particle, i) => {
                        if (i < 10) {
                            let electronSpeed = particle.baseSpeed * speedMultiplier * voltageFactor;
                            let electronSize = 2 + voltageFactor * 0.5;
                            let electronAlpha = 0.9;
                            
                            // Efectos en el resistor
                            if (particle.x > 200 && particle.x < 350) {
                                electronSpeed *= 0.2;
                                electronSize = 1.5;
                                electronAlpha = 0.7;
                            }
                            
                            ctx.fillStyle = `rgba(255, 255, 0, ${electronAlpha})`;
                            ctx.shadowBlur = 4 + voltageFactor * 2;
                            ctx.shadowColor = '#ffff00';
                            ctx.beginPath();
                            ctx.arc(particle.x, particle.electronY, electronSize, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.shadowBlur = 0;
                            
                            // Signo negativo
                            if (electronSize > 2) {
                                ctx.fillStyle = '#000';
                                ctx.font = 'bold 8px Arial';
                                ctx.fillText('-', particle.x - 2, particle.electronY + 2);
                            }
                        }
                    });
                    
                    // === INFORMACIN DINMICA ===
                    
                    // Medidores virtuales
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 11px Arial';
                    
                    // Corriente calculada
                    const current = appliedVoltage / currentResistance;
                    ctx.fillText(`I = ${current.toFixed(2)}A`, 420, 45);
                    
                    // Potencia disipada
                    const power = Math.pow(current, 2) * currentResistance;
                    ctx.fillStyle = resistanceFactor > 0.5 ? '#ff6600' : '#fff';
                    ctx.fillText(`P = ${power.toFixed(1)}W`, 420, 60);
                    
                    // Indicadores de estado
                    ctx.fillStyle = '#4a90e2';
                    ctx.font = 'bold 10px Arial';
                    ctx.fillText(`Flujo: ${speedMultiplier > 0.7 ? 'F谩cil' : speedMultiplier > 0.4 ? 'Moderado' : 'Dif铆cil'}`, 60, 90);
                    
                    ctx.fillStyle = '#ffff00';
                    ctx.fillText(`Corriente: ${current.toFixed(2)}A`, 60, 185);
                    
                    // Temperatura del resistor
                    if (resistanceFactor > 0.3) {
                        ctx.fillStyle = `rgba(255, ${Math.floor(255 - resistanceFactor * 200)}, 0, 1)`;
                        ctx.fillText(`★ ${Math.floor(20 + power * 5)}掳C`, 270, 185);
                    }
                    
                    // Cola de espera visual
                    if (queueCount > 3) {
                        ctx.fillStyle = '#ff6600';
                        ctx.font = 'bold 9px Arial';
                        ctx.fillText(`锔 Congesti贸n: ${queueCount} part铆culas`, 170, 90);
                    }
                    
                    // Tooltip interactivo
                    if (showTooltip) {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                        const tooltipWidth = tooltipText.length * 7;
                        ctx.fillRect(mouseX + 10, mouseY - 35, tooltipWidth, 25);
                        ctx.strokeStyle = '#00ff88';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(mouseX + 10, mouseY - 35, tooltipWidth, 25);
                        
                        ctx.fillStyle = '#00ff88';
                        ctx.font = '11px Arial';
                        ctx.fillText(tooltipText, mouseX + 15, mouseY - 20);
                    }
                    
                    this.analogyAnimations[index] = requestAnimationFrame(animate);
                };
                
                animate();
            }

            showAchievement(title, description) {
                const achievement = document.getElementById('achievement');
                const titleEl = document.getElementById('achievementTitle');
                const descEl = document.getElementById('achievementDesc');
                
                if (titleEl && descEl) {
                    titleEl.textContent = title;
                    descEl.textContent = description;
                    
                    achievement.classList.add('show');
                    
                    setTimeout(() => {
                        achievement.classList.remove('show');
                    }, 4000);
                }
            }

            updateProgress() {
                // Solo actualizar la barra de progreso superior
                this.progress = (this.unlockedSessions.length / 4) * 100;
                this.updateProgressBar();
                this.log(`Progreso actualizado: ${this.progress}%`);
            }

            updateProgressBar() {
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = this.progress + '%';
                }
            }

            addProgress(action = '') {
                // Simplemente actualizar el progreso
                this.updateProgress();
                this.log(`Progreso actualizado por: ${action}`);
            }

            saveProgress() {
                // DESHABILITADO - No guardar progreso para que siempre inicie desde cero
                // El progreso solo existe durante la sesi贸n actual
                // Guardado silencioso deshabilitado
            }

            loadProgress() {
                // DESHABILITADO - No cargar progreso para que siempre inicie desde cero
                // Carga silenciosa deshabilitada
            }

            clearAllProgress() {
                // Limpiar localStorage al iniciar para asegurar inicio desde cero
                try {
                    localStorage.removeItem('ohmVengersProgress');
                    localStorage.clear();
                    // Log eliminado para experiencia limpia
                } catch (error) {
                    // Error handling silencioso
                }
            }

            // Funciones del men煤 m贸vil
            toggleMobileMenu() {
                const overlay = document.getElementById('mobileNavOverlay');
                if (overlay) {
                    const isActive = overlay.classList.contains('active');
                    
                    if (isActive) {
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    } else {
                        overlay.classList.add('active');
                        document.body.style.overflow = 'hidden';
                        this.updateMobileNavigation();
                    }
                }
            }

            selectMobileSession(sessionNum) {
                // Cerrar men煤 m贸vil
                this.toggleMobileMenu();
                
                // Cambiar a la sesi贸n seleccionada
                this.showSession(sessionNum);
            }

            updateMobileNavigation() {
                // Actualizar estado de navegaci贸n m贸vil
                const sessions = [
                    { id: 1, title: 'Sesi贸n 1', subtitle: 'Conceptos B谩sicos' },
                    { id: 2, title: 'Sesi贸n 2', subtitle: 'Ley de Ohm' },
                    { id: 3, title: 'Sesi贸n 3', subtitle: 'Conceptos Avanzados' },
                    { id: 4, title: 'Sesi贸n 4', subtitle: 'Aplicaciones Pr谩cticas' },
                    { id: 5, title: 'Misi贸n Final', subtitle: 'Certificaci贸n' }
                ];

                sessions.forEach(session => {
                    const mobileNavItem = document.getElementById(`mobileNav${session.id}`);
                    const regularNavItem = document.getElementById(`nav${session.id}`);
                    
                    if (mobileNavItem && regularNavItem) {
                        // Copiar estados de navegaci贸n regular a m贸vil
                        if (regularNavItem.classList.contains('active')) {
                            mobileNavItem.classList.add('active');
                        } else {
                            mobileNavItem.classList.remove('active');
                        }
                        
                        if (regularNavItem.classList.contains('locked')) {
                            mobileNavItem.classList.add('locked');
                            const statusElement = mobileNavItem.querySelector('.mobile-nav-status');
                            if (statusElement) statusElement.textContent = '';
                        } else {
                            mobileNavItem.classList.remove('locked');
                            const statusElement = mobileNavItem.querySelector('.mobile-nav-status');
                            if (statusElement) {
                                statusElement.textContent = this.sessionsCompleted.has(session.id) ? '' : '猸';
                            }
                        }
                    }
                });

                // Actualizar progreso m贸vil
                const mobileProgressPercent = document.getElementById('mobileProgressPercent');
                const mobileProgressBar = document.getElementById('mobileProgressBar');
                
                if (mobileProgressPercent && mobileProgressBar) {
                    mobileProgressPercent.textContent = Math.round(this.progress) + '%';
                    mobileProgressBar.style.width = this.progress + '%';
                }
            }

            // Funci贸n helper para logs condicionales (DESHABILITADA)
            log(...args) {
                // Logs completamente deshabilitados para experiencia limpia
                // Solo se activan si debugMode es true Y se llama manualmente
                if (this.debugMode && window.enableOhmVengersLogs) {
                    console.log('[Ohm-Vengers]', ...args);
                }
            }

            // Funciones del men煤 m贸vil
            toggleMobileMenu() {
                const overlay = document.getElementById('mobileNavOverlay');
                if (overlay) {
                    const isActive = overlay.classList.contains('active');
                    
                    if (isActive) {
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    } else {
                        overlay.classList.add('active');
                        document.body.style.overflow = 'hidden';
                        this.updateMobileNavigation();
                    }
                }
            }

            selectMobileSession(sessionNum) {
                // Cerrar men煤 m贸vil
                this.toggleMobileMenu();
                
                // Cambiar a la sesi贸n seleccionada
                this.showSession(sessionNum);
            }

            updateMobileNavigation() {
                // Actualizar estado de navegaci贸n m贸vil
                const sessions = [
                    { id: 1, title: 'Sesi贸n 1', subtitle: 'Conceptos B谩sicos' },
                    { id: 2, title: 'Sesi贸n 2', subtitle: 'Ley de Ohm' },
                    { id: 3, title: 'Sesi贸n 3', subtitle: 'Conceptos Avanzados' },
                    { id: 4, title: 'Sesi贸n 4', subtitle: 'Aplicaciones Pr谩cticas' },
                    { id: 5, title: 'Misi贸n Final', subtitle: 'Certificaci贸n' }
                ];

                sessions.forEach(session => {
                    const mobileNavItem = document.getElementById(`mobileNav${session.id}`);
                    const regularNavItem = document.getElementById(`nav${session.id}`);
                    
                    if (mobileNavItem && regularNavItem) {
                        // Copiar estados de navegaci贸n regular a m贸vil
                        if (regularNavItem.classList.contains('active')) {
                            mobileNavItem.classList.add('active');
                        } else {
                            mobileNavItem.classList.remove('active');
                        }
                        
                        if (regularNavItem.classList.contains('locked')) {
                            mobileNavItem.classList.add('locked');
                            const statusElement = mobileNavItem.querySelector('.mobile-nav-status');
                            if (statusElement) statusElement.textContent = '';
                        } else {
                            mobileNavItem.classList.remove('locked');
                            const statusElement = mobileNavItem.querySelector('.mobile-nav-status');
                            if (statusElement) {
                                statusElement.textContent = this.sessionsCompleted.has(session.id) ? '' : '猸';
                            }
                        }
                    }
                });

                // Actualizar progreso m贸vil
                const mobileProgressPercent = document.getElementById('mobileProgressPercent');
                const mobileProgressBar = document.getElementById('mobileProgressBar');
                
                if (mobileProgressPercent && mobileProgressBar) {
                    mobileProgressPercent.textContent = Math.round(this.progress) + '%';
                    mobileProgressBar.style.width = this.progress + '%';
                }
            }

            updateCurrentSessionIndicator(sessionNum) {
                const currentSessionName = document.getElementById('currentSessionName');
                if (currentSessionName) {
                    const sessionNames = {
                        1: 'Sesi贸n 1',
                        2: 'Sesi贸n 2', 
                        3: 'Sesi贸n 3',
                        4: 'Sesi贸n 4',
                        5: 'Misi贸n Final'
                    };
                    currentSessionName.textContent = sessionNames[sessionNum] || 'Sesi贸n 1';
                }

                // Actualizar dots de progreso
                const dots = document.querySelectorAll('.progress-dots .dot');
                dots.forEach((dot, index) => {
                    const dotSession = index + 1;
                    dot.classList.remove('active', 'completed');
                    
                    if (dotSession === sessionNum) {
                        dot.classList.add('active');
                    } else if (this.sessionsCompleted.has(dotSession)) {
                        dot.classList.add('completed');
                    }
                });
            }

            // ===== FUNCIONES DE ADMINISTRACIN =====
            
            toggleAdminPanel() {
                const panel = document.getElementById('adminPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }

            recalculateScore() {
                this.log('Iniciando rec谩lculo de puntuaci贸n...');
                
                // Recalcular puntuaci贸n basada en progreso real
                let newScore = 0;
                
                // Puntos por conceptos iniciados
                if (this.completedActions.has('conceptsStarted')) {
                    newScore += 15;
                    this.log('Conceptos iniciados: +15');
                }
                
                // Puntos por analog铆as vistas (10 cada una)
                const analogyPoints = this.analogiesViewed.size * 10;
                newScore += analogyPoints;
                this.log(`Analog铆as vistas (${this.analogiesViewed.size}): +${analogyPoints}`);
                
                // Puntos por quiz completado
                if (this.completedActions.has('quizCompleted')) {
                    newScore += 50;
                    this.log('Quiz completado: +50');
                }
                
                // Puntos por sesi贸n 1 completada
                if (this.sessionsCompleted.has(1)) {
                    newScore += 50;
                    this.log('Sesi贸n 1 completada: +50');
                }
                
                // Puntos por iniciar Ley de Ohm
                if (this.completedActions.has('ohmLawStarted')) {
                    newScore += 10;
                    this.log('Ley de Ohm iniciada: +10');
                }
                
                // Puntos por ejercicios completados (15 cada uno)
                const exercisePoints = this.exercisesCompleted.size * 15;
                newScore += exercisePoints;
                this.log(`Ejercicios completados (${this.exercisesCompleted.size}): +${exercisePoints}`);
                
                // Puntos por sesi贸n 2 completada
                if (this.sessionsCompleted.has(2)) {
                    newScore += 75;
                    this.log('Sesi贸n 2 completada: +75');
                }
                
                // === PUNTOS DE LA SESIN 3 ===
                
                // Puntos por iniciar problemas del mundo real
                if (this.completedActions.has('realWorldStarted')) {
                    newScore += 10;
                    this.log('Problemas del mundo real iniciados: +10');
                }
                
                // Puntos por problemas del mundo real resueltos (20 cada uno)
                const realWorldPoints = this.realWorldSolved.size * 20;
                newScore += realWorldPoints;
                this.log(`Problemas del mundo real resueltos (${this.realWorldSolved.size}): +${realWorldPoints}`);
                
                // Puntos por completar simulador
                if (this.simulatorCompleted) {
                    newScore += 40; // 15 por crear + 25 por completar
                    this.log('Simulador completado: +40');
                }
                
                // Puntos por usar calculadora de potencia
                if (this.powerCalculatorUsed) {
                    newScore += 45; // 10 por crear + 15 por usar + 20 por completar
                    this.log('Calculadora de potencia usada: +45');
                }
                
                // Puntos por desaf铆o final
                const challengeSteps = ['challenge_power', 'challenge_current', 'challenge_fuse', 'challenge_wire', 'challenge_source'];
                const completedChallengeSteps = challengeSteps.filter(step => this.completedActions.has(step));
                const challengePoints = completedChallengeSteps.length * 15 + 10; // 10 por iniciar + 15 por cada paso
                newScore += challengePoints;
                this.log(`Pasos del desaf铆o final completados (${completedChallengeSteps.length}): +${challengePoints}`);
                
                // Puntos por sesi贸n 3 completada
                if (this.sessionsCompleted.has(3)) {
                    newScore += 100;
                    this.log('Sesi贸n 3 completada: +100');
                }
                
                const oldScore = this.score;
                this.score = newScore;
                
                this.log(`Puntuaci贸n recalculada: ${oldScore}  ${newScore}`);
                
                this.updateScoreDisplay();
                this.saveProgress();
                
                this.showAchievement('Puntuaci贸n Recalculada', 
                    `Puntuaci贸n anterior: ${oldScore}  Nueva: ${newScore}`);
                
                this.toggleAdminPanel();
            }

            resetProgress() {
                const confirmed = confirm('驴Est谩s seguro de que quieres resetear el progreso a 0%? (Las acciones completadas se mantendr谩n)');
                
                if (confirmed) {
                    this.progress = 0;
                    this.updateProgressDisplay();
                    this.saveProgress();
                    
                    this.showAchievement('Progreso Reseteado', 'El progreso se ha establecido en 0%');
                    this.toggleAdminPanel();
                }
            }

            fullReset() {
                const confirmed = confirm('锔 CUIDADO: Esto borrar谩 TODO el progreso incluyendo sesiones desbloqueadas, analog铆as vistas, etc. 驴Continuar?');
                
                if (confirmed) {
                    const doubleConfirm = confirm('驴Est谩s COMPLETAMENTE seguro? Esta acci贸n no se puede deshacer.');
                    
                    if (doubleConfirm) {
                        // Resetear todo
                        this.progress = 0;
                        this.currentSession = 1;
                        this.unlockedSessions = [1];
                        this.completedActions = new Set();
                        this.sessionsCompleted = new Set();
                        this.analogiesViewed = new Set();
                        this.exercisesCompleted = new Set();
                        this.realWorldSolved = new Set();
                        this.simulatorCompleted = false;
                        this.powerCalculatorUsed = false;
                        this.finalChallengeCompleted = false;
                        this.debugMode = false;
                        
                        // Limpiar localStorage
                        localStorage.removeItem('ohmVengersProgress');
                        
                        this.showAchievement('Reset Completo', 'Todo el progreso ha sido borrado. Recargando p谩gina...');
                        
                        // Recargar p谩gina despu茅s de 2 segundos
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                }
            }

            setManualScore() {
                const manualScore = parseInt(document.getElementById('manualScore').value);
                
                if (isNaN(manualScore) || manualScore < 0) {
                    alert('Por favor ingresa un n煤mero v谩lido mayor o igual a 0');
                    return;
                }
                
                const confirmed = confirm(`驴Establecer la puntuaci贸n manualmente en ${manualScore} puntos?`);
                
                if (confirmed) {
                    this.score = manualScore;
                    this.updateScoreDisplay();
                    this.saveProgress();
                    
                    this.showAchievement('Puntuaci贸n Establecida', 
                        `Puntuaci贸n establecida manualmente en ${manualScore} puntos`);
                    
                    document.getElementById('manualScore').value = '';
                    this.toggleAdminPanel();
                }
            }

            updateScoreDisplay() {
                const scoreElement = document.getElementById('scoreValue');
                if (scoreElement) {
                    scoreElement.textContent = this.score;
                    
                    // Animaci贸n de actualizaci贸n
                    scoreElement.style.transform = 'scale(1.3)';
                    scoreElement.style.color = 'var(--primary-green)';
                    setTimeout(() => {
                        scoreElement.style.transform = 'scale(1)';
                        scoreElement.style.color = '#fff';
                    }, 500);
                }
            }

            // Funci贸n global para actualizar animaciones de corriente
            updateCurrentAnimation(index, current) {
                if (game && game.updateCurrentAnimation) {
                    game.updateCurrentAnimation(index, current);
                }
            }
            
            // Funci贸n global para actualizar animaciones de voltaje
            updateVoltageAnimation(index, voltage) {
                if (game && game.updateVoltageAnimation) {
                    game.updateVoltageAnimation(index, voltage);
                }
            }
            
            // Comandos disponibles desde la consola del navegador:
            // game.debugInfo() - Muestra informaci贸n del estado actual
            // game.addScore(puntos) - A帽ade puntos espec铆ficos
            // game.setScore(puntos) - Establece puntuaci贸n espec铆fica
            
            debugInfo() {
                if (this.debugMode) {
                    console.log('=== DEBUG INFO - OHM VENGERS ===');
                    console.log('Progreso:', this.progress + '%');
                    console.log('Sesi贸n actual:', this.currentSession);
                    console.log('Sesiones desbloqueadas:', this.unlockedSessions);
                    console.log('Sesiones completadas:', Array.from(this.sessionsCompleted));
                    console.log('Analog铆as vistas:', Array.from(this.analogiesViewed));
                    console.log('Ejercicios completados:', Array.from(this.exercisesCompleted));
                    console.log('Problemas mundo real resueltos:', Array.from(this.realWorldSolved));
                    console.log('Simulador completado:', this.simulatorCompleted);
                    console.log('Calculadora potencia usada:', this.powerCalculatorUsed);
                    console.log('Desaf铆o final completado:', this.finalChallengeCompleted);
                    console.log('Acciones completadas:', Array.from(this.completedActions));
                    console.log('Modo Debug:', this.debugMode);
                    console.log('================================');
                } else {
                    // Mostrar info en una alerta para producci贸n
                    const info = `
=== INFORMACIN DEL JUEGO ===
Progreso: ${this.progress}%
Sesi贸n actual: ${this.currentSession}
Sesiones desbloqueadas: ${this.unlockedSessions.join(', ')}
Sesiones completadas: ${Array.from(this.sessionsCompleted).join(', ')}
Analog铆as vistas: ${this.analogiesViewed.size}/${this.concepts.length}
Ejercicios completados: ${this.exercisesCompleted.size}
Problemas mundo real: ${this.realWorldSolved.size}/5
Simulador: ${this.simulatorCompleted ? 'Completado' : 'Pendiente'}
Calculadora potencia: ${this.powerCalculatorUsed ? 'Usada' : 'Pendiente'}
Modo Debug: ${this.debugMode ? 'Activado' : 'Desactivado'}
                    `;
                    alert(info);
                }
            }

            setScore(newScore) {
                if (typeof newScore !== 'number' || newScore < 0) {
                    this.log('Error: La puntuaci贸n debe ser un n煤mero mayor o igual a 0');
                    this.showAchievement('Error', 'La puntuaci贸n debe ser un n煤mero mayor o igual a 0');
                    return;
                }
                
                this.log(`Cambiando puntuaci贸n de ${this.score} a ${newScore}`);
                this.score = newScore;
                this.updateScoreDisplay();
                this.saveProgress();
                this.showAchievement('Puntuaci贸n Actualizada', `Nueva puntuaci贸n: ${newScore}`);
            }

            toggleDebugMode() {
                this.debugMode = !this.debugMode;
                this.saveProgress();
                
                const status = this.debugMode ? 'activado' : 'desactivado';
                this.showAchievement('Modo Debug', `Modo debug ${status}`);
                
                // Actualizar texto del bot贸n
                const debugBtn = document.getElementById('debugModeBtn');
                if (debugBtn) {
                    debugBtn.textContent = this.debugMode ? ' Debug: ON' : ' Debug: OFF';
                    debugBtn.style.background = this.debugMode ? 'var(--primary-green)' : '#666';
                    debugBtn.style.color = this.debugMode ? '#000' : '#fff';
                }
                
                this.toggleAdminPanel();
            }
        }

        // Instancia global del juego
        let game;

        // Funciones globales para compatibilidad
        function showInstructions() {
            const intro = document.getElementById('intro');
            const instructions = document.getElementById('instructions');
            
            if (intro && instructions) {
                intro.style.opacity = '0';
                setTimeout(() => {
                    intro.style.display = 'none';
                    instructions.style.display = 'flex';
                    instructions.style.opacity = '0';
                    setTimeout(() => {
                        instructions.style.opacity = '1';
                    }, 100);
                }, 500);
            }
        }

        function checkReadyAndStart() {
            // Ya no necesitamos verificar checkboxes, solo iniciar directamente
            startMission();
        }

        function startMission() {
            const instructions = document.getElementById('instructions');
            const mainSystem = document.getElementById('mainSystem');
            
            if (instructions && mainSystem) {
                instructions.style.opacity = '0';
                setTimeout(() => {
                    instructions.style.display = 'none';
                    mainSystem.style.display = 'block';
                    
                    // Inicializar el juego
                    game = new OhmVengersGame();
                    game.updateProgress();
                    game.showAchievement('Misi贸n Iniciada', 'Has comenzado tu entrenamiento como Ohm-Venger');
                }, 1000);
            }
        }

        function showSession(sessionNum) {
            if (game) {
                game.showSession(sessionNum);
            }
        }

        function startConcepts() {
            if (game) {
                game.startConcepts();
            }
        }

        // ===== FUNCIONES DE REINICIO ELIMINADAS =====
        // La p谩gina ahora siempre inicia desde cero autom谩ticamente

        // Inicializaci贸n cuando se carga la p谩gina
        document.addEventListener('DOMContentLoaded', () => {
            // Sistema inicializado silenciosamente
        });
    </script>
</body>
</html>
